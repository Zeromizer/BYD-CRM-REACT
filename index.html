<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BYD MotorEast CRM</title>

    <!-- External CSS -->
    <link rel="stylesheet" href="src/styles/main.css">
</head>
<body>
    <!-- React Version Banner -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <span style="font-size: 16px; font-weight: 500;">ðŸš€ Try our new React version!</span>
        <a href="https://zeromizer.github.io/BYD-CRM-REACT/" target="_blank" style="color: white; text-decoration: underline; margin-left: 10px; font-weight: 600;">Click here to preview</a>
        <span style="font-size: 13px; opacity: 0.9; margin-left: 15px;">(Your data is shared between both versions)</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>BYD MotorEast CRM <span id="syncStatus" style="font-size: 14px; font-weight: normal; margin-left: 10px;"></span></h1>
            <div class="header-actions">
                <button class="google-drive-btn" id="authButton" onclick="handleAuthClick()" disabled title="Google Drive Connection">
                    <span class="status-dot"></span>
                    <span id="authButtonText">Google Drive</span>
                </button>
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" onclick="toggleHeaderDropdown()" title="More Options">
                        â‹®
                    </button>
                    <div class="dropdown-menu" id="headerDropdownMenu">
                        <a class="dropdown-item" onclick="openStatisticsModal()">View Statistics</a>
                        <a class="dropdown-item" onclick="openFormsModal()">Manage Forms</a>
                        <a class="dropdown-item" onclick="openExcelModal()">Manage Excel</a>
                        <a class="dropdown-item" onclick="forceSyncFromDrive()">Force Sync</a>
                        <a class="dropdown-item" onclick="exportData()">Export Data</a>
                        <a class="dropdown-item" onclick="importData()">Import Data</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <div class="customer-list-header">
                    <h2>Customer List</h2>
                    <button class="btn btn-primary" onclick="openAddCustomerModal()">+ Add Customer</button>
                </div>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search customers..." onkeyup="searchCustomers()">
                </div>
                <div class="customer-list" id="customerList">
                    <div class="empty-state">
                        <p>No customers yet</p>
                        <p style="font-size: 14px; margin-top: 10px;">Click "Add Customer" to get started</p>
                    </div>
                </div>
            </div>

            <div class="card" id="customerDetails">
                <div class="empty-state">
                    <p>Select a customer to view details</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div class="modal" id="addCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Customer</h2>
                <span class="close-modal" onclick="closeAddCustomerModal()">&times;</span>
            </div>
            <form onsubmit="addCustomer(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="newCustomerName" required>
                    </div>
                    <div class="form-group">
                        <label>Contact Number *</label>
                        <input type="tel" id="newCustomerPhone" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="newCustomerEmail">
                    </div>
                    <div class="form-group">
                        <label>NRIC/FIN</label>
                        <input type="text" id="newCustomerNRIC" placeholder="S1234567A or F1234567N">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Occupation</label>
                        <input type="text" id="newCustomerOccupation" placeholder="e.g., Engineer, Teacher">
                    </div>
                    <div class="form-group">
                        <label>Date of Birth</label>
                        <input type="date" id="newCustomerDOB">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Sales Consultant</label>
                        <input type="text" id="newCustomerSalesConsultant">
                    </div>
                    <div class="form-group">
                        <label>VSA No</label>
                        <input type="text" id="newCustomerVsaNo" placeholder="VSA Number">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" id="newCustomerAddress" placeholder="e.g., 99 YISHUN AVE 1, 13-39">
                    </div>
                    <div class="form-group">
                        <label>Address Continue</label>
                        <input type="text" id="newCustomerAddressContinue" placeholder="e.g., SINGAPORE 769139">
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="newCustomerNotes" rows="3"></textarea>
                </div>
                <div id="addCustomerProgress" style="display: none; margin: 15px 0; padding: 10px; background: #e8f5e9; border-radius: 5px;">
                    <p style="margin: 0; color: #27ae60; font-size: 14px;">
                        <span id="addCustomerProgressText">Creating customer...</span>
                    </p>
                    <div style="width: 100%; height: 4px; background: #c8e6c9; border-radius: 2px; margin-top: 8px; overflow: hidden;">
                        <div id="addCustomerProgressBar" style="width: 0%; height: 100%; background: #27ae60; transition: width 0.3s;"></div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button type="submit" id="addCustomerSubmitBtn" class="btn btn-primary">Add Customer</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddCustomerModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div class="modal" id="statisticsModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Statistics</h2>
                <span class="close-modal" onclick="closeStatisticsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Customers</h3>
                        <p id="modalTotalCustomers">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Active Deals</h3>
                        <p id="modalActiveDeals">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Files in Drive</h3>
                        <p id="modalTotalFiles">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Folders Created</h3>
                        <p id="modalTotalFolders">0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Instructions Modal -->
    <div class="modal" id="setupModal" style="display: none;">
        <!-- Modal hidden since Client ID is pre-configured -->
    </div>

    <!-- Forms Management Modal -->
    <div class="modal" id="formsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Forms Management</h2>
                <span class="close-modal" onclick="closeFormsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="formsModalContent">
                    <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, rgba(0, 188, 212, 0.1) 0%, rgba(0, 151, 167, 0.1) 100%); border-radius: 10px; border: 2px solid rgba(0, 188, 212, 0.3);">
                        <h3 style="color: #00bcd4; margin-bottom: 10px;">About Form Templates</h3>
                        <p style="color: #2c3e50; font-size: 14px; margin-bottom: 8px;">
                            Upload your form templates here (PDF or image format). Once uploaded, you can easily view and print them from customer profiles.
                        </p>
                        <p style="color: #7f8c8d; font-size: 13px;">
                            Forms are stored in Google Drive and will be accessible across all sessions.
                        </p>
                    </div>

                    <div id="formsNotConnected" style="display: none;">
                        <div class="auth-section">
                            <h3>Not Connected to Google Drive</h3>
                            <p>Connect to Google Drive to manage form templates.</p>
                            <button class="btn btn-drive" onclick="handleAuthClick()">
                                Connect Google Drive
                            </button>
                        </div>
                    </div>

                    <div id="formsConnected" style="display: none;">
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #1a1a2e; margin-bottom: 15px;">Upload New Form</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">Form Type:</label>
                                <select id="formTypeSelect" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;">
                                    <option value="test_drive">Test Drive Agreement Form</option>
                                    <option value="vsa">Vehicle Sales Agreement</option>
                                    <option value="pdpa">PDPA Consent Form</option>
                                    <option value="coe_bidding_1">COE Bidding 1</option>
                                    <option value="coe_bidding_2">COE Bidding 2</option>
                                    <option value="pdpa_consent_1">PDPA Consent 1</option>
                                    <option value="pdpa_consent_2">PDPA Consent 2</option>
                                    <option value="delivery_checklist_1">Delivery Checklist Form (1 of 2)</option>
                                    <option value="delivery_checklist_2">Delivery Checklist Form (2 of 2)</option>
                                    <option value="other">Other Form</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">Select PDF or Image File:</label>
                                <input type="file" id="formFileInput" accept=".pdf,image/*" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;">
                            </div>
                            <button class="btn btn-success" onclick="uploadFormTemplate()">Upload Form</button>
                        </div>

                        <div style="border-top: 2px solid #ecf0f1; padding-top: 20px;">
                            <h3 style="color: #1a1a2e; margin-bottom: 15px;">Uploaded Forms</h3>
                            <div id="formsListContainer">
                                <div class="loading-forms" style="text-align: center; padding: 20px; color: #7f8c8d;">
                                    Loading forms...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Field Mapping Modal -->
    <div class="modal" id="fieldMappingModal" style="display: none;">
        <div class="modal-content" style="max-width: 95%; height: 95vh;">
            <div class="modal-header">
                <h2>Configure Form Fields</h2>
                <span class="close-modal" onclick="closeFieldMappingModal()">&times;</span>
            </div>
            <div class="modal-body" style="overflow: auto; height: calc(95vh - 120px);">
                <div style="background: rgba(255, 193, 7, 0.1); border: 2px solid rgba(255, 193, 7, 0.5); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #f39c12; margin-bottom: 10px;">How to Map Fields</h4>
                    <ol style="color: #2c3e50; font-size: 14px; margin-left: 20px;">
                        <li>Click on the form image where you want to place a field</li>
                        <li>Select which customer data to display at that position</li>
                        <li>Adjust font size if needed</li>
                        <li>Repeat for all fields you want to auto-fill</li>
                        <li>Click "Save Configuration" when done</li>
                    </ol>
                </div>

                <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div>
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 5px; display: block;">Field to Place:</label>
                        <select id="fieldTypeSelect" onchange="toggleCustomValueInput()" style="padding: 8px; border: 2px solid #00bcd4; border-radius: 6px; font-size: 14px;">
                            <option value="custom">Custom Value (Enter below)</option>
                            <option value="name">Customer Name</option>
                            <option value="phone">Phone Number</option>
                            <option value="email">Email</option>
                            <option value="nric">NRIC/FIN</option>
                            <option value="occupation">Occupation</option>
                            <option value="dob">Date of Birth</option>
                            <option value="address">Address</option>
                            <option value="addressContinue">Address Continue</option>
                            <option value="fullAddress">Full Address (Combined)</option>
                            <option value="salesConsultant">Sales Consultant</option>
                            <option value="vsaNo">VSA No</option>
                            <option value="date">Today's Date</option>
                            <optgroup label="VSA - New Car Details">
                                <option value="vsa_makeModel">Make & Model</option>
                                <option value="vsa_yom">YOM (Year of Manufacture)</option>
                                <option value="vsa_bodyColour">Body Colour</option>
                                <option value="vsa_upholstery">Upholstery</option>
                                <option value="vsa_przType">P/R/Z Type</option>
                            </optgroup>
                            <optgroup label="VSA - New Car Package">
                                <option value="vsa_package">Package</option>
                                <option value="vsa_sellingWithCOE">Selling with COE</option>
                                <option value="vsa_sellingPriceList">Selling Price on Price List</option>
                                <option value="vsa_purchasePriceWithCOE">Purchase Price with COE</option>
                                <option value="vsa_coeRebateLevel">COE Rebate Level</option>
                                <option value="vsa_coeRebate">COE Rebate</option>
                                <option value="vsa_deposit">Deposit</option>
                                <option value="vsa_lessOthers">Less: Others</option>
                                <option value="vsa_addOthers">Add: Others</option>
                                <option value="vsa_deliveryDate">Approximate Delivery Date</option>
                            </optgroup>
                            <optgroup label="VSA - Trade in Car">
                                <option value="vsa_tradeInCarNo">Trade in Car No</option>
                                <option value="vsa_tradeInCarModel">Trade in Car Model</option>
                                <option value="vsa_tradeInAmount">Trade In Amount</option>
                            </optgroup>
                            <optgroup label="VSA - Delivery Details">
                                <option value="vsa_dateOfRegistration">Date of Registration</option>
                                <option value="vsa_registrationNo">Registration No</option>
                                <option value="vsa_chassisNo">Chassis No</option>
                                <option value="vsa_engineNo">Engine No</option>
                            </optgroup>
                            <optgroup label="VSA - Remarks">
                                <option value="vsa_remarks1">Remarks 1</option>
                                <option value="vsa_remarks2">Remarks 2</option>
                                <option value="vsa_loanAmount">Loan Amount</option>
                                <option value="vsa_interest">Interest</option>
                                <option value="vsa_tenure">Tenure</option>
                                <option value="vsa_monthlyPayment">Monthly Payment</option>
                                <option value="vsa_financeCompany">Finance Company</option>
                                <option value="vsa_adminFee">Admin Fee</option>
                                <option value="vsa_insuranceSubsidy">Insurance Subsidy</option>
                            </optgroup>
                            <optgroup label="VSA - Insurance">
                                <option value="vsa_insuranceCompany">Insurance Company</option>
                                <option value="vsa_insuranceFee">Insurance Fee</option>
                                <option value="vsa_insuranceNet">Insurance Net (Fee - Subsidy)</option>
                            </optgroup>
                        </select>
                    </div>
                    <div id="customValueInputContainer" style="display: block;">
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 5px; display: block;">Custom Value:</label>
                        <input type="text" id="customValueInput" placeholder="Enter text or number" style="padding: 8px; border: 2px solid #00bcd4; border-radius: 6px; font-size: 14px; width: 200px;">
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 5px; display: block;">Font Size (px):</label>
                        <input type="number" id="fieldFontSize" value="16" min="8" max="48" style="padding: 8px; border: 2px solid #00bcd4; border-radius: 6px; font-size: 14px; width: 100px;">
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 5px; display: block;">Text Color:</label>
                        <input type="color" id="fieldTextColor" value="#000000" style="padding: 4px; border: 2px solid #00bcd4; border-radius: 6px; height: 38px; width: 80px;">
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 5px; display: block;">&nbsp;</label>
                        <button class="btn btn-secondary" onclick="clearAllFieldMappings()" style="background: #e74c3c;">Clear All Fields</button>
                    </div>
                </div>

                <div id="formImageContainer" style="position: relative; display: inline-block; border: 3px solid #00bcd4; border-radius: 8px; overflow: hidden; background: white; cursor: crosshair;">
                    <canvas id="formMappingCanvas"></canvas>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: rgba(39, 174, 96, 0.1); border: 2px solid rgba(39, 174, 96, 0.3); border-radius: 8px;">
                    <h4 style="color: #27ae60; margin-bottom: 10px;">Mapped Fields</h4>
                    <div id="mappedFieldsList" style="color: #2c3e50; font-size: 14px;"></div>
                </div>
            </div>
            <div style="padding: 15px; border-top: 2px solid #ecf0f1; background: #f8f9fa; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeFieldMappingModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveFieldMappings()">Save Configuration</button>
            </div>
        </div>
    </div>

    <!-- Combine & Print Forms Modal -->
    <div class="modal" id="combinePrintModal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Combine Forms for Double-Sided Printing</h2>
                <span class="close-modal" onclick="closeCombinePrintModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(0, 188, 212, 0.1); border: 2px solid rgba(0, 188, 212, 0.3); border-radius: 8px;">
                    <h4 style="color: #00bcd4; margin-bottom: 10px;">How it works</h4>
                    <p style="color: #2c3e50; font-size: 14px; margin-bottom: 8px;">
                        Select 2 forms to combine them into a single document perfect for double-sided printing. For example: PDPA on front, COE Bidding on back.
                    </p>
                    <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 8px;">
                        Each form will be on a separate page with proper page breaks for duplex printing.
                    </p>
                    <p style="color: #27ae60; font-size: 13px; font-weight: 600;">
                        Customer data will be automatically filled in based on your field mappings!
                    </p>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 600;">Side 1 (Front):</label>
                    <select id="combineSide1" style="width: 100%; padding: 10px; border: 2px solid #00bcd4; border-radius: 6px; font-size: 14px;">
                        <option value="">Select a form...</option>
                    </select>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 600;">Side 2 (Back):</label>
                    <select id="combineSide2" style="width: 100%; padding: 10px; border: 2px solid #00bcd4; border-radius: 6px; font-size: 14px;">
                        <option value="">Select a form...</option>
                    </select>
                </div>

                <div style="padding: 12px; background: rgba(255, 152, 0, 0.1); border: 2px solid rgba(255, 152, 0, 0.3); border-radius: 6px; margin-bottom: 20px;">
                    <p style="color: #f57c00; font-size: 13px; margin: 0;">
                        <strong>Note:</strong> Currently supports image forms only. PDF forms will be supported in a future update.
                    </p>
                </div>
            </div>
            <div style="padding: 15px; border-top: 2px solid #ecf0f1; background: #f8f9fa; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeCombinePrintModal()">Cancel</button>
                <button class="btn btn-success" onclick="combinePrintForms()">Preview & Print</button>
            </div>
        </div>
    </div>

    <!-- Excel Templates Management Modal -->
    <div class="modal" id="excelModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Excel Templates Management</h2>
                <span class="close-modal" onclick="closeExcelModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="excelModalContent">
                    <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(56, 142, 60, 0.1) 100%); border-radius: 10px; border: 2px solid rgba(76, 175, 80, 0.3);">
                        <h3 style="color: #4caf50; margin-bottom: 10px;">About Excel Templates</h3>
                        <p style="color: #2c3e50; font-size: 14px; margin-bottom: 8px;">
                            Create field mapping templates for your Excel forms. The CRM stores ONLY the field mappings (which cells contain which customer data), not your Excel files.
                        </p>
                        <p style="color: #7f8c8d; font-size: 13px;">
                            This ensures your original Excel formatting is <strong>100% preserved</strong> - you'll upload your original file fresh each time you populate it.
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #1a1a2e; margin-bottom: 15px;">Create New Field Mapping Template</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">Template Name:</label>
                            <input type="text" id="excelTemplateName" placeholder="e.g., VSA Form, Sales Contract, Delivery Order" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">Upload Master Excel File (Optional):</label>
                            <input type="file" id="excelTemplateFile" accept=".xlsx" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;">
                            <p style="color: #7f8c8d; font-size: 12px; margin-top: 5px;">Upload your master Excel template to save it in Google Drive. This way you won't need to upload it every time you populate data.</p>
                        </div>
                        <button class="btn btn-success" onclick="createExcelTemplate()">Create Template</button>
                    </div>

                    <div style="border-top: 2px solid #ecf0f1; padding-top: 20px;">
                        <h3 style="color: #1a1a2e; margin-bottom: 15px;">Uploaded Excel Templates</h3>
                        <div id="excelListContainer">
                            <div class="loading-excel" style="text-align: center; padding: 20px; color: #7f8c8d;">
                                No templates uploaded yet
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Excel Field Mapping Modal -->
    <div class="modal" id="excelMappingModal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Map Excel Fields</h2>
                <span class="close-modal" onclick="closeExcelMappingModal()">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div style="background: rgba(33, 150, 243, 0.1); border: 2px solid rgba(33, 150, 243, 0.5); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #2196f3; margin-bottom: 10px;">How to Map Excel Fields</h4>
                    <ol style="color: #2c3e50; font-size: 14px; margin-left: 20px;">
                        <li>Select which customer field you want to map</li>
                        <li>Enter the Excel cell reference (e.g., A1, B5, C10)</li>
                        <li>Click "Add Mapping" to add it to the list</li>
                        <li>Repeat for all fields you want to auto-fill</li>
                        <li>Click "Save Mappings" when done</li>
                    </ol>
                </div>

                <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: #1a1a2e; margin-bottom: 15px;">Add Field Mapping</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 500;">Customer Field:</label>
                            <select id="excelFieldType" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;">
                                <option value="name">Customer Name</option>
                                <option value="phone">Phone Number</option>
                                <option value="email">Email</option>
                                <option value="nric">NRIC/FIN</option>
                                <option value="occupation">Occupation</option>
                                <option value="dob">Date of Birth</option>
                                <option value="address">Address</option>
                                <option value="addressContinue">Address Continue</option>
                                <option value="fullAddress">Full Address (Combined)</option>
                                <option value="salesConsultant">Sales Consultant</option>
                                <option value="vsaNo">VSA No</option>
                                <option value="date">Today's Date</option>
                                <optgroup label="VSA - New Car Details">
                                    <option value="vsa_makeModel">Make & Model</option>
                                    <option value="vsa_yom">YOM (Year of Manufacture)</option>
                                    <option value="vsa_bodyColour">Body Colour</option>
                                    <option value="vsa_upholstery">Upholstery</option>
                                    <option value="vsa_przType">P/R/Z Type</option>
                                </optgroup>
                                <optgroup label="VSA - New Car Package">
                                    <option value="vsa_package">Package</option>
                                    <option value="vsa_sellingWithCOE">Selling with COE</option>
                                    <option value="vsa_sellingPriceList">Selling Price on Price List</option>
                                    <option value="vsa_purchasePriceWithCOE">Purchase Price with COE</option>
                                    <option value="vsa_coeRebateLevel">COE Rebate Level</option>
                                    <option value="vsa_coeRebate">COE Rebate</option>
                                    <option value="vsa_deposit">Deposit</option>
                                    <option value="vsa_lessOthers">Less: Others</option>
                                    <option value="vsa_addOthers">Add: Others</option>
                                    <option value="vsa_deliveryDate">Approximate Delivery Date</option>
                                </optgroup>
                                <optgroup label="VSA - Trade in Car">
                                    <option value="vsa_tradeInCarNo">Trade in Car No</option>
                                    <option value="vsa_tradeInCarModel">Trade in Car Model</option>
                                    <option value="vsa_tradeInAmount">Trade In Amount</option>
                                </optgroup>
                                <optgroup label="VSA - Delivery Details">
                                    <option value="vsa_dateOfRegistration">Date of Registration</option>
                                    <option value="vsa_registrationNo">Registration No</option>
                                    <option value="vsa_chassisNo">Chassis No</option>
                                    <option value="vsa_engineNo">Engine No</option>
                                </optgroup>
                                <optgroup label="VSA - Remarks">
                                    <option value="vsa_remarks1">Remarks 1</option>
                                    <option value="vsa_remarks2">Remarks 2</option>
                                    <option value="vsa_loanAmount">Loan Amount</option>
                                    <option value="vsa_interest">Interest</option>
                                    <option value="vsa_tenure">Tenure</option>
                                    <option value="vsa_monthlyPayment">Monthly Payment</option>
                                    <option value="vsa_financeCompany">Finance Company</option>
                                    <option value="vsa_adminFee">Admin Fee</option>
                                    <option value="vsa_insuranceSubsidy">Insurance Subsidy</option>
                                </optgroup>
                                <optgroup label="VSA - Insurance">
                                    <option value="vsa_insuranceCompany">Insurance Company</option>
                                    <option value="vsa_insuranceFee">Insurance Fee</option>
                                    <option value="vsa_insuranceNet">Insurance Net (Fee - Subsidy)</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 500;">Excel Cell (e.g., A1):</label>
                            <input type="text" id="excelCellRef" placeholder="A1" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px; text-transform: uppercase;">
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="addExcelMapping()" style="background: #2196f3; white-space: nowrap;">Add Mapping</button>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(76, 175, 80, 0.1); border: 2px solid rgba(76, 175, 80, 0.3); border-radius: 8px; padding: 15px;">
                    <h4 style="color: #4caf50; margin-bottom: 10px;">Current Mappings</h4>
                    <div id="excelMappingsList">
                        <p style="color: #7f8c8d; font-style: italic;">No mappings added yet</p>
                    </div>
                </div>
            </div>
            <div style="padding: 15px; border-top: 2px solid #ecf0f1; background: #f8f9fa; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeExcelMappingModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveExcelMappings()">Save Mappings</button>
            </div>
        </div>
    </div>

    <!-- Excel Populate Modal -->
    <div class="modal" id="excelPopulateModal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Populate Excel with Customer Data</h2>
                <span class="close-modal" onclick="closeExcelPopulateModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(76, 175, 80, 0.1); border: 2px solid rgba(76, 175, 80, 0.3); border-radius: 8px;">
                    <p style="color: #2c3e50; font-size: 14px; margin: 0;">
                        <strong>How it works:</strong> Select a field mapping template. If the template has a master file in Google Drive, it will be used automatically. Otherwise, upload your Excel file manually. Your original formatting is 100% preserved!
                    </p>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">1. Upload Your Original Excel File (Optional):</label>
                    <input type="file" id="excelOriginalFile" accept=".xlsx" onchange="updateExcelPreview()" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;">
                    <p style="color: #7f8c8d; font-size: 12px; margin-top: 5px;">Only required if the template doesn't have a master file in Google Drive</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">2. Select Field Mapping Template:</label>
                    <select id="excelTemplateSelect" onchange="updateExcelPreview()" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;">
                        <option value="">-- Select a mapping template --</option>
                    </select>
                    <p style="color: #7f8c8d; font-size: 12px; margin-top: 5px;">Choose which field mappings to apply to your file</p>
                </div>
                <div style="background: rgba(33, 150, 243, 0.1); border: 2px solid rgba(33, 150, 243, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #2196f3; margin-bottom: 10px;">Customer Information</h4>
                    <div id="excelCustomerPreview" style="color: #2c3e50; font-size: 14px;">
                        <p>Select a template to preview...</p>
                    </div>
                </div>
            </div>
            <div style="padding: 15px; border-top: 2px solid #ecf0f1; background: #f8f9fa; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeExcelPopulateModal()">Cancel</button>
                <button class="btn btn-success" onclick="downloadPopulatedExcel()" id="downloadExcelBtn" disabled>Generate & Save to Drive</button>
            </div>
        </div>
    </div>

    <!-- Upload/Update Master File Modal -->
    <div class="modal" id="uploadMasterFileModal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Upload Master Excel File</h2>
                <span class="close-modal" onclick="closeUploadMasterFileModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(33, 150, 243, 0.1); border: 2px solid rgba(33, 150, 243, 0.3); border-radius: 8px;">
                    <h4 style="color: #2196f3; margin-bottom: 10px;">About Master Files</h4>
                    <p style="color: #2c3e50; font-size: 14px; margin-bottom: 8px;">
                        Upload your master Excel template to Google Drive. Once uploaded, you won't need to upload the file every time you populate customer data.
                    </p>
                    <p style="color: #7f8c8d; font-size: 13px;">
                        If you update your Excel template, you can upload a new version here to replace the old one.
                    </p>
                </div>
                <div id="currentMasterFileInfo" style="margin-bottom: 20px;"></div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">Select Excel File:</label>
                    <input type="file" id="uploadMasterFileInput" accept=".xlsx" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;">
                    <p style="color: #7f8c8d; font-size: 12px; margin-top: 5px;">Choose your master Excel template file (.xlsx)</p>
                </div>
            </div>
            <div style="padding: 15px; border-top: 2px solid #ecf0f1; background: #f8f9fa; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeUploadMasterFileModal()">Cancel</button>
                <button class="btn btn-success" onclick="uploadMasterFile()" id="uploadMasterFileBtn">Upload to Google Drive</button>
            </div>
        </div>
    </div>

    <!-- VSA Details Modal -->
    <div class="modal" id="vsaDetailsModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>VSA Details</h2>
                <span class="close-modal" onclick="closeVsaDetailsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab active" onclick="switchVsaTab('newCarDetails')">BYD New Car Details</button>
                    <button class="tab" onclick="switchVsaTab('newCarPackage')">BYD New Car Package</button>
                    <button class="tab" onclick="switchVsaTab('tradeInCar')">Trade in Car Details</button>
                    <button class="tab" onclick="switchVsaTab('deliveryDetails')">Delivery Details</button>
                    <button class="tab" onclick="switchVsaTab('insurance')">Insurance</button>
                    <button class="tab" onclick="switchVsaTab('remarks')">Remarks</button>
                </div>

                <div id="vsa-tab-newCarDetails" class="tab-content active">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">BYD New Car Details</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Make & Model</label>
                            <select id="vsa_makeModel">
                                <option value="">Select a model...</option>
                                <option value="BYD Atto3 Extended Range 100kw">BYD Atto3 Extended Range 100kw</option>
                                <option value="BYD Atto3 Carbon Edge 100kw">BYD Atto3 Carbon Edge 100kw</option>
                                <option value="BYD Seal Dynamic 100kw">BYD Seal Dynamic 100kw</option>
                                <option value="BYD Seal Premium">BYD Seal Premium</option>
                                <option value="BYD Seal Performance">BYD Seal Performance</option>
                                <option value="BYD Seal 6 Premium">BYD Seal 6 Premium</option>
                                <option value="BYD Dolphin Premium">BYD Dolphin Premium</option>
                                <option value="BYD E6 7-Seater">BYD E6 7-Seater</option>
                                <option value="BYD M6 7-Seater">BYD M6 7-Seater</option>
                                <option value="BYD M6 Carbon Edge">BYD M6 Carbon Edge</option>
                                <option value="BYD Sealion 7 Premium">BYD Sealion 7 Premium</option>
                                <option value="BYD Sealion 7 Performance">BYD Sealion 7 Performance</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>YOM (Year of Manufacture)</label>
                            <input type="text" id="vsa_yom" placeholder="e.g., 2024">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Body Colour</label>
                            <select id="vsa_bodyColour">
                                <option value="">Select a colour...</option>
                                <option value="Ski White">Ski White</option>
                                <option value="Surf Blue">Surf Blue</option>
                                <option value="Cosmos Black">Cosmos Black</option>
                                <option value="Boulder Grey">Boulder Grey</option>
                                <option value="Atlantis Grey">Atlantis Grey</option>
                                <option value="Arctic Blue">Arctic Blue</option>
                                <option value="Aurora While">Aurora While</option>
                                <option value="Maldive Purple">Maldive Purple</option>
                                <option value="Coral Pink">Coral Pink</option>
                                <option value="Sand White">Sand White</option>
                                <option value="Urban Grey">Urban Grey</option>
                                <option value="Crystal White">Crystal White</option>
                                <option value="Harbor Grey">Harbor Grey</option>
                                <option value="Inkstone Blue">Inkstone Blue</option>
                                <option value="Shark Grey">Shark Grey</option>
                                <option value="Whale Sea Blue">Whale Sea Blue</option>
                                <option value="Arctic White">Arctic White</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Upholstery</label>
                            <input type="text" id="vsa_upholstery" value="Standard" placeholder="e.g., Black Leather">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>P/R/Z Type</label>
                        <select id="vsa_przType">
                            <option value="">Select type...</option>
                            <option value="P - Passenger Motor Car">P - Passenger Motor Car</option>
                            <option value="R - Rental / Leasing">R - Rental / Leasing</option>
                            <option value="Z - Private Hire">Z - Private Hire</option>
                        </select>
                    </div>
                </div>

                <div id="vsa-tab-newCarPackage" class="tab-content" style="display: none;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">BYD New Car Package</h3>

                    <div class="form-group">
                        <label>Package</label>
                        <input type="text" id="vsa_package" value="Excite" placeholder="e.g., Premium Package">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Selling with COE</label>
                            <select id="vsa_sellingWithCOE">
                                <option value="WITH" selected>WITH</option>
                                <option value="WITHOUT">WITHOUT</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Selling Price on Price List</label>
                            <input type="text" id="vsa_sellingPriceList" placeholder="e.g., $245,000">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Purchase Price with COE</label>
                            <input type="text" id="vsa_purchasePriceWithCOE" placeholder="e.g., $250,000">
                        </div>
                        <div class="form-group">
                            <label>COE Rebate Level</label>
                            <input type="text" id="vsa_coeRebateLevel" placeholder="e.g., Level 1">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                COE Rebate
                                <span class="info-icon" title="Only if COE falls below Rebate level">
                                    <span style="pointer-events: none;">i</span>
                                    <span class="tooltip-text">Only if COE falls below Rebate level</span>
                                </span>
                            </label>
                            <input type="text" id="vsa_coeRebate" placeholder="e.g., $10,000">
                        </div>
                        <div class="form-group">
                            <label>Deposit</label>
                            <input type="text" id="vsa_deposit" placeholder="e.g., $25,000">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Less: Others</label>
                            <input type="text" id="vsa_lessOthers" placeholder="e.g., $5,000">
                        </div>
                        <div class="form-group">
                            <label>Add: Others</label>
                            <input type="text" id="vsa_addOthers" placeholder="e.g., $2,000">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Approximate Delivery Date</label>
                        <input type="text" id="vsa_deliveryDate" placeholder="e.g., NOV/DEC 2025">
                    </div>
                </div>

                <div id="vsa-tab-tradeInCar" class="tab-content" style="display: none;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">Trade in Car Details</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Trade in Car No</label>
                            <input type="text" id="vsa_tradeInCarNo" placeholder="e.g., ABC1234X">
                        </div>
                        <div class="form-group">
                            <label>Trade in Car Model</label>
                            <input type="text" id="vsa_tradeInCarModel" placeholder="e.g., Toyota Corolla">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Trade In Amount</label>
                        <input type="text" id="vsa_tradeInAmount" placeholder="e.g., $50,000">
                    </div>
                </div>

                <div id="vsa-tab-deliveryDetails" class="tab-content" style="display: none;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">Delivery Details</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Date of Registration</label>
                            <input type="date" id="vsa_dateOfRegistration">
                        </div>
                        <div class="form-group">
                            <label>Registration No</label>
                            <input type="text" id="vsa_registrationNo" placeholder="e.g., ABC1234X">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Chassis No</label>
                            <input type="text" id="vsa_chassisNo" placeholder="e.g., LGXXX12345678">
                        </div>
                        <div class="form-group">
                            <label>Engine No</label>
                            <input type="text" id="vsa_engineNo" placeholder="e.g., ENG123456">
                        </div>
                    </div>
                </div>

                <div id="vsa-tab-remarks" class="tab-content" style="display: none;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">Remarks</h3>

                    <div class="form-group">
                        <label>Remarks 1</label>
                        <textarea id="vsa_remarks1" rows="2" placeholder="e.g., 4 BIDS GUARANTEED COE. $1000 INSURANCE SUBSIDY FOR THE FIRST YEAR." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Remarks 2</label>
                        <textarea id="vsa_remarks2" rows="2" placeholder="e.g., BALANCE DEPOSIT TO BE PAID UPON LOAN APPROVAL BEFORE COE BIDDING." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Loan Amount</label>
                            <input type="text" id="vsa_loanAmount" placeholder="e.g., $200,000">
                        </div>
                        <div class="form-group">
                            <label>Interest</label>
                            <input type="text" id="vsa_interest" placeholder="e.g., 2.88%">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Tenure</label>
                        <input type="text" id="vsa_tenure" placeholder="e.g., 84 months">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Monthly Payment</label>
                            <input type="text" id="vsa_monthlyPayment" placeholder="e.g., $2,500">
                        </div>
                        <div class="form-group">
                            <label>Finance Company</label>
                            <input type="text" id="vsa_financeCompany" placeholder="e.g., DBS Bank">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Admin Fee</label>
                            <input type="text" id="vsa_adminFee" placeholder="e.g., $500">
                        </div>
                        <div class="form-group">
                            <label>Insurance Subsidy</label>
                            <input type="text" id="vsa_insuranceSubsidy" placeholder="e.g., $1,000">
                        </div>
                    </div>
                </div>

                <div id="vsa-tab-insurance" class="tab-content" style="display: none;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">Insurance</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Insurance Company</label>
                            <input type="text" id="vsa_insuranceCompany" placeholder="e.g., AIG Insurance">
                        </div>
                        <div class="form-group">
                            <label>Insurance Fee</label>
                            <input type="text" id="vsa_insuranceFee" placeholder="e.g., $1,200">
                        </div>
                    </div>
                </div>

                <div class="action-buttons" style="margin-top: 30px;">
                    <button class="btn btn-success" onclick="saveVsaDetails()" style="background: #27ae60; margin-right: 10px;">
                        Save VSA Details
                    </button>
                    <button class="btn btn-secondary" onclick="closeVsaDetailsModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================ -->
    <!-- External JavaScript Dependencies -->
    <!-- ================================ -->

    <!-- Google API Client Libraries -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <!-- XLSX Processing Library -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-populate@1.21.0/browser/xlsx-populate.min.js"></script>

    <!-- ================================ -->
    <!-- Application JavaScript Modules   -->
    <!-- ================================ -->

    <!-- Configuration (must load first - contains global variables) -->
    <script src="src/scripts/config.js"></script>

    <!-- Sync Queue Module (must load early - used by other modules) -->
    <script src="src/scripts/modules/syncQueue.js"></script>

    <!-- Core Module Scripts -->
    <script src="src/scripts/modules/auth.js"></script>
    <script src="src/scripts/modules/drive.js"></script>
    <script src="src/scripts/modules/customers.js"></script>
    <script src="src/scripts/modules/forms.js"></script>
    <script src="src/scripts/modules/excel.js"></script>
    <script src="src/scripts/modules/ui.js"></script>
    <script src="src/scripts/modules/documentScanner.js"></script>

    <!-- Utility Functions -->
    <script src="src/scripts/utils/utils.js"></script>

    <!-- Main Application (must load last - initialization) -->
    <script src="src/scripts/app.js"></script>

</body>
</html>
