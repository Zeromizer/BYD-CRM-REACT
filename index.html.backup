<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BYD MotorEast CRM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 12px;
            overflow-y: auto;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding-bottom: 20px;
        }

        .header {
            text-align: center;
            color: white;
            padding: 10px 15px 15px 15px;
            margin-bottom: 20px;
            position: relative;
        }

        .header h1 {
            font-size: 2em;
            font-weight: 700;
            letter-spacing: 6px;
            color: #ffffff;
            text-shadow: 0 0 15px rgba(0, 188, 212, 0.5);
            margin-bottom: 10px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .google-drive-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .google-drive-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .google-drive-btn.connected {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            border-color: rgba(39, 174, 96, 0.3);
        }

        .google-drive-btn .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e74c3c;
            box-shadow: 0 0 8px rgba(231, 76, 60, 0.5);
        }

        .google-drive-btn.connected .status-dot {
            background: #2ecc71;
            box-shadow: 0 0 8px rgba(46, 204, 113, 0.5);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 188, 212, 0.5);
            background: linear-gradient(135deg, #0097a7 0%, #00838f 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 73, 94, 0.4);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 73, 94, 0.5);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.5);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 8px 16px;
            font-size: 12px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.5);
        }

        .btn-drive {
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4);
        }

        .btn-drive:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 188, 212, 0.5);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
        }

        .card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 188, 212, 0.1);
        }

        .card h2 {
            color: #1a1a2e;
            margin-bottom: 15px;
            font-size: 1.5em;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid;
            border-image: linear-gradient(to right, #00bcd4, #0097a7) 1;
        }

        .customer-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .customer-item {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(0, 188, 212, 0.2);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }

        .customer-item:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-color: #00bcd4;
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 188, 212, 0.3);
        }

        .customer-item.active {
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            color: white;
            border-color: #00bcd4;
            box-shadow: 0 5px 15px rgba(0, 188, 212, 0.4);
        }

        .customer-item h3 {
            font-size: 16px;
            margin-bottom: 6px;
            font-weight: 700;
        }

        .customer-item p {
            font-size: 13px;
            opacity: 0.9;
        }

        .customer-item .stage-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            margin-top: 8px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #2d3748;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.2s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .form-group input:read-only,
        .form-group select:disabled,
        .form-group textarea:read-only {
            background-color: #f7fafc;
            color: #4a5568;
            cursor: not-allowed;
            border-color: #e2e8f0;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .checklist-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 2px solid rgba(0, 188, 212, 0.2);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .checklist-section h3 {
            color: #00bcd4;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            padding: 14px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            border: 2px solid rgba(0, 188, 212, 0.1);
        }

        .checklist-item:hover {
            background: #f8f9fa;
            border-color: #00bcd4;
            box-shadow: 0 3px 10px rgba(0, 188, 212, 0.2);
        }

        .checklist-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }

        .checklist-item label {
            flex: 1;
            cursor: pointer;
            font-size: 14px;
            color: #2c3e50;
        }

        .checklist-item.completed {
            opacity: 0.6;
        }

        .checklist-item.completed label {
            text-decoration: line-through;
        }

        .file-upload-section {
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.1) 0%, rgba(34, 153, 84, 0.1) 100%);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            border: 2px solid rgba(39, 174, 96, 0.3);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.2);
        }

        .file-upload-section h3 {
            color: #27ae60;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .upload-area {
            background: white;
            border: 3px dashed rgba(0, 188, 212, 0.4);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            border-color: #00bcd4;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            transform: scale(1.02);
        }

        .upload-area.dragover {
            background: linear-gradient(135deg, rgba(0, 188, 212, 0.1) 0%, rgba(0, 151, 167, 0.1) 100%);
            border-color: #00bcd4;
            transform: scale(1.05);
        }

        .upload-area p {
            color: #00bcd4;
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .upload-area small {
            color: #7f8c8d;
            font-size: 13px;
        }

        .file-list {
            margin-top: 15px;
        }

        .file-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 2px solid #ecf0f1;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            border-color: #667eea;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .file-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-icon {
            font-size: 32px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .file-details {
            flex: 1;
        }

        .file-details h4 {
            color: #2c3e50;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .file-details p {
            color: #7f8c8d;
            font-size: 12px;
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 188, 212, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        }

        .stat-card h3 {
            font-size: 13px;
            color: #00bcd4;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card p {
            font-size: 32px;
            font-weight: 800;
            color: #1a1a2e;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            color: #1a202c;
            font-size: 20px;
            font-weight: 600;
        }

        .close-modal {
            font-size: 24px;
            cursor: pointer;
            color: #a0aec0;
            transition: color 0.2s ease;
        }

        .close-modal:hover {
            color: #2d3748;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            transition: width 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 188, 212, 0.3);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-box::after {
            content: 'üîç';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }

        .file-naming {
            background: #fffbeb;
            padding: 16px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 3px solid #f59e0b;
        }

        .file-naming h4 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 15px;
            font-weight: 600;
        }

        .file-naming code {
            display: block;
            background: white;
            padding: 10px 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 8px 0;
            color: #2d3748;
            border: 1px solid #fde68a;
        }

        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(0, 188, 212, 0.2);
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: #7f8c8d;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tab:hover {
            color: #00bcd4;
            background: rgba(0, 188, 212, 0.05);
        }

        .tab.active {
            color: #00bcd4;
            border-bottom-color: #00bcd4;
            background: rgba(0, 188, 212, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .drive-folder-info {
            background: linear-gradient(135deg, rgba(0, 188, 212, 0.1) 0%, rgba(0, 151, 167, 0.1) 100%);
            padding: 18px;
            border-radius: 12px;
            margin-top: 15px;
            border: 2px solid rgba(0, 188, 212, 0.3);
            box-shadow: 0 5px 15px rgba(0, 188, 212, 0.2);
        }

        .drive-folder-info h4 {
            color: #00bcd4;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .drive-folder-info p {
            color: #2c3e50;
            font-size: 14px;
            margin: 8px 0;
        }

        .drive-folder-info a {
            color: #00bcd4;
            text-decoration: none;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .drive-folder-info a:hover {
            color: #0097a7;
            text-decoration: underline;
        }

        .setup-instructions {
            background: #fffbeb;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 3px solid #f59e0b;
        }

        .setup-instructions h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .setup-instructions ol {
            margin-left: 20px;
        }

        .setup-instructions li {
            margin: 10px 0;
            color: #424242;
        }

        .setup-instructions code {
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .header {
                text-align: center;
                padding-top: 50px;
            }

            .header h1 {
                font-size: 18px;
                line-height: 1.4;
            }

            .header h1 #syncStatus {
                display: block;
                margin: 5px 0 0 0 !important;
                font-size: 12px !important;
            }

            .google-drive-btn {
                top: 10px;
                right: 10px;
                font-size: 11px;
                padding: 6px 12px;
            }

            .header-actions {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                justify-content: center;
            }

            .header-actions .btn {
                font-size: 12px;
                padding: 8px 12px;
                flex: 1 1 auto;
                min-width: 120px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-card h3 {
                font-size: 11px;
            }

            .stat-card .stat-number {
                font-size: 24px;
            }

            /* Customer list optimizations */
            .customer-list {
                max-height: 400px;
            }

            .customer-item {
                padding: 12px;
            }

            .customer-item h3 {
                font-size: 14px;
            }

            .customer-item p {
                font-size: 12px;
            }

            /* Customer details mobile view */
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }

            .card h2 {
                font-size: 1.2em;
            }

            /* Tabs mobile optimization */
            .tabs {
                display: flex;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                gap: 5px;
                margin-bottom: 15px;
            }

            .tab {
                font-size: 12px;
                padding: 10px 15px;
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* Upload area mobile */
            .upload-area {
                padding: 25px 15px;
            }

            .upload-area p {
                font-size: 14px;
            }

            .upload-area small {
                font-size: 11px;
            }

            /* File list mobile optimization */
            .file-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 12px;
                gap: 12px;
            }

            .file-info {
                width: 100%;
                gap: 10px;
            }

            .file-icon {
                font-size: 24px;
                width: 40px;
                height: 40px;
                flex-shrink: 0;
            }

            .file-details {
                min-width: 0;
                flex: 1;
            }

            .file-details h4 {
                font-size: 13px;
                word-break: break-word;
                overflow-wrap: break-word;
            }

            .file-details p {
                font-size: 11px;
            }

            .file-actions {
                width: 100%;
                justify-content: flex-end;
                gap: 6px;
            }

            .file-actions .btn {
                font-size: 11px;
                padding: 6px 10px;
            }

            /* Form mobile optimization */
            .form-group label {
                font-size: 13px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
            }

            /* Buttons mobile */
            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }

            .action-buttons {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .action-buttons .btn {
                width: 100%;
            }

            /* Modal mobile */
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 20px auto;
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal-header h2 {
                font-size: 1.3em;
            }

            /* Checklist mobile */
            .checklist-item {
                padding: 10px;
                font-size: 13px;
            }

            .checklist-item label {
                font-size: 13px;
            }

            /* File naming section */
            .file-naming {
                padding: 12px;
            }

            .file-naming h4 {
                font-size: 14px;
            }

            .file-naming p,
            .file-naming ul {
                font-size: 11px;
            }

            /* Document folder select */
            select[id*="documentTypeSelect"] {
                font-size: 14px;
                padding: 10px;
            }

            /* Auto-classify toggle */
            .toggle-container {
                font-size: 12px;
            }

            /* Auth section mobile */
            .auth-section {
                padding: 20px 15px;
            }

            .auth-section h3 {
                font-size: 16px;
            }

            .auth-section p {
                font-size: 13px;
            }

            /* Empty state */
            .empty-state {
                padding: 30px 15px;
                font-size: 14px;
            }

            /* Progress indicator */
            #addCustomerProgress {
                margin: 10px 0;
                padding: 8px;
            }

            #addCustomerProgress p {
                font-size: 12px;
            }

            /* Make sure text doesn't overflow */
            * {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            /* Improve touch targets */
            button,
            .customer-item,
            .file-item,
            .tab,
            input[type="checkbox"] {
                min-height: 44px; /* iOS recommended touch target */
            }

            input[type="checkbox"] {
                transform: scale(1.3);
                margin-right: 10px;
            }

            /* Move dialog mobile */
            #moveFileDialog input[type="text"] {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
            }

            #moveFileDialog select {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
            }

            #moveFileDialog button {
                font-size: 14px;
                padding: 12px 16px;
                min-height: 44px;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="google-drive-btn" id="authButton" onclick="handleAuthClick()" disabled title="Google Drive Connection">
                <span class="status-dot"></span>
                <span id="authButtonText">Google Drive</span>
            </button>
            <h1>BYD MotorEast CRM <span id="syncStatus" style="font-size: 14px; font-weight: normal; margin-left: 10px;"></span></h1>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openAddCustomerModal()">Add Customer</button>
                <button class="btn btn-secondary" onclick="openFormsModal()">üìÑ Manage Forms</button>
                <button class="btn btn-secondary" onclick="openExcelModal()">üìä Manage Excel</button>
                <button class="btn btn-secondary" onclick="forceSyncFromDrive()" title="Reload data from Google Drive">üîÑ Force Sync</button>
                <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
                <button class="btn btn-secondary" onclick="importData()">Import Data</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Customers</h3>
                <p id="totalCustomers">0</p>
            </div>
            <div class="stat-card">
                <h3>Active Deals</h3>
                <p id="activeDeals">0</p>
            </div>
            <div class="stat-card">
                <h3>Files in Drive</h3>
                <p id="totalFiles">0</p>
            </div>
            <div class="stat-card">
                <h3>Folders Created</h3>
                <p id="totalFolders">0</p>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>Customer List</h2>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search customers..." onkeyup="searchCustomers()">
                </div>
                <div class="customer-list" id="customerList">
                    <div class="empty-state">
                        <p>No customers yet</p>
                        <p style="font-size: 14px; margin-top: 10px;">Click "Add Customer" to get started</p>
                    </div>
                </div>
            </div>

            <div class="card" id="customerDetails">
                <div class="empty-state">
                    <p>Select a customer to view details</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div class="modal" id="addCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Customer</h2>
                <span class="close-modal" onclick="closeAddCustomerModal()">&times;</span>
            </div>
            <form onsubmit="addCustomer(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="newCustomerName" required>
                    </div>
                    <div class="form-group">
                        <label>Contact Number *</label>
                        <input type="tel" id="newCustomerPhone" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="newCustomerEmail">
                    </div>
                    <div class="form-group">
                        <label>NRIC/FIN</label>
                        <input type="text" id="newCustomerNRIC" placeholder="S1234567A or F1234567N">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Occupation</label>
                        <input type="text" id="newCustomerOccupation" placeholder="e.g., Engineer, Teacher">
                    </div>
                    <div class="form-group">
                        <label>Date of Birth</label>
                        <input type="date" id="newCustomerDOB">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Sales Consultant</label>
                        <input type="text" id="newCustomerSalesConsultant">
                    </div>
                    <div class="form-group">
                        <label>VSA No</label>
                        <input type="text" id="newCustomerVsaNo" placeholder="VSA Number">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" id="newCustomerAddress" placeholder="e.g., 99 YISHUN AVE 1, 13-39">
                    </div>
                    <div class="form-group">
                        <label>Address Continue</label>
                        <input type="text" id="newCustomerAddressContinue" placeholder="e.g., SINGAPORE 769139">
                    </div>
                </div>
                <div class="form-group">
                    <label>Interested Model</label>
                    <select id="newCustomerModel">
                        <option value="">Select Model</option>
                        <option value="Seal">Seal</option>
                        <option value="Seal 6">Seal 6</option>
                        <option value="Sealion 6">Sealion 6</option>
                        <option value="Sealion 7">Sealion 7</option>
                        <option value="Dolphin">Dolphin</option>
                        <option value="Atto 2">Atto 2</option>
                        <option value="Atto 3">Atto 3</option>
                        <option value="M6">M6</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="newCustomerNotes" rows="3"></textarea>
                </div>
                <div id="addCustomerProgress" style="display: none; margin: 15px 0; padding: 10px; background: #e8f5e9; border-radius: 5px;">
                    <p style="margin: 0; color: #27ae60; font-size: 14px;">
                        <span id="addCustomerProgressText">Creating customer...</span>
                    </p>
                    <div style="width: 100%; height: 4px; background: #c8e6c9; border-radius: 2px; margin-top: 8px; overflow: hidden;">
                        <div id="addCustomerProgressBar" style="width: 0%; height: 100%; background: #27ae60; transition: width 0.3s;"></div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button type="submit" id="addCustomerSubmitBtn" class="btn btn-primary">Add Customer</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddCustomerModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Setup Instructions Modal -->
    <div class="modal" id="setupModal" style="display: none;">
        <!-- Modal hidden since Client ID is pre-configured -->
    </div>

    <!-- Forms Management Modal -->
    <div class="modal" id="formsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÑ Forms Management</h2>
                <span class="close-modal" onclick="closeFormsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="formsModalContent">
                    <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, rgba(0, 188, 212, 0.1) 0%, rgba(0, 151, 167, 0.1) 100%); border-radius: 10px; border: 2px solid rgba(0, 188, 212, 0.3);">
                        <h3 style="color: #00bcd4; margin-bottom: 10px;">About Form Templates</h3>
                        <p style="color: #2c3e50; font-size: 14px; margin-bottom: 8px;">
                            Upload your form templates here (PDF or image format). Once uploaded, you can easily view and print them from customer profiles.
                        </p>
                        <p style="color: #7f8c8d; font-size: 13px;">
                            Forms are stored in Google Drive and will be accessible across all sessions.
                        </p>
                    </div>

                    <div id="formsNotConnected" style="display: none;">
                        <div class="auth-section">
                            <h3>‚ö†Ô∏è Not Connected to Google Drive</h3>
                            <p>Connect to Google Drive to manage form templates.</p>
                            <button class="btn btn-drive" onclick="handleAuthClick()">
                                üìÅ Connect Google Drive
                            </button>
                        </div>
                    </div>

                    <div id="formsConnected" style="display: none;">
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #1a1a2e; margin-bottom: 15px;">Upload New Form</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">Form Type:</label>
                                <select id="formTypeSelect" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;">
                                    <option value="test_drive">Test Drive Agreement Form</option>
                                    <option value="vsa">Vehicle Sales Agreement</option>
                                    <option value="pdpa">PDPA Consent Form</option>
                                    <option value="coe_bidding_1">COE Bidding 1</option>
                                    <option value="coe_bidding_2">COE Bidding 2</option>
                                    <option value="pdpa_consent_1">PDPA Consent 1</option>
                                    <option value="pdpa_consent_2">PDPA Consent 2</option>
                                    <option value="other">Other Form</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">Select PDF or Image File:</label>
                                <input type="file" id="formFileInput" accept=".pdf,image/*" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;">
                            </div>
                            <button class="btn btn-success" onclick="uploadFormTemplate()">Upload Form</button>
                        </div>

                        <div style="border-top: 2px solid #ecf0f1; padding-top: 20px;">
                            <h3 style="color: #1a1a2e; margin-bottom: 15px;">Uploaded Forms</h3>
                            <div id="formsListContainer">
                                <div class="loading-forms" style="text-align: center; padding: 20px; color: #7f8c8d;">
                                    Loading forms...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Field Mapping Modal -->
    <div class="modal" id="fieldMappingModal" style="display: none;">
        <div class="modal-content" style="max-width: 95%; height: 95vh;">
            <div class="modal-header">
                <h2>üìù Configure Form Fields</h2>
                <span class="close-modal" onclick="closeFieldMappingModal()">&times;</span>
            </div>
            <div class="modal-body" style="overflow: auto; height: calc(95vh - 120px);">
                <div style="background: rgba(255, 193, 7, 0.1); border: 2px solid rgba(255, 193, 7, 0.5); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #f39c12; margin-bottom: 10px;">üìç How to Map Fields</h4>
                    <ol style="color: #2c3e50; font-size: 14px; margin-left: 20px;">
                        <li>Click on the form image where you want to place a field</li>
                        <li>Select which customer data to display at that position</li>
                        <li>Adjust font size if needed</li>
                        <li>Repeat for all fields you want to auto-fill</li>
                        <li>Click "Save Configuration" when done</li>
                    </ol>
                </div>

                <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div>
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 5px; display: block;">Field to Place:</label>
                        <select id="fieldTypeSelect" onchange="toggleCustomValueInput()" style="padding: 8px; border: 2px solid #00bcd4; border-radius: 6px; font-size: 14px;">
                            <option value="custom">Custom Value (Enter below)</option>
                            <option value="name">Customer Name</option>
                            <option value="phone">Phone Number</option>
                            <option value="email">Email</option>
                            <option value="nric">NRIC/FIN</option>
                            <option value="occupation">Occupation</option>
                            <option value="dob">Date of Birth</option>
                            <option value="address">Address</option>
                            <option value="addressContinue">Address Continue</option>
                            <option value="salesConsultant">Sales Consultant</option>
                            <option value="vsaNo">VSA No</option>
                            <option value="model">Car Model</option>
                            <option value="date">Today's Date</option>
                            <optgroup label="VSA - New Car Details">
                                <option value="vsa_makeModel">Make & Model</option>
                                <option value="vsa_yom">YOM (Year of Manufacture)</option>
                                <option value="vsa_bodyColour">Body Colour</option>
                                <option value="vsa_upholstery">Upholstery</option>
                                <option value="vsa_przType">P/R/Z Type</option>
                            </optgroup>
                            <optgroup label="VSA - New Car Package">
                                <option value="vsa_package">Package</option>
                                <option value="vsa_sellingWithCOE">Selling with COE</option>
                                <option value="vsa_sellingPriceList">Selling Price on Price List</option>
                                <option value="vsa_purchasePriceWithCOE">Purchase Price with COE</option>
                                <option value="vsa_coeRebateLevel">COE Rebate Level</option>
                                <option value="vsa_deposit">Deposit</option>
                                <option value="vsa_lessOthers">Less: Others</option>
                                <option value="vsa_addOthers">Add: Others</option>
                                <option value="vsa_deliveryDate">Approximate Delivery Date</option>
                            </optgroup>
                            <optgroup label="VSA - Trade in Car">
                                <option value="vsa_tradeInCarNo">Trade in Car No</option>
                                <option value="vsa_tradeInCarModel">Trade in Car Model</option>
                                <option value="vsa_tradeInAmount">Trade In Amount</option>
                            </optgroup>
                            <optgroup label="VSA - Remarks">
                                <option value="vsa_remarks1">Remarks 1</option>
                                <option value="vsa_remarks2">Remarks 2</option>
                                <option value="vsa_loanAmount">Loan Amount</option>
                                <option value="vsa_interest">Interest</option>
                                <option value="vsa_tenure">Tenure</option>
                                <option value="vsa_monthlyPayment">Monthly Payment</option>
                                <option value="vsa_financeCompany">Finance Company</option>
                            </optgroup>
                            <optgroup label="VSA - Insurance">
                                <option value="vsa_insuranceCompany">Insurance Company</option>
                                <option value="vsa_insuranceFee">Insurance Fee</option>
                            </optgroup>
                        </select>
                    </div>
                    <div id="customValueInputContainer" style="display: block;">
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 5px; display: block;">Custom Value:</label>
                        <input type="text" id="customValueInput" placeholder="Enter text or number" style="padding: 8px; border: 2px solid #00bcd4; border-radius: 6px; font-size: 14px; width: 200px;">
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 5px; display: block;">Font Size (px):</label>
                        <input type="number" id="fieldFontSize" value="16" min="8" max="48" style="padding: 8px; border: 2px solid #00bcd4; border-radius: 6px; font-size: 14px; width: 100px;">
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 5px; display: block;">Text Color:</label>
                        <input type="color" id="fieldTextColor" value="#000000" style="padding: 4px; border: 2px solid #00bcd4; border-radius: 6px; height: 38px; width: 80px;">
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 5px; display: block;">&nbsp;</label>
                        <button class="btn btn-secondary" onclick="clearAllFieldMappings()" style="background: #e74c3c;">Clear All Fields</button>
                    </div>
                </div>

                <div id="formImageContainer" style="position: relative; display: inline-block; border: 3px solid #00bcd4; border-radius: 8px; overflow: hidden; background: white; cursor: crosshair;">
                    <canvas id="formMappingCanvas"></canvas>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: rgba(39, 174, 96, 0.1); border: 2px solid rgba(39, 174, 96, 0.3); border-radius: 8px;">
                    <h4 style="color: #27ae60; margin-bottom: 10px;">Mapped Fields</h4>
                    <div id="mappedFieldsList" style="color: #2c3e50; font-size: 14px;"></div>
                </div>
            </div>
            <div style="padding: 15px; border-top: 2px solid #ecf0f1; background: #f8f9fa; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeFieldMappingModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveFieldMappings()">Save Configuration</button>
            </div>
        </div>
    </div>

    <!-- Combine & Print Forms Modal -->
    <div class="modal" id="combinePrintModal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>üìë Combine Forms for Double-Sided Printing</h2>
                <span class="close-modal" onclick="closeCombinePrintModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(0, 188, 212, 0.1); border: 2px solid rgba(0, 188, 212, 0.3); border-radius: 8px;">
                    <h4 style="color: #00bcd4; margin-bottom: 10px;">üí° How it works</h4>
                    <p style="color: #2c3e50; font-size: 14px; margin-bottom: 8px;">
                        Select 2 forms to combine them into a single document perfect for double-sided printing. For example: PDPA on front, COE Bidding on back.
                    </p>
                    <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 8px;">
                        Each form will be on a separate page with proper page breaks for duplex printing.
                    </p>
                    <p style="color: #27ae60; font-size: 13px; font-weight: 600;">
                        ‚úì Customer data will be automatically filled in based on your field mappings!
                    </p>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 600;">Side 1 (Front):</label>
                    <select id="combineSide1" style="width: 100%; padding: 10px; border: 2px solid #00bcd4; border-radius: 6px; font-size: 14px;">
                        <option value="">Select a form...</option>
                    </select>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 600;">Side 2 (Back):</label>
                    <select id="combineSide2" style="width: 100%; padding: 10px; border: 2px solid #00bcd4; border-radius: 6px; font-size: 14px;">
                        <option value="">Select a form...</option>
                    </select>
                </div>

                <div style="padding: 12px; background: rgba(255, 152, 0, 0.1); border: 2px solid rgba(255, 152, 0, 0.3); border-radius: 6px; margin-bottom: 20px;">
                    <p style="color: #f57c00; font-size: 13px; margin: 0;">
                        <strong>Note:</strong> Currently supports image forms only. PDF forms will be supported in a future update.
                    </p>
                </div>
            </div>
            <div style="padding: 15px; border-top: 2px solid #ecf0f1; background: #f8f9fa; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeCombinePrintModal()">Cancel</button>
                <button class="btn btn-success" onclick="combinePrintForms()">üñ®Ô∏è Preview & Print</button>
            </div>
        </div>
    </div>

    <!-- Excel Templates Management Modal -->
    <div class="modal" id="excelModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä Excel Templates Management</h2>
                <span class="close-modal" onclick="closeExcelModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="excelModalContent">
                    <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(56, 142, 60, 0.1) 100%); border-radius: 10px; border: 2px solid rgba(76, 175, 80, 0.3);">
                        <h3 style="color: #4caf50; margin-bottom: 10px;">About Excel Templates</h3>
                        <p style="color: #2c3e50; font-size: 14px; margin-bottom: 8px;">
                            Create field mapping templates for your Excel forms. The CRM stores ONLY the field mappings (which cells contain which customer data), not your Excel files.
                        </p>
                        <p style="color: #7f8c8d; font-size: 13px;">
                            This ensures your original Excel formatting is <strong>100% preserved</strong> - you'll upload your original file fresh each time you populate it.
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #1a1a2e; margin-bottom: 15px;">Create New Field Mapping Template</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">Template Name:</label>
                            <input type="text" id="excelTemplateName" placeholder="e.g., VSA Form, Sales Contract, Delivery Order" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;">
                        </div>
                        <button class="btn btn-success" onclick="createExcelTemplate()">Create Template</button>
                    </div>

                    <div style="border-top: 2px solid #ecf0f1; padding-top: 20px;">
                        <h3 style="color: #1a1a2e; margin-bottom: 15px;">Uploaded Excel Templates</h3>
                        <div id="excelListContainer">
                            <div class="loading-excel" style="text-align: center; padding: 20px; color: #7f8c8d;">
                                No templates uploaded yet
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Excel Field Mapping Modal -->
    <div class="modal" id="excelMappingModal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üìù Map Excel Fields</h2>
                <span class="close-modal" onclick="closeExcelMappingModal()">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div style="background: rgba(33, 150, 243, 0.1); border: 2px solid rgba(33, 150, 243, 0.5); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #2196f3; margin-bottom: 10px;">üìç How to Map Excel Fields</h4>
                    <ol style="color: #2c3e50; font-size: 14px; margin-left: 20px;">
                        <li>Select which customer field you want to map</li>
                        <li>Enter the Excel cell reference (e.g., A1, B5, C10)</li>
                        <li>Click "Add Mapping" to add it to the list</li>
                        <li>Repeat for all fields you want to auto-fill</li>
                        <li>Click "Save Mappings" when done</li>
                    </ol>
                </div>

                <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: #1a1a2e; margin-bottom: 15px;">Add Field Mapping</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 500;">Customer Field:</label>
                            <select id="excelFieldType" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;">
                                <option value="name">Customer Name</option>
                                <option value="phone">Phone Number</option>
                                <option value="email">Email</option>
                                <option value="nric">NRIC/FIN</option>
                                <option value="occupation">Occupation</option>
                                <option value="dob">Date of Birth</option>
                                <option value="address">Address</option>
                                <option value="addressContinue">Address Continue</option>
                                <option value="salesConsultant">Sales Consultant</option>
                                <option value="vsaNo">VSA No</option>
                                <option value="model">Car Model</option>
                                <option value="date">Today's Date</option>
                                <optgroup label="VSA - New Car Details">
                                    <option value="vsa_makeModel">Make & Model</option>
                                    <option value="vsa_yom">YOM (Year of Manufacture)</option>
                                    <option value="vsa_bodyColour">Body Colour</option>
                                    <option value="vsa_upholstery">Upholstery</option>
                                    <option value="vsa_przType">P/R/Z Type</option>
                                </optgroup>
                                <optgroup label="VSA - New Car Package">
                                    <option value="vsa_package">Package</option>
                                    <option value="vsa_sellingWithCOE">Selling with COE</option>
                                    <option value="vsa_sellingPriceList">Selling Price on Price List</option>
                                    <option value="vsa_purchasePriceWithCOE">Purchase Price with COE</option>
                                    <option value="vsa_coeRebateLevel">COE Rebate Level</option>
                                    <option value="vsa_deposit">Deposit</option>
                                    <option value="vsa_lessOthers">Less: Others</option>
                                    <option value="vsa_addOthers">Add: Others</option>
                                    <option value="vsa_deliveryDate">Approximate Delivery Date</option>
                                </optgroup>
                                <optgroup label="VSA - Trade in Car">
                                    <option value="vsa_tradeInCarNo">Trade in Car No</option>
                                    <option value="vsa_tradeInCarModel">Trade in Car Model</option>
                                    <option value="vsa_tradeInAmount">Trade In Amount</option>
                                </optgroup>
                                <optgroup label="VSA - Remarks">
                                    <option value="vsa_remarks1">Remarks 1</option>
                                    <option value="vsa_remarks2">Remarks 2</option>
                                    <option value="vsa_loanAmount">Loan Amount</option>
                                    <option value="vsa_interest">Interest</option>
                                    <option value="vsa_tenure">Tenure</option>
                                    <option value="vsa_monthlyPayment">Monthly Payment</option>
                                    <option value="vsa_financeCompany">Finance Company</option>
                                </optgroup>
                                <optgroup label="VSA - Insurance">
                                    <option value="vsa_insuranceCompany">Insurance Company</option>
                                    <option value="vsa_insuranceFee">Insurance Fee</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 500;">Excel Cell (e.g., A1):</label>
                            <input type="text" id="excelCellRef" placeholder="A1" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px; text-transform: uppercase;">
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="addExcelMapping()" style="background: #2196f3; white-space: nowrap;">Add Mapping</button>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(76, 175, 80, 0.1); border: 2px solid rgba(76, 175, 80, 0.3); border-radius: 8px; padding: 15px;">
                    <h4 style="color: #4caf50; margin-bottom: 10px;">Current Mappings</h4>
                    <div id="excelMappingsList">
                        <p style="color: #7f8c8d; font-style: italic;">No mappings added yet</p>
                    </div>
                </div>
            </div>
            <div style="padding: 15px; border-top: 2px solid #ecf0f1; background: #f8f9fa; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeExcelMappingModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveExcelMappings()">Save Mappings</button>
            </div>
        </div>
    </div>

    <!-- Excel Populate Modal -->
    <div class="modal" id="excelPopulateModal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>üìä Populate Excel with Customer Data</h2>
                <span class="close-modal" onclick="closeExcelPopulateModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(76, 175, 80, 0.1); border: 2px solid rgba(76, 175, 80, 0.3); border-radius: 8px;">
                    <p style="color: #2c3e50; font-size: 14px; margin: 0;">
                        <strong>üí° How it works:</strong> Upload your <strong>original</strong> Excel file from your computer, select which field mapping template to use, and download the populated file. Your original formatting is 100% preserved!
                    </p>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">1. Upload Your Original Excel File:</label>
                    <input type="file" id="excelOriginalFile" accept=".xlsx" onchange="updateExcelPreview()" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;">
                    <p style="color: #7f8c8d; font-size: 12px; margin-top: 5px;">Select your original Excel form file from your computer</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">2. Select Field Mapping Template:</label>
                    <select id="excelTemplateSelect" onchange="updateExcelPreview()" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;">
                        <option value="">-- Select a mapping template --</option>
                    </select>
                    <p style="color: #7f8c8d; font-size: 12px; margin-top: 5px;">Choose which field mappings to apply to your file</p>
                </div>
                <div style="background: rgba(33, 150, 243, 0.1); border: 2px solid rgba(33, 150, 243, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #2196f3; margin-bottom: 10px;">Customer Information</h4>
                    <div id="excelCustomerPreview" style="color: #2c3e50; font-size: 14px;">
                        <p>Select a template to preview...</p>
                    </div>
                </div>
            </div>
            <div style="padding: 15px; border-top: 2px solid #ecf0f1; background: #f8f9fa; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeExcelPopulateModal()">Cancel</button>
                <button class="btn btn-success" onclick="downloadPopulatedExcel()" id="downloadExcelBtn" disabled>Download Populated Excel</button>
            </div>
        </div>
    </div>

    <!-- VSA Details Modal -->
    <div class="modal" id="vsaDetailsModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>VSA Details</h2>
                <span class="close-modal" onclick="closeVsaDetailsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab active" onclick="switchVsaTab('newCarDetails')">BYD New Car Details</button>
                    <button class="tab" onclick="switchVsaTab('newCarPackage')">BYD New Car Package</button>
                    <button class="tab" onclick="switchVsaTab('tradeInCar')">Trade in Car Details</button>
                    <button class="tab" onclick="switchVsaTab('insurance')">Insurance</button>
                    <button class="tab" onclick="switchVsaTab('remarks')">Remarks</button>
                </div>

                <div id="vsa-tab-newCarDetails" class="tab-content active">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">BYD New Car Details</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Make & Model</label>
                            <select id="vsa_makeModel">
                                <option value="">Select a model...</option>
                                <option value="BYD Atto3 Extended Range 100kw">BYD Atto3 Extended Range 100kw</option>
                                <option value="BYD Atto3 Carbon Edge 100kw">BYD Atto3 Carbon Edge 100kw</option>
                                <option value="BYD Seal Dynamic 100kw">BYD Seal Dynamic 100kw</option>
                                <option value="BYD Seal Premium">BYD Seal Premium</option>
                                <option value="BYD Seal Performance">BYD Seal Performance</option>
                                <option value="BYD Seal 6 Premium">BYD Seal 6 Premium</option>
                                <option value="BYD Dolphin Premium">BYD Dolphin Premium</option>
                                <option value="BYD E6 7-Seater">BYD E6 7-Seater</option>
                                <option value="BYD M6 7-Seater">BYD M6 7-Seater</option>
                                <option value="BYD M6 Carbon Edge">BYD M6 Carbon Edge</option>
                                <option value="BYD Sealion 7 Premium">BYD Sealion 7 Premium</option>
                                <option value="BYD Sealion 7 Performance">BYD Sealion 7 Performance</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>YOM (Year of Manufacture)</label>
                            <input type="text" id="vsa_yom" placeholder="e.g., 2024">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Body Colour</label>
                            <select id="vsa_bodyColour">
                                <option value="">Select a colour...</option>
                                <option value="Ski White">Ski White</option>
                                <option value="Surf Blue">Surf Blue</option>
                                <option value="Cosmos Black">Cosmos Black</option>
                                <option value="Boulder Grey">Boulder Grey</option>
                                <option value="Atlantis Grey">Atlantis Grey</option>
                                <option value="Arctic Blue">Arctic Blue</option>
                                <option value="Aurora While">Aurora While</option>
                                <option value="Maldive Purple">Maldive Purple</option>
                                <option value="Coral Pink">Coral Pink</option>
                                <option value="Sand White">Sand White</option>
                                <option value="Urban Grey">Urban Grey</option>
                                <option value="Crystal White">Crystal White</option>
                                <option value="Harbor Grey">Harbor Grey</option>
                                <option value="Inkstone Blue">Inkstone Blue</option>
                                <option value="Shark Grey">Shark Grey</option>
                                <option value="Whale Sea Blue">Whale Sea Blue</option>
                                <option value="Arctic White">Arctic White</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Upholstery</label>
                            <input type="text" id="vsa_upholstery" value="Standard" placeholder="e.g., Black Leather">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>P/R/Z Type</label>
                        <select id="vsa_przType">
                            <option value="">Select type...</option>
                            <option value="P - Passenger Motor Car">P - Passenger Motor Car</option>
                            <option value="R - Rental / Leasing">R - Rental / Leasing</option>
                            <option value="Z - Private Hire">Z - Private Hire</option>
                        </select>
                    </div>
                </div>

                <div id="vsa-tab-newCarPackage" class="tab-content" style="display: none;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">BYD New Car Package</h3>

                    <div class="form-group">
                        <label>Package</label>
                        <input type="text" id="vsa_package" value="Excite" placeholder="e.g., Premium Package">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Selling with COE</label>
                            <select id="vsa_sellingWithCOE">
                                <option value="WITH" selected>WITH</option>
                                <option value="WITHOUT">WITHOUT</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Selling Price on Price List</label>
                            <input type="text" id="vsa_sellingPriceList" placeholder="e.g., $245,000">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Purchase Price with COE</label>
                            <input type="text" id="vsa_purchasePriceWithCOE" placeholder="e.g., $250,000">
                        </div>
                        <div class="form-group">
                            <label>COE Rebate Level</label>
                            <input type="text" id="vsa_coeRebateLevel" placeholder="e.g., Level 1">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Deposit</label>
                            <input type="text" id="vsa_deposit" placeholder="e.g., $25,000">
                        </div>
                        <div class="form-group">
                            <label>Less: Others</label>
                            <input type="text" id="vsa_lessOthers" placeholder="e.g., $5,000">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Add: Others</label>
                            <input type="text" id="vsa_addOthers" placeholder="e.g., $2,000">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Approximate Delivery Date</label>
                        <input type="text" id="vsa_deliveryDate" placeholder="e.g., NOV/DEC 2025">
                    </div>
                </div>

                <div id="vsa-tab-tradeInCar" class="tab-content" style="display: none;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">Trade in Car Details</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Trade in Car No</label>
                            <input type="text" id="vsa_tradeInCarNo" placeholder="e.g., ABC1234X">
                        </div>
                        <div class="form-group">
                            <label>Trade in Car Model</label>
                            <input type="text" id="vsa_tradeInCarModel" placeholder="e.g., Toyota Corolla">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Trade In Amount</label>
                        <input type="text" id="vsa_tradeInAmount" placeholder="e.g., $50,000">
                    </div>
                </div>

                <div id="vsa-tab-remarks" class="tab-content" style="display: none;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">Remarks</h3>

                    <div class="form-group">
                        <label>Remarks 1</label>
                        <textarea id="vsa_remarks1" rows="2" placeholder="e.g., 4 BIDS GUARANTEED COE. $1000 INSURANCE SUBSIDY FOR THE FIRST YEAR." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Remarks 2</label>
                        <textarea id="vsa_remarks2" rows="2" placeholder="e.g., BALANCE DEPOSIT TO BE PAID UPON LOAN APPROVAL BEFORE COE BIDDING." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Loan Amount</label>
                            <input type="text" id="vsa_loanAmount" placeholder="e.g., $200,000">
                        </div>
                        <div class="form-group">
                            <label>Interest</label>
                            <input type="text" id="vsa_interest" placeholder="e.g., 2.88%">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Tenure</label>
                        <input type="text" id="vsa_tenure" placeholder="e.g., 84 months">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Monthly Payment</label>
                            <input type="text" id="vsa_monthlyPayment" placeholder="e.g., $2,500">
                        </div>
                        <div class="form-group">
                            <label>Finance Company</label>
                            <input type="text" id="vsa_financeCompany" placeholder="e.g., DBS Bank">
                        </div>
                    </div>
                </div>

                <div id="vsa-tab-insurance" class="tab-content" style="display: none;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">Insurance</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Insurance Company</label>
                            <input type="text" id="vsa_insuranceCompany" placeholder="e.g., AIG Insurance">
                        </div>
                        <div class="form-group">
                            <label>Insurance Fee</label>
                            <input type="text" id="vsa_insuranceFee" placeholder="e.g., $1,200">
                        </div>
                    </div>
                </div>

                <div class="action-buttons" style="margin-top: 30px;">
                    <button class="btn btn-success" onclick="saveVsaDetails()" style="background: #27ae60; margin-right: 10px;">
                        Save VSA Details
                    </button>
                    <button class="btn btn-secondary" onclick="closeVsaDetailsModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Identity Services (New Library) -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Google API for Drive operations -->
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- xlsx-populate for Excel file handling with PERFECT formatting preservation -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-populate@1.21.0/browser/xlsx-populate.min.js"></script>

    <script>
        // Configuration
        let CLIENT_ID = '876961148543-8sdj3cti6q9tc523natb3g6jt789qlbr.apps.googleusercontent.com';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        // State
        let customers = [];
        let selectedCustomerId = null;
        let isSignedIn = false;
        let rootFolderId = null;
        let formsFolderId = null; // Google Drive folder ID for form templates
        let formTemplates = {}; // Store form template file IDs
        let formImageCache = {}; // In-memory cache for form images from Drive
        let formsDataFileId = null; // Google Drive file ID for forms metadata
        let excelTemplates = {}; // Store Excel template data
        let excelDataFileId = null; // Google Drive file ID for Excel templates metadata
        let manualMode = false;
        let tokenClient = null;
        let accessToken = null;
        let gapiInited = false;
        let gisInited = false;
        let tokenRefreshTimer = null;
        let periodicRefreshTimer = null; // Timer for periodic token refresh
        let tokenHealthCheckTimer = null; // Timer for periodic token validation
        let refreshRetryCount = 0; // Track retry attempts
        const MAX_REFRESH_RETRIES = 3;
        const PERIODIC_REFRESH_INTERVAL = 45 * 60 * 1000; // 45 minutes
        const HEALTH_CHECK_INTERVAL = 10 * 60 * 1000; // 10 minutes
        let dataFileId = null; // Google Drive file ID for synced data
        let isSyncing = false; // Prevent concurrent syncs
        let lastSyncTime = null; // Track last successful sync
        let customerBackup = null; // Backup of customer data for cancel functionality

        // Token Storage and Management Functions
        function saveTokenToStorage(token, expiresIn) {
            const expiryTime = Date.now() + (expiresIn * 1000);
            localStorage.setItem('googleAccessToken', token);
            localStorage.setItem('googleTokenExpiry', expiryTime.toString());
            console.log('Token saved to localStorage, expires in', expiresIn, 'seconds');
        }

        function getTokenFromStorage() {
            const token = localStorage.getItem('googleAccessToken');
            const expiry = localStorage.getItem('googleTokenExpiry');

            if (!token || !expiry) {
                return null;
            }

            const expiryTime = parseInt(expiry);
            const now = Date.now();

            // Check if token is still valid (with 5 minute buffer)
            if (now >= expiryTime - (5 * 60 * 1000)) {
                console.log('Token expired or expiring soon');
                clearTokenFromStorage();
                return null;
            }

            console.log('Valid token found in storage');
            return { token, expiryTime };
        }

        function clearTokenFromStorage() {
            localStorage.removeItem('googleAccessToken');
            localStorage.removeItem('googleTokenExpiry');
            localStorage.removeItem('tokenExpiry'); // Clean up old key
            console.log('Token cleared from storage');
        }

        function scheduleTokenRefresh(expiresIn) {
            // Clear any existing timer
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
            }

            // Schedule refresh 5 minutes before expiry
            const refreshTime = (expiresIn - 300) * 1000; // 5 minutes before expiry

            if (refreshTime > 0) {
                console.log('Token refresh scheduled in', refreshTime / 1000, 'seconds');
                tokenRefreshTimer = setTimeout(() => {
                    console.log('Auto-refreshing token...');
                    refreshTokenSilently();
                }, refreshTime);
            }
        }

        function refreshTokenSilently(isRetry = false) {
            if (!tokenClient) {
                console.error('Token client not initialized');
                return;
            }

            try {
                console.log(`Attempting token refresh (retry count: ${refreshRetryCount})...`);
                // Try to refresh silently (no user prompt)
                tokenClient.requestAccessToken({ prompt: '' });
                // Reset retry count on successful attempt
                refreshRetryCount = 0;
            } catch (error) {
                console.error('Silent token refresh failed:', error);

                // Retry logic
                if (!isRetry && refreshRetryCount < MAX_REFRESH_RETRIES) {
                    refreshRetryCount++;
                    console.log(`Retrying token refresh (attempt ${refreshRetryCount}/${MAX_REFRESH_RETRIES})...`);
                    setTimeout(() => refreshTokenSilently(true), 5000); // Retry after 5 seconds
                    return;
                }

                // If all retries failed, user will need to re-authenticate manually
                console.error('All token refresh attempts failed');
                clearTokenFromStorage();
                accessToken = null;
                isSignedIn = false;
                updateSigninStatus(false);
                alert('Your Google Drive session has expired. Please reconnect.');

                // Clear all timers
                stopAllRefreshTimers();
            }
        }

        function startPeriodicRefresh() {
            // Clear any existing timer
            if (periodicRefreshTimer) {
                clearInterval(periodicRefreshTimer);
            }

            console.log(`Starting periodic token refresh every ${PERIODIC_REFRESH_INTERVAL / 60000} minutes`);
            periodicRefreshTimer = setInterval(() => {
                console.log('Periodic token refresh triggered...');
                refreshTokenSilently();
            }, PERIODIC_REFRESH_INTERVAL);
        }

        function startTokenHealthCheck() {
            // Clear any existing timer
            if (tokenHealthCheckTimer) {
                clearInterval(tokenHealthCheckTimer);
            }

            console.log(`Starting token health check every ${HEALTH_CHECK_INTERVAL / 60000} minutes`);
            tokenHealthCheckTimer = setInterval(() => {
                checkTokenHealth();
            }, HEALTH_CHECK_INTERVAL);
        }

        async function checkTokenHealth() {
            if (!isSignedIn || !accessToken) {
                console.log('Not signed in, skipping health check');
                return;
            }

            try {
                console.log('Checking token health...');
                // Make a lightweight API call to verify token is still valid
                const response = await gapi.client.drive.about.get({
                    fields: 'user'
                });

                if (response && response.result) {
                    console.log('Token health check passed');
                } else {
                    console.warn('Token health check returned unexpected result');
                }
            } catch (error) {
                console.error('Token health check failed:', error);

                // If we get a 401, the token is invalid
                if (error.status === 401) {
                    console.log('Token is invalid, attempting refresh...');
                    refreshTokenSilently();
                }
            }
        }

        function stopAllRefreshTimers() {
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
                tokenRefreshTimer = null;
            }
            if (periodicRefreshTimer) {
                clearInterval(periodicRefreshTimer);
                periodicRefreshTimer = null;
            }
            if (tokenHealthCheckTimer) {
                clearInterval(tokenHealthCheckTimer);
                tokenHealthCheckTimer = null;
            }
            console.log('All refresh timers stopped');
        }

        function setAccessToken(token, expiresIn) {
            accessToken = token;
            gapi.client.setToken({ access_token: token });
            saveTokenToStorage(token, expiresIn);
            scheduleTokenRefresh(expiresIn);

            // Start periodic refresh and health check timers
            startPeriodicRefresh();
            startTokenHealthCheck();

            console.log('Token set with periodic refresh and health monitoring enabled');
        }

        function restoreTokenFromStorage() {
            const tokenData = getTokenFromStorage();

            if (tokenData) {
                accessToken = tokenData.token;
                gapi.client.setToken({ access_token: tokenData.token });
                isSignedIn = true;

                // Calculate remaining time
                const remainingTime = Math.floor((tokenData.expiryTime - Date.now()) / 1000);
                scheduleTokenRefresh(remainingTime);

                // Start periodic refresh and health check timers
                startPeriodicRefresh();
                startTokenHealthCheck();

                updateSigninStatus(true);
                console.log('Session restored from storage with periodic refresh and health monitoring');
                return true;
            }

            return false;
        }

        // Google Drive Data Sync Functions
        const DATA_FILE_NAME = 'BYD_CRM_Data.json';

        // Get or create the data file in Google Drive
        async function getOrCreateDataFile() {
            if (!isSignedIn || !rootFolderId) {
                console.log('Cannot sync: not signed in or no root folder');
                return null;
            }

            try {
                // Search for existing data file
                const searchResponse = await gapi.client.drive.files.list({
                    q: `name='${DATA_FILE_NAME}' and '${rootFolderId}' in parents and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name, modifiedTime)'
                });

                if (searchResponse.result.files.length > 0) {
                    dataFileId = searchResponse.result.files[0].id;
                    console.log('Found existing data file:', dataFileId);
                    return dataFileId;
                }

                // Create new data file
                console.log('Creating new data file in Drive...');
                const fileMetadata = {
                    name: DATA_FILE_NAME,
                    mimeType: 'application/json',
                    parents: [rootFolderId]
                };

                const initialData = {
                    customers: [],
                    lastModified: new Date().toISOString(),
                    version: 1
                };

                const response = await gapi.client.drive.files.create({
                    resource: fileMetadata,
                    fields: 'id'
                });

                dataFileId = response.result.id;

                // Upload initial content
                await updateDataFile(initialData);

                console.log('Created new data file:', dataFileId);
                return dataFileId;
            } catch (error) {
                console.error('Error getting/creating data file:', error);
                return null;
            }
        }

        // Load data from Google Drive
        async function loadDataFromDrive() {
            if (!isSignedIn) {
                console.log('Not signed in, loading from localStorage only');
                return false;
            }

            if (isSyncing) {
                console.log('Sync already in progress');
                return false;
            }

            isSyncing = true;
            updateSyncStatus('syncing');

            try {
                // Ensure we have the data file
                if (!dataFileId) {
                    await getOrCreateDataFile();
                }

                if (!dataFileId) {
                    console.log('No data file available');
                    isSyncing = false;
                    updateSyncStatus('offline');
                    return false;
                }

                // Download file content
                const response = await gapi.client.drive.files.get({
                    fileId: dataFileId,
                    alt: 'media'
                });

                const driveData = response.result;
                console.log('‚úì Downloaded data from Drive:', driveData);

                if (driveData && driveData.customers) {
                    console.log('‚úì Drive has', driveData.customers.length, 'customers');

                    // Merge with local data if needed
                    const localData = localStorage.getItem('bydCRM');
                    const localCustomers = localData ? JSON.parse(localData) : [];
                    console.log('  Local cache has', localCustomers.length, 'customers');

                    // Use Drive data as source of truth, but preserve any local-only data
                    if (localCustomers.length > driveData.customers.length) {
                        console.log('‚ö†Ô∏è  Local has more data, merging...');
                        console.log('  Drive:', driveData.customers.length, 'Local:', localCustomers.length);
                        customers = mergeCustomerData(driveData.customers, localCustomers);
                        console.log('  Merged:', customers.length, 'customers');
                        // Save merged data back to Drive
                        await saveDataToDrive();
                    } else {
                        console.log('‚úì Using Drive data as source of truth');
                        customers = driveData.customers || [];
                    }

                    // Save to localStorage as cache
                    localStorage.setItem('bydCRM', JSON.stringify(customers));
                    lastSyncTime = new Date();

                    renderCustomerList();
                    updateStats();
                    updateSyncStatus('synced');

                    console.log('‚úì Data loaded from Drive:', customers.length, 'customers');
                    isSyncing = false;
                    return true;
                } else {
                    console.log('‚ö†Ô∏è  No customer data in Drive file');
                }

                isSyncing = false;
                updateSyncStatus('synced');
                return true;
            } catch (error) {
                console.error('Error loading data from Drive:', error);
                isSyncing = false;
                updateSyncStatus('error');

                // Fall back to localStorage
                const savedData = localStorage.getItem('bydCRM');
                if (savedData) {
                    customers = JSON.parse(savedData);
                    renderCustomerList();
                    updateStats();
                }

                return false;
            }
        }

        // Save data to Google Drive
        async function saveDataToDrive() {
            if (!isSignedIn) {
                console.log('Not signed in, saving to localStorage only');
                localStorage.setItem('bydCRM', JSON.stringify(customers));
                return false;
            }

            if (isSyncing) {
                console.log('Sync already in progress, will retry...');
                // Queue for retry
                setTimeout(() => saveDataToDrive(), 2000);
                return false;
            }

            isSyncing = true;
            updateSyncStatus('syncing');

            try {
                // Ensure we have the data file
                if (!dataFileId) {
                    await getOrCreateDataFile();
                }

                if (!dataFileId) {
                    console.log('No data file available');
                    isSyncing = false;
                    updateSyncStatus('offline');
                    localStorage.setItem('bydCRM', JSON.stringify(customers));
                    return false;
                }

                const dataToSave = {
                    customers: customers,
                    lastModified: new Date().toISOString(),
                    version: 1
                };

                await updateDataFile(dataToSave);

                // Also save to localStorage as cache
                localStorage.setItem('bydCRM', JSON.stringify(customers));
                lastSyncTime = new Date();
                updateSyncStatus('synced');

                console.log('Data saved to Drive:', customers.length, 'customers');
                isSyncing = false;
                return true;
            } catch (error) {
                console.error('Error saving data to Drive:', error);
                isSyncing = false;
                updateSyncStatus('error');

                // Still save locally
                localStorage.setItem('bydCRM', JSON.stringify(customers));
                return false;
            }
        }

        // Update the data file content in Drive
        async function updateDataFile(data) {
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";

            const contentType = 'application/json';
            const metadata = {
                mimeType: contentType
            };

            const multipartRequestBody =
                delimiter +
                'Content-Type: application/json\r\n\r\n' +
                JSON.stringify(metadata) +
                delimiter +
                'Content-Type: ' + contentType + '\r\n\r\n' +
                JSON.stringify(data, null, 2) +
                close_delim;

            const response = await fetch(
                `https://www.googleapis.com/upload/drive/v3/files/${dataFileId}?uploadType=multipart`,
                {
                    method: 'PATCH',
                    headers: new Headers({
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                    }),
                    body: multipartRequestBody
                }
            );

            if (!response.ok) {
                throw new Error('Failed to update data file: ' + response.statusText);
            }

            return response.json();
        }

        // Merge customer data (conflict resolution)
        function mergeCustomerData(driveCustomers, localCustomers) {
            const merged = [...driveCustomers];
            const driveIds = new Set(driveCustomers.map(c => c.id));

            // Add any local customers that aren't in Drive
            for (const localCustomer of localCustomers) {
                if (!driveIds.has(localCustomer.id)) {
                    console.log('Adding local-only customer:', localCustomer.name);
                    merged.push(localCustomer);
                }
            }

            return merged;
        }

        // Update sync status indicator in UI
        function updateSyncStatus(status) {
            const statusElement = document.getElementById('syncStatus');
            if (!statusElement) return;

            const statusConfig = {
                'syncing': { icon: 'üîÑ', text: 'Syncing...', color: '#3498db' },
                'synced': { icon: '‚úì', text: 'Synced', color: '#27ae60' },
                'offline': { icon: 'üì¥', text: 'Offline', color: '#95a5a6' },
                'error': { icon: '‚ö†Ô∏è', text: 'Sync Error', color: '#e74c3c' }
            };

            const config = statusConfig[status] || statusConfig['offline'];
            statusElement.innerHTML = `<span style="color: ${config.color}">${config.icon} ${config.text}</span>`;

            if (lastSyncTime && status === 'synced') {
                const timeAgo = Math.floor((new Date() - lastSyncTime) / 1000);
                if (timeAgo < 60) {
                    statusElement.innerHTML += ` <small style="color: #7f8c8d">(just now)</small>`;
                }
            }
        }

        // Document folder categories
        const documentFolders = [
            { id: 'nirc_fin', name: 'NIRC_FIN' },
            { id: 'test_drive', name: 'Test_Drive' },
            { id: 'vsa', name: 'VSA' },
            { id: 'trade_in', name: 'Trade_In' },
            { id: 'pdpa_coe', name: 'PDPA_COE_Bidding' },
            { id: 'other', name: 'Other_Documents' }
        ];

        // Document checklist template
        const documentChecklist = [
            { id: 'ic_copy', name: 'IC Copy (Front & Back)', required: true },
            { id: 'nirc_fin', name: 'NIRC/FIN', required: true },
            { id: 'driving_license', name: 'Driving License Copy', required: true },
            { id: 'contact_form', name: 'Customer Contact Form', required: true },
            { id: 'quotation', name: 'Price Quotation', required: true },
            { id: 'pdpa_coe', name: 'PDPA & COE Bidding', required: true },
            { id: 'test_drive', name: 'Test Drive Agreement Form', required: true },
            { id: 'vsa', name: 'VSA (Vehicle Sales Agreement)', required: true },
            { id: 'coe_deposit_receipt', name: 'COE Deposit Receipt ($16,350)', required: true },
            { id: 'insurance_payment', name: 'Insurance Payment Receipt ($1,500-$3,000)', required: true },
            { id: 'product_specs', name: 'Product Specifications', required: false },
            { id: 'finance_application', name: 'Finance Application Form', required: false },
            { id: 'finance_approval', name: 'Finance Approval Letter (if bank loan)', required: false },
            { id: 'admin_fee_receipt', name: 'Admin Fee Receipt ($500 if no bank loan)', required: false },
            { id: 'first_installment', name: 'First Month Installment (if no bank loan)', required: false },
            { id: 'trade_in', name: 'Trade In (if required)', required: false },
            { id: 'log_card', name: 'Vehicle Log Card (if trade-in)', required: false }
        ];

        // Document classification patterns - maps keywords to document types
        // Patterns are checked in order - more specific patterns first!
        const documentClassificationPatterns = {
            // Financial documents (check these first to avoid "fin" matching FIN/NIRC)
            'finance_application': {
                folderId: 'other',
                checklistId: 'finance_application',
                keywords: ['finance application', 'loan application', 'bank application', 'credit application', 'hire purchase'],
                excludeKeywords: [],
                displayName: 'Finance Application',
                priority: 1
            },
            'finance_approval': {
                folderId: 'other',
                checklistId: 'finance_approval',
                keywords: ['finance approval', 'loan approval', 'bank approval', 'credit approval', 'approval letter'],
                excludeKeywords: [],
                displayName: 'Finance Approval',
                priority: 1
            },
            'insurance': {
                folderId: 'other',
                checklistId: 'insurance_payment',
                keywords: ['insurance', 'coverage', 'policy', 'premium'],
                excludeKeywords: [],
                displayName: 'Insurance',
                priority: 1
            },
            'receipt': {
                folderId: 'other',
                checklistId: null,
                keywords: ['receipt', 'payment receipt', 'deposit receipt', 'admin fee receipt'],
                excludeKeywords: [],
                displayName: 'Receipt',
                priority: 1
            },

            // Specific ID documents (higher priority, more specific)
            'ic_copy': {
                folderId: 'nirc_fin',
                checklistId: 'ic_copy',
                keywords: ['ic copy', 'ic front', 'ic back', 'identity card copy', 'nric copy', 'nric front', 'nric back'],
                excludeKeywords: ['application', 'form', 'loan', 'finance'],
                displayName: 'IC Copy',
                priority: 2
            },
            'nirc_fin': {
                folderId: 'nirc_fin',
                checklistId: 'nirc_fin',
                keywords: ['nirc', 'nric', 'fin number', 'fin card', 'foreign identification'],
                excludeKeywords: ['application', 'form', 'loan', 'finance', 'bank'],
                displayName: 'NIRC/FIN',
                priority: 2
            },
            'driving_license': {
                folderId: 'test_drive',
                checklistId: 'driving_license',
                keywords: ['driving license', 'driving licence', 'driver license', 'driver licence', 'driving permit'],
                excludeKeywords: ['application', 'form'],
                displayName: 'Driving License',
                priority: 2
            },

            // Vehicle documents
            'vsa': {
                folderId: 'vsa',
                checklistId: 'vsa',
                keywords: ['vsa', 'vehicle sales agreement', 'sales agreement', 'purchase agreement'],
                excludeKeywords: [],
                displayName: 'VSA',
                priority: 3
            },
            'test_drive': {
                folderId: 'test_drive',
                checklistId: 'test_drive',
                keywords: ['test drive', 'testdrive', 'test-drive', 'trial drive'],
                excludeKeywords: [],
                displayName: 'Test Drive',
                priority: 3
            },
            'trade_in': {
                folderId: 'trade_in',
                checklistId: 'trade_in',
                keywords: ['trade in', 'tradein', 'trade-in', 'vehicle exchange', 'car exchange'],
                excludeKeywords: [],
                displayName: 'Trade In',
                priority: 3
            },
            'log_card': {
                folderId: 'trade_in',
                checklistId: 'log_card',
                keywords: ['log card', 'logcard', 'vehicle log'],
                excludeKeywords: [],
                displayName: 'Vehicle Log Card',
                priority: 3
            },

            // Forms and agreements
            'pdpa_coe': {
                folderId: 'pdpa_coe',
                checklistId: 'pdpa_coe',
                keywords: ['pdpa', 'coe', 'coe bidding', 'consent form', 'data protection'],
                excludeKeywords: [],
                displayName: 'PDPA & COE Bidding',
                priority: 4
            },
            'quotation': {
                folderId: 'other',
                checklistId: 'quotation',
                keywords: ['quotation', 'quote', 'price quotation', 'pricing'],
                excludeKeywords: [],
                displayName: 'Quotation',
                priority: 4
            },
            'contact_form': {
                folderId: 'other',
                checklistId: 'contact_form',
                keywords: ['contact form', 'customer form', 'customer information'],
                excludeKeywords: [],
                displayName: 'Contact Form',
                priority: 4
            }
        };

        // Auto-classify document based on filename
        function classifyDocument(fileName) {
            const lowerFileName = fileName.toLowerCase();

            // Convert patterns object to array and sort by priority
            const patternsArray = Object.entries(documentClassificationPatterns).map(([key, pattern]) => ({
                key,
                ...pattern
            })).sort((a, b) => (a.priority || 999) - (b.priority || 999));

            let bestMatch = null;
            let bestMatchLength = 0;

            // Try to match each pattern in priority order
            for (const pattern of patternsArray) {
                // Check if any exclude keywords are present
                const hasExcludeKeyword = pattern.excludeKeywords.some(exclude =>
                    lowerFileName.includes(exclude.toLowerCase())
                );

                if (hasExcludeKeyword) {
                    continue; // Skip this pattern if exclude keyword found
                }

                // Check for keyword matches
                for (const keyword of pattern.keywords) {
                    const lowerKeyword = keyword.toLowerCase();
                    if (lowerFileName.includes(lowerKeyword)) {
                        // Prefer longer matches (more specific)
                        if (lowerKeyword.length > bestMatchLength) {
                            bestMatch = {
                                folderId: pattern.folderId,
                                checklistId: pattern.checklistId,
                                displayName: pattern.displayName,
                                confidence: 'high',
                                matchedKeyword: keyword
                            };
                            bestMatchLength = lowerKeyword.length;
                        }
                    }
                }
            }

            // Return best match if found
            if (bestMatch) {
                console.log(`üìÑ Classified "${fileName}" as "${bestMatch.displayName}" (matched: "${bestMatch.matchedKeyword}")`);
                return bestMatch;
            }

            // Default to other documents
            console.log(`üìÑ "${fileName}" - no specific match, using Other Documents`);
            return {
                folderId: 'other',
                checklistId: null,
                displayName: 'Other Documents',
                confidence: 'low'
            };
        }

        // Initialize GAPI client for Drive API
        function gapiLoaded() {
            console.log('GAPI loaded, initializing client...');
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        discoveryDocs: DISCOVERY_DOCS,
                    });
                    gapiInited = true;
                    console.log('GAPI client initialized successfully');
                    maybeEnableButtons();
                } catch (error) {
                    console.error('Error initializing GAPI client:', error);
                    showSetupError('Error initializing Google Drive API: ' + error.message);
                }
            });
        }

        // Initialize GIS (Google Identity Services) for authentication
        function gisLoaded() {
            console.log('GIS loaded, creating token client...');

            if (!CLIENT_ID) {
                showSetupError('No Client ID configured. Please configure your Google OAuth Client ID.');
                return;
            }

            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (response) => {
                        if (response.error !== undefined) {
                            console.error('Token response error:', response);
                            showSetupError('Authentication error: ' + response.error);
                            return;
                        }
                        console.log('Access token received');

                        // Store token and set up auto-refresh
                        const expiresIn = response.expires_in || 3600;
                        setAccessToken(response.access_token, expiresIn);

                        isSignedIn = true;
                        updateSigninStatus(true);

                        // Get or create root folder
                        getRootFolder();
                    },
                });
                gisInited = true;
                console.log('GIS token client initialized successfully');
                maybeEnableButtons();
            } catch (error) {
                console.error('Error initializing GIS:', error);
                showSetupError('Error initializing authentication: ' + error.message);
            }
        }

        // Enable buttons when both libraries are loaded
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                console.log('Both GAPI and GIS initialized - ready to authenticate');
                document.getElementById('authButton').disabled = false;

                // Try to restore token from storage
                if (restoreTokenFromStorage()) {
                    console.log('Successfully restored session from storage');
                    // Get or create root folder
                    getRootFolder();
                } else {
                    console.log('No valid token in storage, user needs to authenticate');
                }
            }
        }

        // Show setup error with detailed message
        function showSetupError(message) {
            const authButton = document.getElementById('authButton');
            const authButtonText = document.getElementById('authButtonText');

            authButton.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
            authButton.style.borderColor = 'rgba(231, 76, 60, 0.5)';
            authButton.title = 'Connection Error: ' + message;
            authButtonText.textContent = 'Error';

            console.error('Google Drive setup error:', message);
        }

        // Update signin status
        function updateSigninStatus(signedIn) {
            isSignedIn = signedIn;
            const authButton = document.getElementById('authButton');
            const authButtonText = document.getElementById('authButtonText');

            if (signedIn) {
                authButton.classList.add('connected');
                authButton.title = 'Connected to Google Drive - Click to disconnect';
                authButtonText.textContent = 'Connected';
                authButton.onclick = handleSignoutClick;

                // Get or create root folder
                getRootFolder();
            } else {
                authButton.classList.remove('connected');
                authButton.title = 'Click to connect to Google Drive';
                authButtonText.textContent = 'Google Drive';
                authButton.onclick = handleAuthClick;
            }
        }

        // Handle auth click
        function handleAuthClick() {
            console.log('Attempting to sign in to Google...');

            // Check if we're on file:// protocol
            if (window.location.protocol === 'file:') {
                alert('ERROR: Google OAuth does not work with file:// protocol.\n\n' +
                      'You need to:\n' +
                      '1. Host this file on a web server (even localhost works)\n' +
                      '2. For local testing, use: python -m http.server 8000\n' +
                      '3. Then open: http://localhost:8000\n\n' +
                      'OR upload to GitHub Pages or any web hosting service.');
                return;
            }

            if (!tokenClient) {
                alert('Authentication not initialized yet. Please wait a moment and try again.');
                return;
            }

            try {
                // Request an access token
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } catch (error) {
                console.error('Exception during sign-in:', error);
                alert('Error during sign-in: ' + error.message);
            }
        }

        // Handle signout click
        function handleSignoutClick() {
            if (confirm('Disconnect from Google Drive? Your files will remain in Drive.')) {
                // Stop all refresh timers
                stopAllRefreshTimers();

                if (accessToken) {
                    // Revoke the token
                    google.accounts.oauth2.revoke(accessToken, () => {
                        console.log('Token revoked');
                    });
                }

                accessToken = null;
                isSignedIn = false;
                refreshRetryCount = 0;
                clearTokenFromStorage();
                updateSigninStatus(false);
            }
        }

        // Get or create root folder
        async function getRootFolder() {
            try {
                // Search for existing folder
                const response = await gapi.client.drive.files.list({
                    q: "name='BYD_MotorEast_Customers' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                    spaces: 'drive',
                    fields: 'files(id, name)'
                });

                if (response.result.files.length > 0) {
                    rootFolderId = response.result.files[0].id;
                } else {
                    // Create root folder
                    const createResponse = await gapi.client.drive.files.create({
                        resource: {
                            name: 'BYD_MotorEast_Customers',
                            mimeType: 'application/vnd.google-apps.folder'
                        },
                        fields: 'id'
                    });
                    rootFolderId = createResponse.result.id;
                }

                // Load data from Drive after root folder is ready
                await loadData();

                // Load forms after root folder is ready
                await getOrCreateFormsFolder();
                await loadFormTemplates();

                // Refresh customer view if one is selected
                if (selectedCustomerId) {
                    displayCustomerDetails(selectedCustomerId);
                }

                updateStats();
            } catch (error) {
                console.error('Error getting root folder:', error);
            }
        }

        // Create customer folder
        async function createCustomerFolder(customerName, customerId) {
            if (!isSignedIn) {
                alert('Please connect to Google Drive first.');
                return null;
            }

            // Ensure root folder is ready
            if (!rootFolderId) {
                console.log('Root folder not ready, fetching...');
                try {
                    await getRootFolder();
                    if (!rootFolderId) {
                        alert('Failed to initialize Google Drive folder. Please try reconnecting.');
                        return null;
                    }
                } catch (error) {
                    console.error('Error getting root folder:', error);
                    alert('Failed to access Google Drive. Error: ' + error.message);
                    return null;
                }
            }

            try {
                const folderName = customerName.replace(/\s+/g, '_');

                // Check if folder exists
                const searchResponse = await gapi.client.drive.files.list({
                    q: `name='${folderName}' and '${rootFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)'
                });

                if (searchResponse.result.files.length > 0) {
                    const folderId = searchResponse.result.files[0].id;
                    console.log('Folder already exists, using existing folder:', folderId);

                    // Update customer record
                    const customer = customers.find(c => c.id === customerId);
                    if (customer && !customer.driveFolderId) {
                        customer.driveFolderId = folderId;
                        saveData();
                    }

                    // Create document subfolders
                    await createDocumentSubfolders(folderId, customerId);
                    alert('Folder created successfully for ' + customerName);
                    return folderId;
                }

                // Create folder
                console.log('Creating new folder:', folderName);
                const response = await gapi.client.drive.files.create({
                    resource: {
                        name: folderName,
                        mimeType: 'application/vnd.google-apps.folder',
                        parents: [rootFolderId]
                    },
                    fields: 'id, webViewLink'
                });

                console.log('Folder created:', response.result.id);

                const customer = customers.find(c => c.id === customerId);
                if (customer) {
                    customer.driveFolderId = response.result.id;
                    customer.driveFolderLink = response.result.webViewLink;
                    saveData();
                }

                // Create document subfolders
                await createDocumentSubfolders(response.result.id, customerId);

                alert('Folder created successfully for ' + customerName);
                return response.result.id;
            } catch (error) {
                console.error('Error creating folder:', error);

                // Provide specific error messages
                if (error.status === 401) {
                    alert('Your Google Drive session has expired. Please reconnect.');
                    clearTokenFromStorage();
                    accessToken = null;
                    isSignedIn = false;
                    updateSigninStatus(false);
                } else if (error.status === 403) {
                    alert('Permission denied. Please ensure you have granted the necessary permissions.');
                } else {
                    alert('Failed to create folder: ' + (error.message || 'Unknown error'));
                }

                return null;
            }
        }

        // Create document subfolders for organizing files
        async function createDocumentSubfolders(customerFolderId, customerId) {
            if (!isSignedIn || !customerFolderId) return;

            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            // Initialize document folders map if not exists
            if (!customer.documentFolders) {
                customer.documentFolders = {};
            }

            try {
                // Create all subfolders in parallel for faster performance
                const folderPromises = documentFolders.map(async (folder) => {
                    // Check if subfolder already exists
                    const searchResponse = await gapi.client.drive.files.list({
                        q: `name='${folder.name}' and '${customerFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                        spaces: 'drive',
                        fields: 'files(id, name)'
                    });

                    let subfolderId;
                    if (searchResponse.result.files.length > 0) {
                        subfolderId = searchResponse.result.files[0].id;
                    } else {
                        // Create subfolder
                        const createResponse = await gapi.client.drive.files.create({
                            resource: {
                                name: folder.name,
                                mimeType: 'application/vnd.google-apps.folder',
                                parents: [customerFolderId]
                            },
                            fields: 'id'
                        });
                        subfolderId = createResponse.result.id;
                    }

                    return { folderId: folder.id, subfolderId };
                });

                // Wait for all folder operations to complete
                const results = await Promise.allSettled(folderPromises);

                // Store successful subfolder IDs
                results.forEach((result, index) => {
                    if (result.status === 'fulfilled' && result.value) {
                        customer.documentFolders[result.value.folderId] = result.value.subfolderId;
                    } else if (result.status === 'rejected') {
                        console.error(`Failed to create folder ${documentFolders[index].name}:`, result.reason);
                    }
                });

                saveData();
            } catch (error) {
                console.error('Error creating document subfolders:', error);
            }
        }

        // Handle folder creation button click with UI feedback
        let isCreatingFolder = false; // Prevent duplicate operations

        async function handleCreateFolderClick(customerName, customerId) {
            // Prevent duplicate clicks
            if (isCreatingFolder) {
                console.log('Folder creation already in progress...');
                return;
            }

            isCreatingFolder = true;
            const customer = customers.find(c => c.id === customerId);

            // Check if folder already exists
            if (customer && customer.driveFolderId) {
                alert(`Folder already exists for ${customerName}!`);
                isCreatingFolder = false;
                return;
            }

            try {
                console.log('Starting folder creation for:', customerName);

                // Create the folder
                const folderId = await createCustomerFolder(customerName, customerId);

                if (folderId) {
                    console.log('Folder created successfully:', folderId);
                    // Refresh the customer view
                    selectCustomer(customerId);
                } else {
                    console.error('Folder creation returned null');
                }
            } catch (error) {
                console.error('Error in handleCreateFolderClick:', error);
                alert('An unexpected error occurred: ' + error.message);
            } finally {
                isCreatingFolder = false;
            }
        }

        // Upload file to Drive
        async function uploadFileToDrive(file, customerId, fileName, documentType = 'other') {
            if (!isSignedIn) {
                alert('Please connect to Google Drive first');
                return null;
            }

            const customer = customers.find(c => c.id === customerId);
            if (!customer) return null;

            // Ensure folder exists
            if (!customer.driveFolderId) {
                await createCustomerFolder(customer.name, customerId);
            }

            // Ensure document subfolders exist
            if (!customer.documentFolders || !customer.documentFolders[documentType]) {
                await createDocumentSubfolders(customer.driveFolderId, customerId);
            }

            try {
                // Determine target folder (subfolder or main customer folder)
                const targetFolderId = customer.documentFolders && customer.documentFolders[documentType]
                    ? customer.documentFolders[documentType]
                    : customer.driveFolderId;

                const metadata = {
                    name: fileName,
                    parents: [targetFolderId]
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);

                const response = await fetch(
                    'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,mimeType,size,webViewLink,createdTime',
                    {
                        method: 'POST',
                        headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                        body: form
                    }
                );

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error uploading file:', error);
                alert('Error uploading file to Google Drive');
                return null;
            }
        }

        // Get files from customer folder and all subfolders
        async function getCustomerFiles(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer || !customer.driveFolderId || !isSignedIn) {
                return [];
            }

            try {
                // Fetch all folders in parallel for faster performance
                const fetchPromises = [];

                // Get files from main customer folder
                fetchPromises.push(
                    gapi.client.drive.files.list({
                        q: `'${customer.driveFolderId}' in parents and mimeType != 'application/vnd.google-apps.folder' and trashed=false`,
                        spaces: 'drive',
                        fields: 'files(id, name, mimeType, size, webViewLink, createdTime)',
                        orderBy: 'createdTime desc'
                    })
                );

                // Get files from all document subfolders in parallel
                if (customer.documentFolders) {
                    for (const folderId of Object.values(customer.documentFolders)) {
                        fetchPromises.push(
                            gapi.client.drive.files.list({
                                q: `'${folderId}' in parents and mimeType != 'application/vnd.google-apps.folder' and trashed=false`,
                                spaces: 'drive',
                                fields: 'files(id, name, mimeType, size, webViewLink, createdTime)',
                                orderBy: 'createdTime desc'
                            })
                        );
                    }
                }

                // Wait for all fetch operations to complete
                const results = await Promise.allSettled(fetchPromises);

                // Combine all files from successful requests
                let allFiles = [];
                results.forEach(result => {
                    if (result.status === 'fulfilled' && result.value.result.files) {
                        allFiles = allFiles.concat(result.value.result.files);
                    } else if (result.status === 'rejected') {
                        console.error('Failed to fetch files:', result.reason);
                    }
                });

                // Sort all files by creation time (newest first)
                allFiles.sort((a, b) => new Date(b.createdTime) - new Date(a.createdTime));

                return allFiles;
            } catch (error) {
                console.error('Error getting files:', error);
                return [];
            }
        }

        // Delete file from Drive
        async function deleteFileFromDrive(fileId) {
            if (!isSignedIn) return false;

            try {
                await gapi.client.drive.files.delete({
                    fileId: fileId
                });
                return true;
            } catch (error) {
                console.error('Error deleting file:', error);
                return false;
            }
        }

        // Open customer folder in local file explorer
        function openLocalFolder(customerName) {
            // Hardcoded Google Drive path
            const drivePath = 'G:\\My Drive\\BYD_MotorEast_Customers (2)';

            // Construct the full path to customer folder
            const folderName = customerName.replace(/\s+/g, '_');
            const fullPath = drivePath + '\\' + folderName;

            // Copy path to clipboard and show it to user
            if (navigator.clipboard) {
                navigator.clipboard.writeText(fullPath).then(() => {
                    alert(
                        'üìÇ Customer Folder Path\n\n' +
                        fullPath + '\n\n' +
                        '‚úÖ Path copied to clipboard!\n\n' +
                        'Opening in File Explorer...\n' +
                        'If it doesn\'t open automatically, paste the path (Ctrl+V) in File Explorer\'s address bar.'
                    );
                }).catch(() => {
                    alert(
                        'üìÇ Customer Folder Path\n\n' +
                        fullPath + '\n\n' +
                        'Copy this path and paste it in File Explorer\'s address bar (Ctrl+L to focus address bar).'
                    );
                });
            } else {
                alert(
                    'üìÇ Customer Folder Path\n\n' +
                    fullPath + '\n\n' +
                    'Copy this path and paste it in File Explorer\'s address bar.'
                );
            }

            // Try to open using file explorer
            try {
                // Create a temporary link element
                const link = document.createElement('a');
                link.href = 'file:///' + fullPath.replace(/\\/g, '/');
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.log('Could not open folder directly (expected browser security):', error);
            }
        }

        // Get file icon
        function getFileIcon(mimeType) {
            if (mimeType.includes('pdf')) return 'üìÑ';
            if (mimeType.includes('image')) return 'üñºÔ∏è';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'üìù';
            if (mimeType.includes('spreadsheet') || mimeType.includes('excel')) return 'üìä';
            if (mimeType.includes('folder')) return 'üìÅ';
            return 'üìé';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (!bytes) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Load data (tries Drive first, falls back to localStorage)
        async function loadData() {
            if (isSignedIn && rootFolderId) {
                // Try to load from Drive
                const success = await loadDataFromDrive();
                if (success) {
                    return;
                }
            }

            // Fall back to localStorage
            const savedData = localStorage.getItem('bydCRM');
            if (savedData) {
                customers = JSON.parse(savedData);
                renderCustomerList();
                updateStats();
                updateSyncStatus('offline');
            }
        }

        // Save data (saves to both Drive and localStorage)
        async function saveData() {
            // Save to Drive (which also saves to localStorage)
            await saveDataToDrive();
        }

        // Force sync from Drive (clears local cache and reloads)
        async function forceSyncFromDrive() {
            if (!isSignedIn) {
                alert('Please connect to Google Drive first.');
                return;
            }

            if (!rootFolderId) {
                alert('Google Drive not ready. Please wait...');
                return;
            }

            if (confirm('This will reload all data from Google Drive and replace any local changes. Continue?')) {
                console.log('Force syncing from Drive...');

                // Clear local cache
                localStorage.removeItem('bydCRM');
                customers = [];

                // Force reload from Drive
                const success = await loadDataFromDrive();

                if (success) {
                    alert('Data synced successfully from Google Drive!');
                } else {
                    alert('Failed to sync from Google Drive. Check console for errors.');
                }
            }
        }

        // Update statistics
        // Cache for file counts to avoid repeated API calls
        let statsCache = {
            totalFiles: 0,
            lastUpdate: 0,
            cacheTimeout: 30000 // 30 seconds cache
        };

        async function updateStats(forceRefresh = false) {
            document.getElementById('totalCustomers').textContent = customers.length;

            const activeDeals = customers.filter(c => !c.dealClosed).length;
            document.getElementById('activeDeals').textContent = activeDeals;

            // Count folders
            const foldersCreated = customers.filter(c => c.driveFolderId).length;
            document.getElementById('totalFolders').textContent = foldersCreated;

            // Count files with caching and parallel execution
            if (isSignedIn && rootFolderId) {
                const now = Date.now();
                const cacheValid = !forceRefresh && (now - statsCache.lastUpdate) < statsCache.cacheTimeout;

                if (cacheValid) {
                    // Use cached value
                    document.getElementById('totalFiles').textContent = statsCache.totalFiles;
                } else {
                    try {
                        // Show loading indicator
                        document.getElementById('totalFiles').textContent = '...';

                        // Fetch file counts for all customers in parallel
                        const customersWithFolders = customers.filter(c => c.driveFolderId);
                        const filePromises = customersWithFolders.map(customer =>
                            getCustomerFiles(customer.id)
                        );

                        const results = await Promise.allSettled(filePromises);

                        // Count total files from successful requests
                        let totalFiles = 0;
                        results.forEach(result => {
                            if (result.status === 'fulfilled' && result.value) {
                                totalFiles += result.value.length;
                            }
                        });

                        // Update cache
                        statsCache.totalFiles = totalFiles;
                        statsCache.lastUpdate = now;

                        document.getElementById('totalFiles').textContent = totalFiles;
                    } catch (error) {
                        console.error('Error updating stats:', error);
                        document.getElementById('totalFiles').textContent = '?';
                    }
                }
            } else {
                document.getElementById('totalFiles').textContent = '0';
            }
        }

        // Helper function to invalidate stats cache when files change
        function invalidateStatsCache() {
            statsCache.lastUpdate = 0;
        }

        // Open add customer modal
        function openAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.add('active');
        }

        // Close add customer modal
        function closeAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.remove('active');
            document.getElementById('newCustomerName').value = '';
            document.getElementById('newCustomerPhone').value = '';
            document.getElementById('newCustomerEmail').value = '';
            document.getElementById('newCustomerNRIC').value = '';
            document.getElementById('newCustomerOccupation').value = '';
            document.getElementById('newCustomerDOB').value = '';
            document.getElementById('newCustomerSalesConsultant').value = '';
            document.getElementById('newCustomerVsaNo').value = '';
            document.getElementById('newCustomerAddress').value = '';
            document.getElementById('newCustomerAddressContinue').value = '';
            document.getElementById('newCustomerModel').value = '';
            document.getElementById('newCustomerNotes').value = '';

            // Reset progress UI
            const submitBtn = document.getElementById('addCustomerSubmitBtn');
            const progressDiv = document.getElementById('addCustomerProgress');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Customer';
            }
            if (progressDiv) {
                progressDiv.style.display = 'none';
            }
        }

        // Forms Management Functions

        // Open forms modal
        async function openFormsModal() {
            const modal = document.getElementById('formsModal');
            modal.classList.add('active');

            // Check if signed in
            if (!isSignedIn) {
                document.getElementById('formsNotConnected').style.display = 'block';
                document.getElementById('formsConnected').style.display = 'none';
            } else {
                document.getElementById('formsNotConnected').style.display = 'none';
                document.getElementById('formsConnected').style.display = 'block';

                // Ensure forms folder exists
                await getOrCreateFormsFolder();

                // Load form templates
                await loadFormTemplates();
                displayFormsList();
            }
        }

        // Close forms modal
        function closeFormsModal() {
            document.getElementById('formsModal').classList.remove('active');
            document.getElementById('formFileInput').value = '';
        }

        // Get or create forms folder in Google Drive
        async function getOrCreateFormsFolder() {
            if (!isSignedIn || !rootFolderId) {
                console.log('Cannot create forms folder: not signed in or no root folder');
                return null;
            }

            try {
                // Check if Forms folder exists
                const searchResponse = await gapi.client.drive.files.list({
                    q: `name='Forms' and '${rootFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)'
                });

                if (searchResponse.result.files.length > 0) {
                    formsFolderId = searchResponse.result.files[0].id;
                    console.log('Forms folder found:', formsFolderId);
                } else {
                    // Create Forms folder
                    console.log('Creating Forms folder...');
                    const createResponse = await gapi.client.drive.files.create({
                        resource: {
                            name: 'Forms',
                            mimeType: 'application/vnd.google-apps.folder',
                            parents: [rootFolderId]
                        },
                        fields: 'id'
                    });
                    formsFolderId = createResponse.result.id;
                    console.log('Forms folder created:', formsFolderId);
                }

                return formsFolderId;
            } catch (error) {
                console.error('Error creating forms folder:', error);
                alert('Failed to create forms folder: ' + error.message);
                return null;
            }
        }

        // Get or create the forms data file in Google Drive
        async function getOrCreateFormsDataFile() {
            if (!isSignedIn || !formsFolderId) {
                console.log('Cannot sync forms: not signed in or no forms folder');
                return null;
            }

            try {
                const FORMS_DATA_FILE_NAME = 'Forms_Data.json';

                // Search for existing forms data file
                const searchResponse = await gapi.client.drive.files.list({
                    q: `name='${FORMS_DATA_FILE_NAME}' and '${formsFolderId}' in parents and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name, modifiedTime)'
                });

                if (searchResponse.result.files.length > 0) {
                    formsDataFileId = searchResponse.result.files[0].id;
                    console.log('Found existing forms data file:', formsDataFileId);
                    return formsDataFileId;
                }

                // Create new forms data file
                console.log('Creating new forms data file...');
                const createResponse = await gapi.client.drive.files.create({
                    resource: {
                        name: FORMS_DATA_FILE_NAME,
                        mimeType: 'application/json',
                        parents: [formsFolderId]
                    },
                    fields: 'id'
                });

                formsDataFileId = createResponse.result.id;
                console.log('Created forms data file:', formsDataFileId);

                // Initialize with empty object
                await updateFormsDataFile({});

                return formsDataFileId;
            } catch (error) {
                console.error('Error with forms data file:', error);
                return null;
            }
        }

        // Update the forms data file content in Drive
        async function updateFormsDataFile(data) {
            if (!formsDataFileId) {
                console.error('No forms data file ID');
                return false;
            }

            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";

            const contentType = 'application/json';
            const metadata = {
                mimeType: contentType
            };

            const multipartRequestBody =
                delimiter +
                'Content-Type: application/json\r\n\r\n' +
                JSON.stringify(metadata) +
                delimiter +
                'Content-Type: ' + contentType + '\r\n\r\n' +
                JSON.stringify(data, null, 2) +
                close_delim;

            const response = await fetch(
                `https://www.googleapis.com/upload/drive/v3/files/${formsDataFileId}?uploadType=multipart`,
                {
                    method: 'PATCH',
                    headers: {
                        'Authorization': 'Bearer ' + gapi.client.getToken().access_token,
                        'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                    },
                    body: multipartRequestBody
                }
            );

            if (!response.ok) {
                throw new Error('Failed to update forms data file');
            }

            return true;
        }

        // Load form templates from Google Drive and localStorage
        async function loadFormTemplates() {
            // Try to load from Google Drive first
            if (isSignedIn && formsFolderId) {
                try {
                    await getOrCreateFormsDataFile();

                    if (formsDataFileId) {
                        const response = await gapi.client.drive.files.get({
                            fileId: formsDataFileId,
                            alt: 'media'
                        });

                        if (response.result) {
                            formTemplates = response.result;
                            // Cache in localStorage
                            localStorage.setItem('formTemplates', JSON.stringify(formTemplates));
                            console.log('Loaded form templates from Drive:', Object.keys(formTemplates).length);
                            return;
                        }
                    }
                } catch (error) {
                    console.error('Error loading forms from Drive:', error);
                }
            }

            // Fallback to localStorage
            const stored = localStorage.getItem('formTemplates');
            if (stored) {
                try {
                    formTemplates = JSON.parse(stored);
                    console.log('Loaded form templates from localStorage:', Object.keys(formTemplates).length);
                } catch (e) {
                    console.error('Error parsing stored form templates:', e);
                    formTemplates = {};
                }
            }
        }

        // Save form templates to Google Drive and localStorage
        async function saveFormTemplates() {
            // Save to localStorage for quick access
            localStorage.setItem('formTemplates', JSON.stringify(formTemplates));

            // Save to Google Drive for cross-device sync
            if (isSignedIn && formsFolderId) {
                try {
                    if (!formsDataFileId) {
                        await getOrCreateFormsDataFile();
                    }

                    if (formsDataFileId) {
                        await updateFormsDataFile(formTemplates);
                        console.log('Saved form templates to Drive');
                    }
                } catch (error) {
                    console.error('Error saving forms to Drive:', error);
                }
            }
        }

        // Upload form template
        async function uploadFormTemplate() {
            const fileInput = document.getElementById('formFileInput');
            const formTypeSelect = document.getElementById('formTypeSelect');

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select a file to upload');
                return;
            }

            const file = fileInput.files[0];
            const formType = formTypeSelect.value;

            const isPDF = file.type.includes('pdf');
            const isImage = file.type.includes('image');

            if (!isPDF && !isImage) {
                alert('Please select a PDF or image file (JPEG, PNG, etc.)');
                return;
            }

            try {
                // Show uploading message
                const listContainer = document.getElementById('formsListContainer');
                listContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #27ae60;"><div class="loading"></div><p style="margin-top: 10px;">Processing form...</p></div>';

                if (isImage) {
                    // Upload to Google Drive (required for images to avoid localStorage quota)
                    if (!formsFolderId) {
                        await getOrCreateFormsFolder();
                        if (!formsFolderId) {
                            alert('Failed to create forms folder. Please connect to Google Drive.');
                            displayFormsList();
                            return;
                        }
                    }

                    // Upload file to Google Drive
                    const metadata = {
                        name: file.name,
                        mimeType: file.type,
                        parents: [formsFolderId]
                    };

                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', file);

                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink,webContentLink', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + gapi.client.getToken().access_token
                        },
                        body: form
                    });

                    if (!response.ok) {
                        throw new Error('Upload failed: ' + response.statusText);
                    }

                    const result = await response.json();

                    // Store form template info with Drive reference only (no base64)
                    formTemplates[formType] = {
                        fileId: result.id,
                        fileName: result.name,
                        webViewLink: result.webViewLink,
                        webContentLink: result.webContentLink,
                        fileType: 'image',
                        uploadDate: new Date().toISOString()
                    };

                    await saveFormTemplates();

                    // Clear file input
                    fileInput.value = '';

                    // Refresh forms list
                    displayFormsList();

                    alert('Form template uploaded successfully!');

                } else if (isPDF) {
                    // Handle PDF upload to Google Drive (existing behavior)
                    if (!formsFolderId) {
                        await getOrCreateFormsFolder();
                        if (!formsFolderId) {
                            alert('Failed to create forms folder');
                            displayFormsList();
                            return;
                        }
                    }

                    // Upload file to Google Drive
                    const metadata = {
                        name: file.name,
                        mimeType: 'application/pdf',
                        parents: [formsFolderId]
                    };

                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', file);

                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink,webContentLink', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + gapi.client.getToken().access_token
                        },
                        body: form
                    });

                    if (!response.ok) {
                        throw new Error('Upload failed: ' + response.statusText);
                    }

                    const result = await response.json();

                    // Store form template info
                    formTemplates[formType] = {
                        fileId: result.id,
                        fileName: result.name,
                        webViewLink: result.webViewLink,
                        webContentLink: result.webContentLink,
                        fileType: 'pdf',
                        uploadDate: new Date().toISOString()
                    };

                    await saveFormTemplates();

                    // Clear file input
                    fileInput.value = '';

                    // Refresh forms list
                    displayFormsList();

                    alert('Form template uploaded successfully!');
                }
            } catch (error) {
                console.error('Error uploading form:', error);
                if (error.name === 'QuotaExceededError') {
                    alert('Failed to upload form: Storage quota exceeded. The image may be too large even after compression.');
                } else {
                    alert('Failed to upload form: ' + error.message);
                }
                displayFormsList();
            }
        }

        // Display forms list
        function displayFormsList() {
            const container = document.getElementById('formsListContainer');

            const formTypeNames = {
                'test_drive': 'Test Drive Agreement',
                'vsa': 'Vehicle Sales Agreement',
                'pdpa': 'PDPA Consent Form',
                'coe_bidding_1': 'COE Bidding 1',
                'coe_bidding_2': 'COE Bidding 2',
                'pdpa_consent_1': 'PDPA Consent 1',
                'pdpa_consent_2': 'PDPA Consent 2',
                'other': 'Other Form'
            };

            if (Object.keys(formTemplates).length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #7f8c8d;">No forms uploaded yet</div>';
                return;
            }

            let html = '';
            for (const [formType, formData] of Object.entries(formTemplates)) {
                const formName = formTypeNames[formType] || formType;
                const uploadDate = new Date(formData.uploadDate).toLocaleDateString();

                const hasFieldMapping = formData.fileType === 'image';
                const fieldCount = formData.fieldMappings ? Object.keys(formData.fieldMappings).length : 0;

                html += `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-icon">üìÑ</div>
                            <div class="file-details">
                                <h4>${formName}</h4>
                                <p>${formData.fileName} ‚Ä¢ Uploaded: ${uploadDate}</p>
                                ${hasFieldMapping ? '<p style="font-size: 12px; color: #27ae60; margin-top: 3px;">‚úì ' + fieldCount + ' field(s) mapped</p>' : ''}
                            </div>
                        </div>
                        <div class="file-actions" style="display: flex; gap: 5px; flex-wrap: wrap;">
                            ${hasFieldMapping ? '<button class="btn btn-small" onclick="openFieldMappingModal(\'' + formType + '\')" style="background: #00bcd4; color: white;">‚öôÔ∏è Configure Fields</button>' : ''}
                            <button class="btn btn-small btn-primary" onclick="viewForm('${formType}')">View</button>
                            <button class="btn btn-small btn-danger" onclick="deleteForm('${formType}')">Delete</button>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // View form
        async function viewForm(formType) {
            const formData = formTemplates[formType];
            if (!formData) {
                alert('Form not found');
                return;
            }

            if (formData.webViewLink) {
                // Open in Google Drive viewer
                window.open(formData.webViewLink, '_blank');
            } else if (formData.fileType === 'image' && formData.fileId) {
                // For images without webViewLink (legacy), fetch and display
                try {
                    const base64Data = await getFormImageFromDrive(formType);
                    const win = window.open('', '_blank');
                    win.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>${formData.fileName}</title>
                            <style>
                                body { margin: 0; padding: 20px; background: #2c3e50; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
                                img { max-width: 100%; height: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
                            </style>
                        </head>
                        <body>
                            <img src="${base64Data}" alt="${formData.fileName}">
                        </body>
                        </html>
                    `);
                } catch (error) {
                    alert('Failed to load form: ' + error.message);
                }
            } else {
                alert('Form link not available. Please re-upload this form.');
            }
        }

        // Delete form
        async function deleteForm(formType) {
            if (!confirm('Are you sure you want to delete this form template?')) {
                return;
            }

            const formData = formTemplates[formType];
            if (!formData) {
                return;
            }

            try {
                // Delete from Google Drive
                await gapi.client.drive.files.delete({
                    fileId: formData.fileId
                });

                // Remove from local storage
                delete formTemplates[formType];
                await saveFormTemplates();

                // Refresh list
                displayFormsList();

                alert('Form template deleted successfully');
            } catch (error) {
                console.error('Error deleting form:', error);
                alert('Failed to delete form: ' + error.message);
            }
        }

        // ========== COMBINE & PRINT FORMS ==========

        let currentCombineCustomerId = null;

        // Open combine print modal and populate form options
        function openCombinePrintModal(customerId) {
            currentCombineCustomerId = customerId;

            const modal = document.getElementById('combinePrintModal');
            const side1Select = document.getElementById('combineSide1');
            const side2Select = document.getElementById('combineSide2');

            // Clear existing options except the default
            side1Select.innerHTML = '<option value="">Select a form...</option>';
            side2Select.innerHTML = '<option value="">Select a form...</option>';

            // Form type names for display
            const formTypeNames = {
                'test_drive': 'Test Drive Agreement',
                'vsa': 'Vehicle Sales Agreement',
                'pdpa': 'PDPA Consent Form',
                'coe_bidding_1': 'COE Bidding 1',
                'coe_bidding_2': 'COE Bidding 2',
                'pdpa_consent_1': 'PDPA Consent 1',
                'pdpa_consent_2': 'PDPA Consent 2',
                'other': 'Other Form'
            };

            // Populate dropdowns with available image forms
            for (const [formType, formData] of Object.entries(formTemplates)) {
                if (formData.fileType === 'image') {
                    const formName = formTypeNames[formType] || formType;
                    const option1 = document.createElement('option');
                    option1.value = formType;
                    option1.textContent = formName;

                    const option2 = document.createElement('option');
                    option2.value = formType;
                    option2.textContent = formName;

                    side1Select.appendChild(option1);
                    side2Select.appendChild(option2);
                }
            }

            // Show modal
            modal.style.display = 'flex';
        }

        // Close combine print modal
        function closeCombinePrintModal() {
            document.getElementById('combinePrintModal').style.display = 'none';
            currentCombineCustomerId = null;
        }

        // Combine and print selected forms with customer data
        async function combinePrintForms() {
            const side1 = document.getElementById('combineSide1').value;
            const side2 = document.getElementById('combineSide2').value;

            if (!side1 || !side2) {
                alert('Please select forms for both sides');
                return;
            }

            if (side1 === side2) {
                alert('Please select different forms for each side');
                return;
            }

            if (!currentCombineCustomerId) {
                alert('Customer not found');
                return;
            }

            // Save customer ID before closing modal (which clears the variable)
            const customerId = currentCombineCustomerId;

            try {
                // Close modal
                closeCombinePrintModal();

                // Get customer data
                const customer = customers.find(c => c.id === customerId);
                if (!customer) {
                    alert('Customer not found');
                    return;
                }

                // Show loading
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'combineLoadingOverlay';
                loadingDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 10000;';
                loadingDiv.innerHTML = '<div style="background: white; padding: 30px; border-radius: 10px; text-align: center;"><div class="loading" style="margin-bottom: 15px;"></div><p style="color: #2c3e50; font-size: 16px;">Preparing forms with customer data...</p></div>';
                document.body.appendChild(loadingDiv);

                // Render forms with customer data (uses field mapping if configured)
                const form1Data = await renderFormWithData(side1, customer);
                const form2Data = await renderFormWithData(side2, customer);

                // Get form names
                const formTypeNames = {
                    'test_drive': 'Test Drive Agreement',
                    'vsa': 'Vehicle Sales Agreement',
                    'pdpa': 'PDPA Consent Form',
                    'coe_bidding_1': 'COE Bidding 1',
                    'coe_bidding_2': 'COE Bidding 2',
                    'pdpa_consent_1': 'PDPA Consent 1',
                    'pdpa_consent_2': 'PDPA Consent 2',
                    'other': 'Other Form'
                };

                const form1Name = formTypeNames[side1] || side1;
                const form2Name = formTypeNames[side2] || side2;

                // Remove loading
                document.body.removeChild(loadingDiv);

                // Create print window with both forms
                const printWin = window.open('', '_blank');
                printWin.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>${customer.name} - ${form1Name} & ${form2Name}</title>
                        <style>
                            @page {
                                size: A4;
                                margin: 0;
                            }
                            * {
                                margin: 0;
                                padding: 0;
                                box-sizing: border-box;
                            }
                            body {
                                font-family: Arial, sans-serif;
                            }
                            .page {
                                width: 210mm;
                                height: 297mm;
                                page-break-after: always;
                                background: white;
                                position: relative;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            }
                            .page:last-child {
                                page-break-after: auto;
                            }
                            .page img {
                                max-width: 100%;
                                max-height: 100%;
                                object-fit: contain;
                            }
                            .print-btn {
                                position: fixed;
                                top: 20px;
                                right: 20px;
                                padding: 14px 28px;
                                background: #27ae60;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 15px;
                                font-weight: 700;
                                box-shadow: 0 6px 16px rgba(0,0,0,0.3);
                                z-index: 1000;
                                transition: all 0.3s;
                            }
                            .print-btn:hover {
                                background: #229954;
                                transform: translateY(-2px);
                                box-shadow: 0 8px 20px rgba(0,0,0,0.4);
                            }
                            .info-banner {
                                position: fixed;
                                top: 20px;
                                left: 20px;
                                background: rgba(0, 188, 212, 0.95);
                                color: white;
                                padding: 12px 20px;
                                border-radius: 6px;
                                font-size: 14px;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                                z-index: 1000;
                            }
                            @media print {
                                .no-print {
                                    display: none !important;
                                }
                                body {
                                    print-color-adjust: exact;
                                    -webkit-print-color-adjust: exact;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <button class="print-btn no-print" onclick="window.print()">üñ®Ô∏è Print Double-Sided</button>
                        <div class="info-banner no-print">
                            <strong>${customer.name}</strong><br>
                            üìë Page 1: ${form1Name} | Page 2: ${form2Name}
                        </div>

                        <!-- Page 1 (Front) -->
                        <div class="page">
                            <img src="${form1Data}" alt="${form1Name}">
                        </div>

                        <!-- Page 2 (Back) -->
                        <div class="page">
                            <img src="${form2Data}" alt="${form2Name}">
                        </div>
                    </body>
                    </html>
                `);
                printWin.document.close();

            } catch (error) {
                // Remove loading if exists
                const loadingOverlay = document.getElementById('combineLoadingOverlay');
                if (loadingOverlay) {
                    document.body.removeChild(loadingOverlay);
                }
                console.error('Error combining forms:', error);
                alert('Failed to combine forms: ' + error.message);
            }
        }

        // Field Mapping Functions
        let currentMappingFormType = null;
        let currentMappingCanvas = null;
        let currentMappingImage = null;
        let tempFieldMappings = {};

        async function openFieldMappingModal(formType) {
            const formData = formTemplates[formType];
            if (!formData || formData.fileType !== 'image') {
                alert('This form does not support field mapping');
                return;
            }

            currentMappingFormType = formType;
            tempFieldMappings = JSON.parse(JSON.stringify(formData.fieldMappings || {}));

            // Show modal
            document.getElementById('fieldMappingModal').style.display = 'flex';

            // Load form image onto canvas
            const canvas = document.getElementById('formMappingCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            try {
                // Fetch image from Drive
                const base64Data = await getFormImageFromDrive(formType);

                img.onload = function() {
                    // Scale to fit screen while maintaining aspect ratio
                    const maxWidth = Math.min(window.innerWidth * 0.8, 1000);
                    const scale = maxWidth / img.width;
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;

                    currentMappingCanvas = canvas;
                    currentMappingImage = img;

                    redrawMappingCanvas();
                };

                img.src = base64Data;
            } catch (error) {
                alert('Failed to load form image: ' + error.message);
                document.getElementById('fieldMappingModal').style.display = 'none';
            }
        }

        function redrawMappingCanvas() {
            if (!currentMappingCanvas || !currentMappingImage) return;

            const canvas = currentMappingCanvas;
            const ctx = canvas.getContext('2d');

            // Clear and draw image
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(currentMappingImage, 0, 0, canvas.width, canvas.height);

            // Draw field markers
            const scale = canvas.width / currentMappingImage.width;
            for (const [fieldId, field] of Object.entries(tempFieldMappings)) {
                const x = field.x * scale;
                const y = field.y * scale;

                // Draw marker circle
                ctx.fillStyle = 'rgba(0, 188, 212, 0.3)';
                ctx.beginPath();
                ctx.arc(x, y, 15, 0, 2 * Math.PI);
                ctx.fill();

                ctx.strokeStyle = '#00bcd4';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(x, y, 15, 0, 2 * Math.PI);
                ctx.stroke();

                // Draw field label
                ctx.fillStyle = '#00bcd4';
                ctx.font = 'bold 12px Arial';
                const labelText = field.customValue ? field.customValue : field.type;
                ctx.fillText(labelText, x + 20, y + 5);
            }

            // Update mapped fields list
            updateMappedFieldsList();
        }

        function updateMappedFieldsList() {
            const listContainer = document.getElementById('mappedFieldsList');
            if (Object.keys(tempFieldMappings).length === 0) {
                listContainer.innerHTML = '<p style="color: #7f8c8d;">No fields mapped yet. Click on the form to add fields.</p>';
                return;
            }

            let html = '<ul style="list-style: none; padding: 0;">';
            for (const [fieldId, field] of Object.entries(tempFieldMappings)) {
                const fieldNames = {
                    'name': 'Customer Name',
                    'phone': 'Phone Number',
                    'email': 'Email',
                    'model': 'Car Model',
                    'date': 'Today\'s Date',
                    'custom': 'Custom Value'
                };

                let displayText;
                if (field.customValue) {
                    displayText = '<strong>Custom: "' + field.customValue + '"</strong>';
                } else {
                    displayText = '<strong>' + (fieldNames[field.type] || field.type) + '</strong>';
                }

                html += '<li style="padding: 8px; margin-bottom: 5px; background: white; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">';
                html += '<span>' + displayText + ' - Size: ' + field.fontSize + 'px</span>';
                html += '<button class="btn btn-small btn-danger" onclick="removeFieldMapping(\'' + fieldId + '\')">Remove</button>';
                html += '</li>';
            }
            html += '</ul>';
            listContainer.innerHTML = html;
        }

        function removeFieldMapping(fieldId) {
            delete tempFieldMappings[fieldId];
            redrawMappingCanvas();
        }

        function clearAllFieldMappings() {
            if (!confirm('Remove all field mappings?')) return;
            tempFieldMappings = {};
            redrawMappingCanvas();
        }

        // Toggle custom value input visibility
        function toggleCustomValueInput() {
            const fieldTypeSelect = document.getElementById('fieldTypeSelect');
            const customValueContainer = document.getElementById('customValueInputContainer');

            if (fieldTypeSelect.value === 'custom') {
                customValueContainer.style.display = 'block';
            } else {
                customValueContainer.style.display = 'none';
            }
        }

        // Canvas click handler
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('formMappingCanvas');
            if (canvas) {
                canvas.addEventListener('click', function(e) {
                    if (!currentMappingFormType) return;

                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    // Convert to original image coordinates
                    const scale = canvas.width / currentMappingImage.width;
                    const originalX = x / scale;
                    const originalY = y / scale;

                    // Get field settings
                    const fieldType = document.getElementById('fieldTypeSelect').value;
                    const fontSize = parseInt(document.getElementById('fieldFontSize').value);
                    const textColor = document.getElementById('fieldTextColor').value;

                    // Check if custom value
                    let customValue = null;
                    if (fieldType === 'custom') {
                        customValue = document.getElementById('customValueInput').value.trim();
                        if (!customValue) {
                            alert('Please enter a custom value');
                            return;
                        }
                    }

                    // Add field mapping
                    const fieldId = 'field_' + Date.now();
                    tempFieldMappings[fieldId] = {
                        type: fieldType,
                        x: originalX,
                        y: originalY,
                        fontSize: fontSize,
                        color: textColor
                    };

                    // Store custom value if provided
                    if (customValue) {
                        tempFieldMappings[fieldId].customValue = customValue;
                    }

                    redrawMappingCanvas();
                });
            }
        });

        async function saveFieldMappings() {
            if (!currentMappingFormType) return;

            const formData = formTemplates[currentMappingFormType];
            formData.fieldMappings = tempFieldMappings;

            await saveFormTemplates();

            alert('Field mappings saved successfully!');
            closeFieldMappingModal();
            displayFormsList();
        }

        function closeFieldMappingModal() {
            document.getElementById('fieldMappingModal').style.display = 'none';
            currentMappingFormType = null;
            currentMappingCanvas = null;
            currentMappingImage = null;
            tempFieldMappings = {};
        }

        // ========== EXCEL TEMPLATES MANAGEMENT ==========

        // Open Excel modal
        function openExcelModal() {
            const modal = document.getElementById('excelModal');
            modal.classList.add('active');
            loadExcelTemplates();
            displayExcelList();
        }

        // Close Excel modal
        function closeExcelModal() {
            document.getElementById('excelModal').classList.remove('active');
            document.getElementById('excelTemplateName').value = '';
        }

        // Create Excel template (mappings only, no file storage)
        function createExcelTemplate() {
            const nameInput = document.getElementById('excelTemplateName');
            const name = nameInput.value.trim();

            if (!name) {
                alert('Please enter a template name');
                return;
            }

            // Store only the template metadata - NO Excel file
            const templateId = 'excel_' + Date.now();
            excelTemplates[templateId] = {
                id: templateId,
                name: name,
                createdDate: new Date().toISOString(),
                fieldMappings: {} // Will be populated by user
            };

            // Save to localStorage
            saveExcelTemplates();

            // Update display
            displayExcelList();

            // Clear input
            nameInput.value = '';

            alert('Template created successfully! Now you can map fields to Excel cells.');
        }

        // Display Excel templates list
        function displayExcelList() {
            const container = document.getElementById('excelListContainer');

            if (Object.keys(excelTemplates).length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #7f8c8d;">No templates uploaded yet</div>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';

            for (const [templateId, template] of Object.entries(excelTemplates)) {
                const mappingCount = Object.keys(template.fieldMappings || {}).length;
                const dateToShow = template.createdDate || template.uploadDate; // Support both old and new templates
                html += `
                    <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <h4 style="color: #1a1a2e; margin-bottom: 5px;">${template.name}</h4>
                                <p style="color: #7f8c8d; font-size: 12px;">Created: ${new Date(dateToShow).toLocaleDateString()}</p>
                                <p style="color: #4caf50; font-size: 13px; font-weight: 600; margin-top: 5px;">${mappingCount} field${mappingCount !== 1 ? 's' : ''} mapped</p>
                            </div>
                            <button class="btn btn-danger" onclick="deleteExcelTemplate('${templateId}')" style="padding: 8px 12px; font-size: 13px;">Delete</button>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-primary" onclick="openExcelMappingModal('${templateId}')" style="flex: 1; background: #2196f3;">Map Fields</button>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // Delete Excel template
        function deleteExcelTemplate(templateId) {
            if (!confirm('Are you sure you want to delete this Excel template?')) {
                return;
            }

            delete excelTemplates[templateId];
            saveExcelTemplates();
            displayExcelList();
        }

        // Save Excel templates to localStorage
        function saveExcelTemplates() {
            try {
                localStorage.setItem('excelTemplates', JSON.stringify(excelTemplates));
            } catch (error) {
                console.error('Error saving Excel templates:', error);
            }
        }

        // Load Excel templates from localStorage
        function loadExcelTemplates() {
            try {
                const stored = localStorage.getItem('excelTemplates');
                if (stored) {
                    excelTemplates = JSON.parse(stored);
                }
            } catch (error) {
                console.error('Error loading Excel templates:', error);
            }
        }

        // Variables for Excel mapping
        let currentExcelTemplateId = null;
        let tempExcelMappings = {};

        // Open Excel mapping modal
        function openExcelMappingModal(templateId) {
            currentExcelTemplateId = templateId;
            const template = excelTemplates[templateId];

            if (!template) {
                alert('Template not found');
                return;
            }

            // Load existing mappings
            tempExcelMappings = { ...(template.fieldMappings || {}) };

            // Show modal
            document.getElementById('excelMappingModal').style.display = 'flex';

            // Update display
            updateExcelMappingsList();
        }

        // Close Excel mapping modal
        function closeExcelMappingModal() {
            document.getElementById('excelMappingModal').style.display = 'none';
            currentExcelTemplateId = null;
            tempExcelMappings = {};
        }

        // Add Excel field mapping
        function addExcelMapping() {
            const fieldType = document.getElementById('excelFieldType').value;
            const cellRef = document.getElementById('excelCellRef').value.trim().toUpperCase();

            if (!cellRef) {
                alert('Please enter a cell reference (e.g., A1)');
                return;
            }

            // Validate cell reference format (simple validation)
            if (!/^[A-Z]+[0-9]+$/.test(cellRef)) {
                alert('Invalid cell reference. Please use format like A1, B5, C10, etc.');
                return;
            }

            // Add mapping
            const mappingId = 'mapping_' + Date.now();
            tempExcelMappings[mappingId] = {
                fieldType: fieldType,
                cellRef: cellRef
            };

            // Clear input
            document.getElementById('excelCellRef').value = '';

            // Update display
            updateExcelMappingsList();
        }

        // Remove Excel mapping
        function removeExcelMapping(mappingId) {
            delete tempExcelMappings[mappingId];
            updateExcelMappingsList();
        }

        // Update Excel mappings list display
        function updateExcelMappingsList() {
            const container = document.getElementById('excelMappingsList');

            if (Object.keys(tempExcelMappings).length === 0) {
                container.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">No mappings added yet</p>';
                return;
            }

            const fieldNames = {
                'name': 'Customer Name',
                'phone': 'Phone Number',
                'email': 'Email',
                'nric': 'NRIC/FIN',
                'occupation': 'Occupation',
                'dob': 'Date of Birth',
                'address': 'Address',
                'addressContinue': 'Address Continue',
                'salesConsultant': 'Sales Consultant',
                'vsaNo': 'VSA No',
                'model': 'Car Model',
                'date': 'Today\'s Date',
                'vsa_makeModel': 'VSA - Make & Model',
                'vsa_yom': 'VSA - YOM (Year of Manufacture)',
                'vsa_bodyColour': 'VSA - Body Colour',
                'vsa_upholstery': 'VSA - Upholstery',
                'vsa_przType': 'VSA - P/R/Z Type',
                'vsa_package': 'VSA - Package',
                'vsa_sellingWithCOE': 'VSA - Selling with COE',
                'vsa_sellingPriceList': 'VSA - Selling Price on Price List',
                'vsa_purchasePriceWithCOE': 'VSA - Purchase Price with COE',
                'vsa_coeRebateLevel': 'VSA - COE Rebate Level',
                'vsa_deposit': 'VSA - Deposit',
                'vsa_lessOthers': 'VSA - Less: Others',
                'vsa_addOthers': 'VSA - Add: Others',
                'vsa_deliveryDate': 'VSA - Approximate Delivery Date',
                'vsa_tradeInCarNo': 'VSA - Trade in Car No',
                'vsa_tradeInCarModel': 'VSA - Trade in Car Model',
                'vsa_tradeInAmount': 'VSA - Trade In Amount',
                'vsa_remarks1': 'VSA - Remarks 1',
                'vsa_remarks2': 'VSA - Remarks 2',
                'vsa_loanAmount': 'VSA - Loan Amount',
                'vsa_interest': 'VSA - Interest',
                'vsa_tenure': 'VSA - Tenure',
                'vsa_monthlyPayment': 'VSA - Monthly Payment',
                'vsa_financeCompany': 'VSA - Finance Company',
                'vsa_insuranceCompany': 'VSA - Insurance Company',
                'vsa_insuranceFee': 'VSA - Insurance Fee'
            };

            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';

            for (const [mappingId, mapping] of Object.entries(tempExcelMappings)) {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                        <div>
                            <strong>${fieldNames[mapping.fieldType]}</strong> ‚Üí Cell <strong>${mapping.cellRef}</strong>
                        </div>
                        <button class="btn btn-small btn-danger" onclick="removeExcelMapping('${mappingId}')" style="padding: 5px 10px; font-size: 12px;">Remove</button>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // Save Excel mappings
        function saveExcelMappings() {
            if (!currentExcelTemplateId) {
                return;
            }

            const template = excelTemplates[currentExcelTemplateId];
            if (!template) {
                alert('Template not found');
                return;
            }

            template.fieldMappings = tempExcelMappings;
            saveExcelTemplates();

            alert('Field mappings saved successfully!');
            closeExcelMappingModal();
            displayExcelList();
        }

        // Open Excel populate modal
        let currentPopulateCustomerId = null;

        function openExcelPopulateModal(customerId) {
            currentPopulateCustomerId = customerId;
            const modal = document.getElementById('excelPopulateModal');
            modal.style.display = 'flex';

            // Clear file input
            document.getElementById('excelOriginalFile').value = '';

            // Populate template select
            const select = document.getElementById('excelTemplateSelect');
            select.innerHTML = '<option value="">-- Select a mapping template --</option>';

            for (const [templateId, template] of Object.entries(excelTemplates)) {
                const mappingCount = Object.keys(template.fieldMappings || {}).length;
                select.innerHTML += `<option value="${templateId}">${template.name} (${mappingCount} fields mapped)</option>`;
            }

            // Reset preview
            updateExcelPreview();
        }

        // Close Excel populate modal
        function closeExcelPopulateModal() {
            document.getElementById('excelPopulateModal').style.display = 'none';
            document.getElementById('excelOriginalFile').value = '';
            currentPopulateCustomerId = null;
        }

        // Update Excel preview (called when template or file selection changes)
        function updateExcelPreview() {
            const select = document.getElementById('excelTemplateSelect');
            const templateId = select.value;
            const downloadBtn = document.getElementById('downloadExcelBtn');
            const previewContainer = document.getElementById('excelCustomerPreview');
            const fileInput = document.getElementById('excelOriginalFile');

            if (!templateId) {
                previewContainer.innerHTML = '<p>Select a mapping template to preview...</p>';
                downloadBtn.disabled = true;
                return;
            }

            const template = excelTemplates[templateId];
            const customer = customers.find(c => c.id === currentPopulateCustomerId);

            if (!customer) {
                previewContainer.innerHTML = '<p style="color: #e74c3c;">Customer not found</p>';
                downloadBtn.disabled = true;
                return;
            }

            const mappingCount = Object.keys(template.fieldMappings || {}).length;

            if (mappingCount === 0) {
                previewContainer.innerHTML = '<p style="color: #f39c12;">‚ö†Ô∏è No field mappings configured for this template. Please map fields first.</p>';
                downloadBtn.disabled = true;
                return;
            }

            const fieldNames = {
                'name': 'Customer Name',
                'phone': 'Phone Number',
                'email': 'Email',
                'nric': 'NRIC/FIN',
                'occupation': 'Occupation',
                'dob': 'Date of Birth',
                'address': 'Address',
                'addressContinue': 'Address Continue',
                'salesConsultant': 'Sales Consultant',
                'vsaNo': 'VSA No',
                'model': 'Car Model',
                'date': 'Today\'s Date',
                'vsa_makeModel': 'VSA - Make & Model',
                'vsa_yom': 'VSA - YOM (Year of Manufacture)',
                'vsa_bodyColour': 'VSA - Body Colour',
                'vsa_upholstery': 'VSA - Upholstery',
                'vsa_przType': 'VSA - P/R/Z Type',
                'vsa_package': 'VSA - Package',
                'vsa_sellingWithCOE': 'VSA - Selling with COE',
                'vsa_sellingPriceList': 'VSA - Selling Price on Price List',
                'vsa_purchasePriceWithCOE': 'VSA - Purchase Price with COE',
                'vsa_coeRebateLevel': 'VSA - COE Rebate Level',
                'vsa_deposit': 'VSA - Deposit',
                'vsa_lessOthers': 'VSA - Less: Others',
                'vsa_addOthers': 'VSA - Add: Others',
                'vsa_deliveryDate': 'VSA - Approximate Delivery Date',
                'vsa_tradeInCarNo': 'VSA - Trade in Car No',
                'vsa_tradeInCarModel': 'VSA - Trade in Car Model',
                'vsa_tradeInAmount': 'VSA - Trade In Amount',
                'vsa_remarks1': 'VSA - Remarks 1',
                'vsa_remarks2': 'VSA - Remarks 2',
                'vsa_loanAmount': 'VSA - Loan Amount',
                'vsa_interest': 'VSA - Interest',
                'vsa_tenure': 'VSA - Tenure',
                'vsa_monthlyPayment': 'VSA - Monthly Payment',
                'vsa_financeCompany': 'VSA - Finance Company',
                'vsa_insuranceCompany': 'VSA - Insurance Company',
                'vsa_insuranceFee': 'VSA - Insurance Fee'
            };

            let html = '<div style="font-size: 13px;">';
            html += '<p style="margin-bottom: 10px;"><strong>The following data will be populated:</strong></p>';

            for (const mapping of Object.values(template.fieldMappings)) {
                const fieldName = fieldNames[mapping.fieldType];
                let value = '';

                if (mapping.fieldType === 'date') {
                    value = new Date().toLocaleDateString();
                } else {
                    value = customer[mapping.fieldType] || '(empty)';
                }

                html += `<p style="margin: 5px 0;"><strong>Cell ${mapping.cellRef}:</strong> ${fieldName} = "${value}"</p>`;
            }

            html += '</div>';
            previewContainer.innerHTML = html;

            // Enable download button only if both file and template are selected
            downloadBtn.disabled = !(fileInput.files.length > 0);
        }

        // Download populated Excel
        async function downloadPopulatedExcel() {
            const select = document.getElementById('excelTemplateSelect');
            const templateId = select.value;
            const fileInput = document.getElementById('excelOriginalFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please upload your original Excel file');
                return;
            }

            if (!templateId) {
                alert('Please select a field mapping template');
                return;
            }

            const template = excelTemplates[templateId];
            const customer = customers.find(c => c.id === currentPopulateCustomerId);

            if (!customer) {
                alert('Customer not found');
                return;
            }

            try {
                // Read the freshly uploaded Excel file
                const arrayBuffer = await file.arrayBuffer();

                // Load with xlsx-populate - PERFECT formatting preservation
                const workbook = await XlsxPopulate.fromDataAsync(arrayBuffer);

                // Get first sheet (or we could let user select)
                const sheet = workbook.sheet(0);

                // Populate fields
                const dataMapping = {
                    'name': customer.name || '',
                    'phone': customer.phone || '',
                    'email': customer.email || '',
                    'nric': customer.nric || '',
                    'occupation': customer.occupation || '',
                    'dob': customer.dob || '',
                    'address': customer.address || '',
                    'addressContinue': customer.addressContinue || '',
                    'salesConsultant': customer.salesConsultant || '',
                    'vsaNo': customer.vsaNo || '',
                    'model': customer.model || '',
                    'date': new Date().toLocaleDateString(),
                    'vsa_makeModel': customer.vsaDetails?.makeModel || '',
                    'vsa_yom': customer.vsaDetails?.yom || '',
                    'vsa_bodyColour': customer.vsaDetails?.bodyColour || '',
                    'vsa_upholstery': customer.vsaDetails?.upholstery || '',
                    'vsa_przType': customer.vsaDetails?.przType || '',
                    'vsa_package': customer.vsaDetails?.package || '',
                    'vsa_purchasePriceWithCOE': customer.vsaDetails?.purchasePriceWithCOE || '',
                    'vsa_sellingWithCOE': customer.vsaDetails?.sellingWithCOE || '',
                    'vsa_sellingPriceList': customer.vsaDetails?.sellingPriceList || '',
                    'vsa_coeRebateLevel': customer.vsaDetails?.coeRebateLevel || '',
                    'vsa_deposit': customer.vsaDetails?.deposit || '',
                    'vsa_lessOthers': customer.vsaDetails?.lessOthers || '',
                    'vsa_addOthers': customer.vsaDetails?.addOthers || '',
                    'vsa_deliveryDate': customer.vsaDetails?.deliveryDate || '',
                    'vsa_tradeInCarNo': customer.vsaDetails?.tradeInCarNo || '',
                    'vsa_tradeInCarModel': customer.vsaDetails?.tradeInCarModel || '',
                    'vsa_tradeInAmount': customer.vsaDetails?.tradeInAmount || '',
                    'vsa_remarks1': customer.vsaDetails?.remarks1 || '',
                    'vsa_remarks2': customer.vsaDetails?.remarks2 || '',
                    'vsa_loanAmount': customer.vsaDetails?.loanAmount || '',
                    'vsa_interest': customer.vsaDetails?.interest || '',
                    'vsa_tenure': customer.vsaDetails?.tenure || '',
                    'vsa_monthlyPayment': customer.vsaDetails?.monthlyPayment || '',
                    'vsa_financeCompany': customer.vsaDetails?.financeCompany || '',
                    'vsa_insuranceCompany': customer.vsaDetails?.insuranceCompany || '',
                    'vsa_insuranceFee': customer.vsaDetails?.insuranceFee || ''
                };

                // Apply mappings - xlsx-populate preserves ALL formatting perfectly
                for (const mapping of Object.values(template.fieldMappings)) {
                    const value = dataMapping[mapping.fieldType];
                    if (value) {
                        // Set cell value - all formatting is automatically preserved
                        sheet.cell(mapping.cellRef).value(value);
                    }
                }

                // Generate Excel file as blob - PERFECT preservation of all formatting
                const blob = await workbook.outputAsync();

                // Determine document type based on template name
                let documentType = 'other'; // Default folder
                const templateNameLower = template.name.toLowerCase();
                if (templateNameLower.includes('vsa') || templateNameLower.includes('sales agreement')) {
                    documentType = 'vsa';
                } else if (templateNameLower.includes('trade')) {
                    documentType = 'trade_in';
                } else if (templateNameLower.includes('test drive')) {
                    documentType = 'test_drive';
                } else if (templateNameLower.includes('pdpa') || templateNameLower.includes('coe')) {
                    documentType = 'pdpa_coe';
                }

                // Create filename for Google Drive
                const timestamp = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
                const driveFileName = `${customer.name.replace(/\s+/g, '_')}_${template.name.replace(/\s+/g, '_')}_${timestamp}.xlsx`;

                // Convert blob to File object for upload
                const excelFile = new File([blob], driveFileName, {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });

                // Upload to Google Drive subfolder only
                let uploadSuccess = false;
                if (isSignedIn) {
                    try {
                        // Ensure customer folder and subfolders exist first
                        if (!customer.driveFolderId) {
                            await createCustomerFolder(customer.name, currentPopulateCustomerId);
                            // Reload customer after folder creation
                            const updatedCustomer = customers.find(c => c.id === currentPopulateCustomerId);
                            if (updatedCustomer) {
                                Object.assign(customer, updatedCustomer);
                            }
                        }

                        // Ensure document subfolders exist
                        if (!customer.documentFolders || !customer.documentFolders[documentType]) {
                            await createDocumentSubfolders(customer.driveFolderId, currentPopulateCustomerId);
                            // Reload customer after subfolder creation
                            const updatedCustomer = customers.find(c => c.id === currentPopulateCustomerId);
                            if (updatedCustomer) {
                                Object.assign(customer, updatedCustomer);
                            }
                        }

                        // Now upload directly to the subfolder
                        const targetFolderId = customer.documentFolders[documentType];

                        if (targetFolderId) {
                            const metadata = {
                                name: driveFileName,
                                parents: [targetFolderId]
                            };

                            const form = new FormData();
                            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                            form.append('file', excelFile);

                            const response = await fetch(
                                'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,mimeType,size,webViewLink,createdTime',
                                {
                                    method: 'POST',
                                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                                    body: form
                                }
                            );

                            const result = await response.json();
                            if (result && result.id) {
                                uploadSuccess = true;
                            }
                        }
                    } catch (uploadError) {
                        console.error('Error uploading to Drive:', uploadError);
                    }
                }

                // Create download link for local copy
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${template.name}_${customer.name}_${timestamp}.xlsx`;
                a.click();
                URL.revokeObjectURL(url);

                // Show success message
                if (uploadSuccess) {
                    alert('Excel file generated successfully!\n\n‚úÖ Downloaded to your computer\n‚úÖ Saved to customer folder in Google Drive\n\nYou can view it in the Documents tab.');
                    // Refresh the customer details to show the new file
                    invalidateStatsCache();
                    displayCustomerDetails(currentPopulateCustomerId);
                } else if (!isSignedIn) {
                    alert('Excel file downloaded successfully!\n\n‚ö†Ô∏è Not connected to Google Drive - file not saved to customer folder.\n\nConnect to Google Drive to automatically save files.');
                } else {
                    alert('Excel file downloaded successfully!\n\n‚ö†Ô∏è Could not save to Google Drive. Please check your connection and try again.');
                }

                closeExcelPopulateModal();
            } catch (error) {
                console.error('Error generating Excel file:', error);
                alert('Failed to generate Excel file: ' + error.message);
            }
        }

        // ========== END EXCEL TEMPLATES MANAGEMENT ==========

        // Upload document image (IC/License photos) - Store as base64 for offline access
        // Compress image for faster storage and printing
        // Fetch form image from Google Drive and cache it in memory
        async function getFormImageFromDrive(formType) {
            const formData = formTemplates[formType];

            // Check if already cached in memory
            if (formImageCache[formType]) {
                return formImageCache[formType];
            }

            // If base64 exists in formData (legacy), use it
            if (formData.base64) {
                formImageCache[formType] = formData.base64;
                return formData.base64;
            }

            // Fetch from Google Drive
            if (!formData.fileId) {
                throw new Error('No image file available for this form');
            }

            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${formData.fileId}?alt=media`, {
                    headers: {
                        'Authorization': 'Bearer ' + gapi.client.getToken().access_token
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch image from Drive');
                }

                const blob = await response.blob();

                // Convert blob to base64
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const base64 = e.target.result;
                        // Cache it in memory
                        formImageCache[formType] = base64;
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error('Error fetching form image from Drive:', error);
                throw error;
            }
        }

        function compressImage(file, maxWidth = 1200, quality = 0.85) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Scale down if image is too large
                        if (width > maxWidth) {
                            height = (height / width) * maxWidth;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert to base64 with compression
                        const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedBase64);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Upload multiple document images at once
        async function uploadMultipleDocImages(customerId, files) {
            if (!files || files.length === 0) return;

            if (files.length > 4) {
                alert('Please select up to 4 images only');
                return;
            }

            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            // Get progress elements
            const progressContainer = document.getElementById('uploadProgress_' + customerId);
            const progressBar = document.getElementById('uploadBar_' + customerId);
            const progressText = document.getElementById('uploadText_' + customerId);

            try {
                // Show progress bar
                if (progressContainer) {
                    progressContainer.style.display = 'block';
                    progressBar.style.width = '0%';
                    progressText.textContent = 'Compressing images...';
                }

                // Initialize testDriveDocs if needed
                if (!customer.testDriveDocs) {
                    customer.testDriveDocs = {};
                }

                // Clear existing images
                customer.testDriveDocs = {};

                let uploadCount = 0;
                const totalFiles = files.length;

                // Process each file
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const docKey = 'doc' + (i + 1); // doc1, doc2, doc3, doc4

                    // Update progress
                    const progress = Math.round((i / totalFiles) * 100);
                    if (progressBar && progressText) {
                        progressBar.style.width = progress + '%';
                        progressText.textContent = 'Processing image ' + (i + 1) + ' of ' + totalFiles + '...';
                    }

                    // Compress image for faster storage
                    const compressedBase64 = await compressImage(file);

                    // Store in customer data as base64
                    customer.testDriveDocs[docKey] = {
                        fileName: file.name,
                        base64: compressedBase64,
                        uploadDate: new Date().toISOString()
                    };

                    uploadCount++;

                    // Upload to Google Drive in background (non-blocking)
                    if (isSignedIn && customer.driveFolderId && customer.documentFolders?.nirc_fin) {
                        // Don't await - let it run in background
                        (async function(docKey, file, i) {
                            try {
                                const metadata = {
                                    name: customer.name + '_doc' + (i + 1) + '_' + Date.now() + '.' + file.name.split('.').pop(),
                                    mimeType: file.type,
                                    parents: [customer.documentFolders.nirc_fin]
                                };

                                const form = new FormData();
                                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                                form.append('file', file);

                                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name', {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': 'Bearer ' + gapi.client.getToken().access_token
                                    },
                                    body: form
                                });

                                if (response.ok) {
                                    const result = await response.json();
                                    customer.testDriveDocs[docKey].driveFileId = result.id;
                                    await saveData();
                                    console.log('Backed up to Google Drive:', result.id);
                                }
                            } catch (driveError) {
                                console.warn('Could not backup to Drive, but image saved locally:', driveError);
                            }
                        })(docKey, file, i);
                    }
                }

                // Complete progress
                if (progressBar && progressText) {
                    progressBar.style.width = '100%';
                    progressText.textContent = 'Saving...';
                }

                // Save customer data
                await saveData();

                // Complete!
                if (progressText) {
                    progressText.textContent = '‚úì Complete!';
                    setTimeout(() => {
                        if (progressContainer) {
                            progressContainer.style.display = 'none';
                        }
                    }, 1500);
                }

                // Refresh customer view
                displayCustomerDetails(customerId);

                // Clear file input
                const fileInput = document.getElementById('docImages_' + customerId);
                if (fileInput) {
                    fileInput.value = '';
                }

            } catch (error) {
                console.error('Error uploading document images:', error);
                alert('Failed to upload images: ' + error.message);

                // Hide progress bar on error
                if (progressContainer) {
                    progressContainer.style.display = 'none';
                }
            }
        }

        async function uploadDocImage(customerId, docType, file) {
            if (!file) return;

            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            try {
                // Convert image to base64 for local storage and printing
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64Data = e.target.result;

                    // Store in customer data as base64
                    if (!customer.testDriveDocs) {
                        customer.testDriveDocs = {};
                    }

                    customer.testDriveDocs[docType] = {
                        fileName: file.name,
                        base64: base64Data,
                        uploadDate: new Date().toISOString()
                    };

                    // Also upload to Google Drive if connected (for backup)
                    if (isSignedIn && customer.driveFolderId && customer.documentFolders?.nirc_fin) {
                        try {
                            const metadata = {
                                name: `${customer.name}_${docType}_${Date.now()}.${file.name.split('.').pop()}`,
                                mimeType: file.type,
                                parents: [customer.documentFolders.nirc_fin]
                            };

                            const form = new FormData();
                            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                            form.append('file', file);

                            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name', {
                                method: 'POST',
                                headers: {
                                    'Authorization': 'Bearer ' + gapi.client.getToken().access_token
                                },
                                body: form
                            });

                            if (response.ok) {
                                const result = await response.json();
                                customer.testDriveDocs[docType].driveFileId = result.id;
                                console.log('Also backed up to Google Drive:', result.id);
                            }
                        } catch (driveError) {
                            console.warn('Could not backup to Drive, but image saved locally:', driveError);
                        }
                    }

                    // Save customer data
                    await saveData();

                    // Refresh customer view
                    displayCustomerDetails(customerId);

                    alert(`${docType} uploaded successfully!`);
                };

                reader.onerror = function(error) {
                    console.error('Error reading file:', error);
                    alert('Failed to read image file');
                };

                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Error uploading document image:', error);
                alert('Failed to upload image: ' + error.message);
            }
        }

        // Render form with customer data overlaid
        async function renderFormWithData(formType, customer) {
            const formData = formTemplates[formType];

            if (!formData.fieldMappings || Object.keys(formData.fieldMappings).length === 0) {
                // No field mappings, return original from Drive
                return await getFormImageFromDrive(formType);
            }

            // Fetch form image from Drive
            const base64Data = await getFormImageFromDrive(formType);

            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');

                    // Draw form image
                    ctx.drawImage(img, 0, 0);

                    // Get customer data
                    const today = new Date().toLocaleDateString();
                    const dataMapping = {
                        'name': customer.name || '',
                        'phone': customer.phone || '',
                        'email': customer.email || '',
                        'nric': customer.nric || '',
                        'occupation': customer.occupation || '',
                        'dob': customer.dob || '',
                        'address': customer.address || '',
                        'addressContinue': customer.addressContinue || '',
                        'salesConsultant': customer.salesConsultant || '',
                        'vsaNo': customer.vsaNo || '',
                        'model': customer.model || '',
                        'date': today,
                        'vsa_makeModel': customer.vsaDetails?.makeModel || '',
                        'vsa_yom': customer.vsaDetails?.yom || '',
                        'vsa_bodyColour': customer.vsaDetails?.bodyColour || '',
                        'vsa_upholstery': customer.vsaDetails?.upholstery || '',
                        'vsa_przType': customer.vsaDetails?.przType || '',
                        'vsa_package': customer.vsaDetails?.package || '',
                        'vsa_purchasePriceWithCOE': customer.vsaDetails?.purchasePriceWithCOE || '',
                        'vsa_sellingWithCOE': customer.vsaDetails?.sellingWithCOE || '',
                        'vsa_sellingPriceList': customer.vsaDetails?.sellingPriceList || '',
                        'vsa_coeRebateLevel': customer.vsaDetails?.coeRebateLevel || '',
                        'vsa_deposit': customer.vsaDetails?.deposit || '',
                        'vsa_lessOthers': customer.vsaDetails?.lessOthers || '',
                        'vsa_addOthers': customer.vsaDetails?.addOthers || '',
                        'vsa_deliveryDate': customer.vsaDetails?.deliveryDate || '',
                        'vsa_tradeInCarNo': customer.vsaDetails?.tradeInCarNo || '',
                        'vsa_tradeInCarModel': customer.vsaDetails?.tradeInCarModel || '',
                        'vsa_tradeInAmount': customer.vsaDetails?.tradeInAmount || '',
                        'vsa_remarks1': customer.vsaDetails?.remarks1 || '',
                        'vsa_remarks2': customer.vsaDetails?.remarks2 || '',
                        'vsa_loanAmount': customer.vsaDetails?.loanAmount || '',
                        'vsa_interest': customer.vsaDetails?.interest || '',
                        'vsa_tenure': customer.vsaDetails?.tenure || '',
                        'vsa_monthlyPayment': customer.vsaDetails?.monthlyPayment || '',
                        'vsa_financeCompany': customer.vsaDetails?.financeCompany || '',
                        'vsa_insuranceCompany': customer.vsaDetails?.insuranceCompany || '',
                        'vsa_insuranceFee': customer.vsaDetails?.insuranceFee || ''
                    };

                    // Draw each field
                    for (const [fieldId, field] of Object.entries(formData.fieldMappings)) {
                        // Use custom value if provided, otherwise look up from customer data
                        let text;
                        if (field.customValue) {
                            text = field.customValue;
                        } else {
                            text = dataMapping[field.type] || '';
                        }

                        if (!text) continue;

                        ctx.fillStyle = field.color || '#000000';
                        ctx.font = field.fontSize + 'px Arial';
                        ctx.fillText(text, field.x, field.y);
                    }

                    // Convert to base64
                    const filledFormBase64 = canvas.toDataURL('image/jpeg', 0.95);
                    resolve(filledFormBase64);
                };

                img.onerror = function() {
                    reject(new Error('Failed to load form image'));
                };

                img.src = base64Data;
            });
        }

        // Print form for customer with attached documents
        async function printFormForCustomer(formType, customerId) {
            const customer = customers.find(c => c.id === customerId);
            const formData = formTemplates[formType];

            if (!formData) {
                alert('Form template not found. Please upload it first from Forms Management.');
                return;
            }

            // For test drive form, create 2-page document: Form + ID Documents
            if (formType === 'test_drive') {
                const docs = customer.testDriveDocs || {};

                // Render form with customer data
                let formImageData = null;
                if (formData.fileType === 'image') {
                    try {
                        formImageData = await renderFormWithData(formType, customer);
                    } catch (error) {
                        console.error('Error rendering form with data:', error);
                        // Fall back to original form
                    }
                }

                // Build HTML for 2-page print document
                let html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Test Drive Package - ' + customer.name + '</title>';
                html += '<style>';
                html += '@page { size: A4; margin: 0; }';
                html += '* { margin: 0; padding: 0; box-sizing: border-box; }';
                html += 'body { font-family: Arial, sans-serif; }';
                html += '.page { width: 210mm; height: 297mm; page-break-after: always; background: white; position: relative; }';
                html += '.page:last-child { page-break-after: auto; }';

                // Page 1: Form Page styles
                html += '.form-page { display: flex; align-items: center; justify-content: center; }';
                html += '.form-page iframe { width: 100%; height: 100%; border: none; }';

                // Page 2: ID Documents in 2x2 grid
                html += '.id-page { display: grid; grid-template-rows: 1fr 1fr; gap: 0; height: 100%; }';
                html += '.id-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0; }';
                html += '.id-box { display: flex; align-items: center; justify-content: center; overflow: hidden; background: #fafafa; }';
                html += '.id-box img { width: 100%; height: 100%; object-fit: contain; }';
                html += '.id-box .placeholder { color: #ccc; font-size: 18px; text-align: center; }';

                // Print button styles
                html += '.print-btn { position: fixed; top: 20px; right: 20px; padding: 14px 28px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 700; box-shadow: 0 6px 16px rgba(0,0,0,0.3); z-index: 1000; transition: all 0.3s; }';
                html += '.print-btn:hover { background: #229954; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.4); }';

                html += '@media print { .no-print { display: none !important; } body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }';
                html += '</style></head><body>';

                // Print button
                html += '<button class="print-btn no-print" onclick="window.print()">üñ®Ô∏è Print Both Pages</button>';

                // PAGE 1: Test Drive Form
                html += '<div class="page form-page">';
                if (formImageData) {
                    // Display image form (with or without data overlay)
                    html += '<img src="' + formImageData + '" style="width: 100%; height: 100%; object-fit: contain;" alt="Test Drive Form">';
                } else if (formData.webViewLink) {
                    // Display PDF in iframe
                    html += '<iframe src="' + formData.webViewLink + '"></iframe>';
                }
                html += '</div>';

                // PAGE 2: ID Documents Grid (2x2)
                html += '<div class="page">';
                html += '<div class="id-page">';

                // Top Row
                html += '<div class="id-row">';
                // Top Left (doc1)
                html += '<div class="id-box">';
                if (docs.doc1 && docs.doc1.base64) {
                    html += '<img src="' + docs.doc1.base64 + '" alt="Document 1">';
                } else {
                    html += '<div class="placeholder">No Image</div>';
                }
                html += '</div>';
                // Top Right (doc2)
                html += '<div class="id-box">';
                if (docs.doc2 && docs.doc2.base64) {
                    html += '<img src="' + docs.doc2.base64 + '" alt="Document 2">';
                } else {
                    html += '<div class="placeholder">No Image</div>';
                }
                html += '</div>';
                html += '</div>';

                // Bottom Row
                html += '<div class="id-row">';
                // Bottom Left (doc3)
                html += '<div class="id-box">';
                if (docs.doc3 && docs.doc3.base64) {
                    html += '<img src="' + docs.doc3.base64 + '" alt="Document 3">';
                } else {
                    html += '<div class="placeholder">No Image</div>';
                }
                html += '</div>';
                // Bottom Right (doc4)
                html += '<div class="id-box">';
                if (docs.doc4 && docs.doc4.base64) {
                    html += '<img src="' + docs.doc4.base64 + '" alt="Document 4">';
                } else {
                    html += '<div class="placeholder">No Image</div>';
                }
                html += '</div>';
                html += '</div>';

                html += '</div>'; // End id-page
                html += '</div>'; // End Page 2

                html += '</body></html>';

                // Open in new window
                const printWindow = window.open('', '_blank');
                printWindow.document.write(html);
                printWindow.document.close();
            } else {
                // For other forms, just open the PDF
                if (formData.webViewLink) {
                    window.open(formData.webViewLink, '_blank');
                } else {
                    alert('Form link not available');
                }
            }
        }

        // Handle form selection - show/hide test drive upload section
        function handleFormSelection(customerId) {
            const selectElement = document.getElementById(`formSelect_${customerId}`);
            const uploadSection = document.getElementById(`testDriveUpload_${customerId}`);
            const printButton = document.getElementById(`printFormBtn_${customerId}`);

            const selectedForm = selectElement.value;

            // Show upload section only for test_drive form
            if (selectedForm === 'test_drive') {
                uploadSection.style.display = 'block';
            } else {
                uploadSection.style.display = 'none';
            }

            // Enable print button if a form is selected
            if (selectedForm) {
                printButton.disabled = false;
                printButton.style.opacity = '1';
            } else {
                printButton.disabled = true;
                printButton.style.opacity = '0.5';
            }
        }

        // Print the selected form
        function printSelectedForm(customerId) {
            const selectElement = document.getElementById(`formSelect_${customerId}`);
            const selectedForm = selectElement.value;

            if (!selectedForm) {
                alert('Please select a form to print');
                return;
            }

            printFormForCustomer(selectedForm, customerId);
        }

        // Add customer
        // Prevent duplicate customer creation
        let isAddingCustomer = false;

        async function addCustomer(event) {
            event.preventDefault();

            // Prevent duplicate submissions
            if (isAddingCustomer) {
                console.log('Already adding customer, please wait...');
                return;
            }

            isAddingCustomer = true;

            // Get UI elements
            const submitBtn = document.getElementById('addCustomerSubmitBtn');
            const progressDiv = document.getElementById('addCustomerProgress');
            const progressText = document.getElementById('addCustomerProgressText');
            const progressBar = document.getElementById('addCustomerProgressBar');

            // Disable submit button and show progress
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';

            try {
                // Step 1: Create customer object
                progressText.textContent = 'Creating customer record...';
                progressBar.style.width = '25%';

                const customer = {
                    id: Date.now(),
                    name: document.getElementById('newCustomerName').value,
                    phone: document.getElementById('newCustomerPhone').value,
                    email: document.getElementById('newCustomerEmail').value,
                    nric: document.getElementById('newCustomerNRIC').value,
                    occupation: document.getElementById('newCustomerOccupation').value,
                    dob: document.getElementById('newCustomerDOB').value,
                    salesConsultant: document.getElementById('newCustomerSalesConsultant').value,
                    vsaNo: document.getElementById('newCustomerVsaNo').value,
                    address: document.getElementById('newCustomerAddress').value,
                    addressContinue: document.getElementById('newCustomerAddressContinue').value,
                    model: document.getElementById('newCustomerModel').value,
                    notes: document.getElementById('newCustomerNotes').value,
                    dateAdded: new Date().toISOString(),
                    checklist: {},
                    dealClosed: false,
                    driveFolderId: null,
                    driveFolderLink: null
                };

                customers.push(customer);

                // Step 2: Save to cloud
                progressText.textContent = 'Saving to cloud...';
                progressBar.style.width = '50%';
                await saveData();

                // Step 3: Create Google Drive folder
                if (isSignedIn) {
                    progressText.textContent = 'Creating Google Drive folder...';
                    progressBar.style.width = '75%';
                    await createCustomerFolder(customer.name, customer.id);
                }

                // Step 4: Complete
                progressText.textContent = 'Done! ‚úì';
                progressBar.style.width = '100%';

                // Wait a moment to show completion
                await new Promise(resolve => setTimeout(resolve, 500));

                renderCustomerList();
                closeAddCustomerModal();
                selectCustomer(customer.id);

            } catch (error) {
                console.error('Error adding customer:', error);
                alert('Error creating customer: ' + error.message);

                // Reset UI on error
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Customer';
                progressDiv.style.display = 'none';
            } finally {
                isAddingCustomer = false;
            }
        }

        // Render customer list
        function renderCustomerList() {
            const listContainer = document.getElementById('customerList');
            
            if (customers.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No customers yet</p>
                        <p style="font-size: 14px; margin-top: 10px;">Click "Add Customer" to get started</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = customers.map(customer => `
                <div class="customer-item ${selectedCustomerId === customer.id ? 'active' : ''}" onclick="selectCustomer(${customer.id})">
                    <h3>${customer.name} ${customer.driveFolderId ? 'üìÅ' : ''}</h3>
                    <p>üì± ${customer.phone} ${customer.model ? '| üöó ' + customer.model : ''}</p>
                    ${customer.dealClosed ? '<span class="stage-badge" style="background: #27ae60; margin-left: 5px;">‚úì Closed</span>' : ''}
                </div>
            `).join('');
        }

        // Select customer
        function selectCustomer(customerId) {
            selectedCustomerId = customerId;
            renderCustomerList();
            displayCustomerDetails(customerId);
        }

        // Display customer details
        async function displayCustomerDetails(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            // Create backup for cancel functionality
            customerBackup = JSON.parse(JSON.stringify(customer));

            const checklist = documentChecklist;
            const completedItems = Object.values(customer.checklist).filter(v => v).length;
            const totalItems = checklist.length;
            const progress = totalItems > 0 ? (completedItems / totalItems) * 100 : 0;

            // Get files from Drive
            const files = isSignedIn ? await getCustomerFiles(customerId) : [];

            const detailsContainer = document.getElementById('customerDetails');
            detailsContainer.innerHTML = `
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('info')">Customer Info</button>
                    <button class="tab" onclick="switchTab('documents')">Documents (${files.length})</button>
                </div>

                <div id="tab-info" class="tab-content active">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">Customer Details</h2>
                        <div id="editButtons">
                            <button class="btn btn-success" onclick="saveCustomerEdit(${customer.id})" style="background: #27ae60; margin-right: 10px;">
                                Save Changes
                            </button>
                            <button class="btn btn-secondary" onclick="cancelCustomerEdit(${customer.id})" style="background: #95a5a6;">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="customer_name" value="${customer.name}">
                        </div>
                        <div class="form-group">
                            <label>Contact Number</label>
                            <input type="tel" id="customer_phone" value="${customer.phone}">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="customer_email" value="${customer.email || ''}">
                        </div>
                        <div class="form-group">
                            <label>NRIC/FIN</label>
                            <input type="text" id="customer_nric" value="${customer.nric || ''}" placeholder="S1234567A or F1234567N">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Occupation</label>
                            <input type="text" id="customer_occupation" value="${customer.occupation || ''}" placeholder="e.g., Engineer, Teacher">
                        </div>
                        <div class="form-group">
                            <label>Date of Birth</label>
                            <input type="date" id="customer_dob" value="${customer.dob || ''}">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Sales Consultant</label>
                            <input type="text" id="customer_salesConsultant" value="${customer.salesConsultant || ''}">
                        </div>
                        <div class="form-group">
                            <label>VSA No</label>
                            <input type="text" id="customer_vsaNo" value="${customer.vsaNo || ''}" placeholder="VSA Number">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="customer_address" value="${customer.address || ''}" placeholder="e.g., 99 YISHUN AVE 1, 13-39">
                        </div>
                        <div class="form-group">
                            <label>Address Continue</label>
                            <input type="text" id="customer_addressContinue" value="${customer.addressContinue || ''}" placeholder="e.g., SINGAPORE 769139">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Interested Model</label>
                            <select id="customer_model">
                                <option value="">Select Model</option>
                                <option value="Seal" ${customer.model === 'Seal' ? 'selected' : ''}>Seal</option>
                                <option value="Seal 6" ${customer.model === 'Seal 6' ? 'selected' : ''}>Seal 6</option>
                                <option value="Sealion 6" ${customer.model === 'Sealion 6' ? 'selected' : ''}>Sealion 6</option>
                                <option value="Sealion 7" ${customer.model === 'Sealion 7' ? 'selected' : ''}>Sealion 7</option>
                                <option value="Dolphin" ${customer.model === 'Dolphin' ? 'selected' : ''}>Dolphin</option>
                                <option value="Atto 2" ${customer.model === 'Atto 2' ? 'selected' : ''}>Atto 2</option>
                                <option value="Atto 3" ${customer.model === 'Atto 3' ? 'selected' : ''}>Atto 3</option>
                                <option value="M6" ${customer.model === 'M6' ? 'selected' : ''}>M6</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="visibility: hidden;">VSA</label>
                            <button class="btn btn-primary" onclick="openVsaDetailsModal(${customer.id})" style="background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); width: 100%; height: 42px;">
                                üìã VSA Details
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea rows="3" id="customer_notes">${customer.notes || ''}</textarea>
                    </div>

                    ${Object.keys(formTemplates).length > 0 ? `
                        <div class="checklist-section" style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.1) 0%, rgba(192, 57, 43, 0.1) 100%); border: 2px solid rgba(231, 76, 60, 0.3);">
                            <h3 style="color: #e74c3c;">üìÑ Forms</h3>
                            <p style="margin-bottom: 15px; color: #7f8c8d; font-size: 13px;">
                                Select a form to print for ${customer.name}
                            </p>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">Select Form</label>
                                <select id="formSelect_${customer.id}" onchange="handleFormSelection(${customer.id})" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #e74c3c; border-radius: 6px; background: white;">
                                    <option value="">Choose a form...</option>
                                    ${(() => {
                                        const formTypeNames = {
                                            'test_drive': 'Test Drive Agreement',
                                            'vsa': 'Vehicle Sales Agreement',
                                            'pdpa': 'PDPA Consent Form',
                                            'coe_bidding_1': 'COE Bidding 1',
                                            'coe_bidding_2': 'COE Bidding 2',
                                            'pdpa_consent_1': 'PDPA Consent 1',
                                            'pdpa_consent_2': 'PDPA Consent 2',
                                            'other': 'Other Form'
                                        };
                                        return Object.keys(formTemplates).map(formType => {
                                            const formName = formTypeNames[formType] || formType;
                                            return '<option value="' + formType + '">' + formName + '</option>';
                                        }).join('');
                                    })()}
                                </select>
                            </div>

                            <div id="testDriveUpload_${customer.id}" style="display: none; background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid rgba(0, 188, 212, 0.2);">
                                <h4 style="color: #00bcd4; margin-bottom: 10px; font-size: 14px;">üì∏ Test Drive Required Documents</h4>
                                <p style="font-size: 12px; color: #7f8c8d; margin-bottom: 10px;">Upload up to 4 ID images to print with the form (they will appear in order on page 2)</p>

                                <div style="margin-bottom: 10px;">
                                    <input type="file" accept="image/*" multiple id="docImages_${customer.id}" onchange="uploadMultipleDocImages(${customer.id}, this.files)" style="font-size: 12px; padding: 8px; width: 100%; border: 2px dashed #00bcd4; border-radius: 6px; background: rgba(0, 188, 212, 0.05);">
                                    <p style="font-size: 11px; color: #7f8c8d; margin-top: 5px;">Select up to 4 images at once</p>
                                </div>

                                <div id="uploadProgress_${customer.id}" style="display: none; margin-bottom: 10px;">
                                    <div style="background: #ecf0f1; border-radius: 10px; height: 24px; overflow: hidden; position: relative;">
                                        <div id="uploadBar_${customer.id}" style="background: linear-gradient(90deg, #00bcd4 0%, #00acc1 100%); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center;">
                                            <span id="uploadText_${customer.id}" style="color: white; font-size: 12px; font-weight: 600; position: absolute; left: 50%; transform: translateX(-50%);"></span>
                                        </div>
                                    </div>
                                </div>

                                ${(() => {
                                    const docs = customer.testDriveDocs || {};
                                    const uploadedCount = Object.keys(docs).length;
                                    if (uploadedCount > 0) {
                                        return '<p style="font-size: 12px; color: #27ae60; font-weight: 600;">‚úì ' + uploadedCount + ' image(s) uploaded</p>';
                                    }
                                    return '';
                                })()}
                            </div>

                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                ${(() => {
                                    let html = '';
                                    // Add Combine & Print button at the top if there are multiple image forms
                                    const imageForms = Object.entries(formTemplates).filter(([_, formData]) => formData.fileType === 'image');
                                    if (imageForms.length >= 2) {
                                        html += '<button class="btn btn-primary" onclick="openCombinePrintModal(' + customer.id + ')" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); display: flex; align-items: center; gap: 8px; justify-content: center; width: 100%; font-weight: 600;"><span>üìë</span><span>Combine & Print (Double-Sided)</span></button>';
                                    }
                                    // Add single Print button
                                    html += '<button class="btn btn-primary" id="printFormBtn_' + customer.id + '" onclick="printSelectedForm(' + customer.id + ')" disabled style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); display: flex; align-items: center; gap: 8px; justify-content: center; width: 100%; opacity: 0.5;"><span>üìÑ</span><span>Print Form</span></button>';
                                    return html;
                                })()}
                            </div>
                        </div>
                    ` : ''}

                    ${Object.keys(excelTemplates).length > 0 ? `
                        <div style="margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(56, 142, 60, 0.1) 100%); border-radius: 10px; border: 2px solid rgba(76, 175, 80, 0.3);">
                            <h3 style="color: #4caf50; margin-bottom: 15px;">üìä Excel Templates</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
                                <button class="btn btn-success" onclick="openExcelPopulateModal(${customer.id})" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); display: flex; align-items: center; gap: 8px; justify-content: center; width: 100%;"><span>üìä</span><span>Populate Excel Template</span></button>
                            </div>
                        </div>
                    ` : ''}

                    <div class="action-buttons">
                        ${!customer.dealClosed ? `
                            <button class="btn btn-success" onclick="markDealClosed(${customer.id})">
                                ‚úì Mark Deal as Closed
                            </button>
                        ` : `
                            <button class="btn btn-secondary" onclick="markDealOpen(${customer.id})">
                                Reopen Deal
                            </button>
                        `}
                        ${!customer.driveFolderId && isSignedIn ? `
                            <button class="btn btn-drive" onclick="handleCreateFolderClick('${customer.name}', ${customer.id})">
                                üìÅ Create Drive Folder
                            </button>
                        ` : ''}
                        <button class="btn btn-danger" onclick="deleteCustomer(${customer.id})">
                            Delete Customer
                        </button>
                    </div>
                </div>

                <div id="tab-documents" class="tab-content">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h2 style="margin: 0;">Document Management</h2>
                        ${customer.driveFolderId ? `
                            <div style="display: flex; gap: 8px;">
                                <button onclick="window.open('${customer.driveFolderLink}', '_blank')"
                                        style="background: none; border: none; cursor: pointer; font-size: 24px; padding: 8px; border-radius: 8px; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;"
                                        onmouseover="this.style.background='rgba(0, 188, 212, 0.1)'"
                                        onmouseout="this.style.background='none'"
                                        title="Open folder in Google Drive (Web)">
                                    üåê
                                </button>
                                <button onclick="openLocalFolder('${customer.name}')"
                                        style="background: none; border: none; cursor: pointer; font-size: 24px; padding: 8px; border-radius: 8px; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;"
                                        onmouseover="this.style.background='rgba(52, 152, 219, 0.1)'"
                                        onmouseout="this.style.background='none'"
                                        title="Open folder in File Explorer">
                                    üìÇ
                                </button>
                            </div>
                        ` : ''}
                    </div>

                    ${!isSignedIn ? `
                        <div class="auth-section">
                            <h3>‚ö†Ô∏è Not Connected to Google Drive</h3>
                            <p>Connect to Google Drive to upload and manage files directly.</p>
                            <button class="btn btn-drive" onclick="handleAuthClick()">
                                üìÅ Connect Google Drive
                            </button>
                        </div>
                    ` : !customer.driveFolderId ? `
                        <div class="auth-section">
                            <h3>üìÅ Create Customer Folder</h3>
                            <p>Create a folder in Google Drive for ${customer.name}'s documents.</p>
                            <button class="btn btn-drive" onclick="handleCreateFolderClick('${customer.name}', ${customer.id})">
                                Create Folder
                            </button>
                        </div>
                    ` : `
                        <div class="file-naming">
                            <h4>üìÅ File Naming Convention</h4>
                            <p style="font-size: 13px; color: #856404; margin-bottom: 10px;">
                                Files will be automatically named as:
                            </p>
                            <code>${customer.name.replace(/\s+/g, '_')}_${customer.nric || 'XXXX'}_[Document_Type].[ext]</code>
                        </div>

                        <div class="file-upload-section">
                            <h3>
                                <img src="https://www.gstatic.com/images/branding/product/1x/drive_2020q4_48dp.png"
                                     style="width: 24px; height: 24px;">
                                Upload to Google Drive
                            </h3>

                            <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <div>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="autoClassifyToggle_${customerId}"
                                                   style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;"
                                                   onchange="toggleAutoClassify(${customerId})" checked>
                                            <div>
                                                <strong style="font-size: 16px;">ü§ñ Smart Auto-Classify</strong>
                                                <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;">
                                                    AI will detect document type, organize into folders, and tick checklists automatically
                                                </p>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group" id="manualFolderSelect_${customerId}" style="margin-bottom: 15px; display: none;">
                                <label for="documentTypeSelect_${customerId}">üìÇ Select Document Folder (Manual Mode)</label>
                                <select id="documentTypeSelect_${customerId}" style="width: 100%; padding: 10px; border: 1px solid #dfe6e9; border-radius: 8px; font-size: 14px; background: white;">
                                    ${documentFolders.map(folder => `
                                        <option value="${folder.id}">${folder.name.replace(/_/g, ' ')}</option>
                                    `).join('')}
                                </select>
                                <small style="color: #7f8c8d; font-size: 12px;">Files will be organized into the selected folder</small>
                            </div>

                            <div class="upload-area" id="uploadArea_${customerId}"
                                 ondrop="handleDrop(event, ${customerId})"
                                 ondragover="handleDragOver(event)"
                                 ondragleave="handleDragLeave(event)"
                                 onclick="document.getElementById('fileInput_${customerId}').click()">
                                <p>üóÇÔ∏è Drag & Drop Files Here</p>
                                <small>or click to browse/take photo ‚Ä¢ Files upload directly to Google Drive</small>
                                <input type="file" id="fileInput_${customerId}" multiple
                                       accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx,*"
                                       capture="environment"
                                       style="display: none;"
                                       onchange="handleFileSelect(event, ${customerId})">
                            </div>
                            <p style="font-size: 12px; color: #7f8c8d; margin-top: 10px;">
                                ‚úì Unlimited storage in Google Drive<br>
                                ‚úì Access from any device<br>
                                ‚úì Share with team members
                            </p>
                        </div>

                        <div class="file-list" id="fileList_${customerId}">
                            ${files.length > 0 ? files.map(file => `
                                <div class="file-item">
                                    <div class="file-info">
                                        <div class="file-icon">${getFileIcon(file.mimeType)}</div>
                                        <div class="file-details">
                                            <h4>${file.name}</h4>
                                            <p>${formatFileSize(file.size)} ‚Ä¢ ${new Date(file.createdTime).toLocaleDateString()}</p>
                                        </div>
                                    </div>
                                    <div class="file-actions">
                                        <button class="btn btn-secondary btn-small" onclick="window.open('${file.webViewLink}', '_blank')">
                                            üëÅÔ∏è View
                                        </button>
                                        <button class="btn btn-secondary btn-small" onclick="showMoveFileDialog('${file.id}', '${file.name}', ${customerId})">
                                            üìÅ Move
                                        </button>
                                        <button class="btn btn-danger btn-small" onclick="deleteFileConfirm('${file.id}', ${customerId}, '${file.name}')">
                                            üóëÔ∏è Delete
                                        </button>
                                    </div>
                                </div>
                            `).join('') : '<p style="text-align: center; color: #95a5a6; padding: 20px;">No documents uploaded yet</p>'}
                        </div>
                    `}
                </div>
            `;
        }

        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        // Open VSA Details modal
        function openVsaDetailsModal(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            // Initialize vsaDetails if it doesn't exist
            if (!customer.vsaDetails) {
                customer.vsaDetails = {
                    makeModel: '',
                    yom: '',
                    bodyColour: '',
                    upholstery: '',
                    przType: '',
                    package: '',
                    sellingWithCOE: '',
                    sellingPriceList: '',
                    purchasePriceWithCOE: '',
                    coeRebateLevel: '',
                    lessOthers: '',
                    deposit: '',
                    addOthers: '',
                    deliveryDate: '',
                    tradeInCarNo: '',
                    tradeInCarModel: '',
                    tradeInAmount: '',
                    remarks1: '',
                    remarks2: '',
                    loanAmount: '',
                    interest: '',
                    tenure: '',
                    monthlyPayment: '',
                    financeCompany: '',
                    insuranceCompany: '',
                    insuranceFee: ''
                };
            }

            // Populate form fields with existing data
            document.getElementById('vsa_makeModel').value = customer.vsaDetails.makeModel || '';
            document.getElementById('vsa_yom').value = customer.vsaDetails.yom || '';
            document.getElementById('vsa_bodyColour').value = customer.vsaDetails.bodyColour || '';
            document.getElementById('vsa_upholstery').value = customer.vsaDetails.upholstery || 'Standard';
            document.getElementById('vsa_przType').value = customer.vsaDetails.przType || '';
            document.getElementById('vsa_package').value = customer.vsaDetails.package || 'Excite';
            document.getElementById('vsa_sellingWithCOE').value = customer.vsaDetails.sellingWithCOE || 'WITH';
            document.getElementById('vsa_sellingPriceList').value = customer.vsaDetails.sellingPriceList || '';
            document.getElementById('vsa_purchasePriceWithCOE').value = customer.vsaDetails.purchasePriceWithCOE || '';
            document.getElementById('vsa_coeRebateLevel').value = customer.vsaDetails.coeRebateLevel || '';
            document.getElementById('vsa_lessOthers').value = customer.vsaDetails.lessOthers || '';
            document.getElementById('vsa_deposit').value = customer.vsaDetails.deposit || '';
            document.getElementById('vsa_addOthers').value = customer.vsaDetails.addOthers || '';
            document.getElementById('vsa_deliveryDate').value = customer.vsaDetails.deliveryDate || '';
            document.getElementById('vsa_tradeInCarNo').value = customer.vsaDetails.tradeInCarNo || '';
            document.getElementById('vsa_tradeInCarModel').value = customer.vsaDetails.tradeInCarModel || '';
            document.getElementById('vsa_tradeInAmount').value = customer.vsaDetails.tradeInAmount || '';
            document.getElementById('vsa_remarks1').value = customer.vsaDetails.remarks1 || '';
            document.getElementById('vsa_remarks2').value = customer.vsaDetails.remarks2 || '';
            document.getElementById('vsa_loanAmount').value = customer.vsaDetails.loanAmount || '';
            document.getElementById('vsa_interest').value = customer.vsaDetails.interest || '';
            document.getElementById('vsa_tenure').value = customer.vsaDetails.tenure || '';
            document.getElementById('vsa_monthlyPayment').value = customer.vsaDetails.monthlyPayment || '';
            document.getElementById('vsa_financeCompany').value = customer.vsaDetails.financeCompany || '';
            document.getElementById('vsa_insuranceCompany').value = customer.vsaDetails.insuranceCompany || '';
            document.getElementById('vsa_insuranceFee').value = customer.vsaDetails.insuranceFee || '';

            // Store customer ID for saving later
            window.currentVsaCustomerId = customerId;

            const modal = document.getElementById('vsaDetailsModal');
            modal.classList.add('active');

            // Reset to first tab
            switchVsaTab('newCarDetails');
        }

        // Save VSA Details
        function saveVsaDetails() {
            if (!window.currentVsaCustomerId) return;

            const customer = customers.find(c => c.id === window.currentVsaCustomerId);
            if (!customer) return;

            // Initialize vsaDetails if it doesn't exist
            if (!customer.vsaDetails) {
                customer.vsaDetails = {};
            }

            // Save all VSA form fields
            customer.vsaDetails.makeModel = document.getElementById('vsa_makeModel').value;
            customer.vsaDetails.yom = document.getElementById('vsa_yom').value;
            customer.vsaDetails.bodyColour = document.getElementById('vsa_bodyColour').value;
            customer.vsaDetails.upholstery = document.getElementById('vsa_upholstery').value;
            customer.vsaDetails.przType = document.getElementById('vsa_przType').value;
            customer.vsaDetails.package = document.getElementById('vsa_package').value;
            customer.vsaDetails.sellingWithCOE = document.getElementById('vsa_sellingWithCOE').value;
            customer.vsaDetails.sellingPriceList = document.getElementById('vsa_sellingPriceList').value;
            customer.vsaDetails.purchasePriceWithCOE = document.getElementById('vsa_purchasePriceWithCOE').value;
            customer.vsaDetails.coeRebateLevel = document.getElementById('vsa_coeRebateLevel').value;
            customer.vsaDetails.lessOthers = document.getElementById('vsa_lessOthers').value;
            customer.vsaDetails.deposit = document.getElementById('vsa_deposit').value;
            customer.vsaDetails.addOthers = document.getElementById('vsa_addOthers').value;
            customer.vsaDetails.deliveryDate = document.getElementById('vsa_deliveryDate').value;
            customer.vsaDetails.tradeInCarNo = document.getElementById('vsa_tradeInCarNo').value;
            customer.vsaDetails.tradeInCarModel = document.getElementById('vsa_tradeInCarModel').value;
            customer.vsaDetails.tradeInAmount = document.getElementById('vsa_tradeInAmount').value;
            customer.vsaDetails.remarks1 = document.getElementById('vsa_remarks1').value;
            customer.vsaDetails.remarks2 = document.getElementById('vsa_remarks2').value;
            customer.vsaDetails.loanAmount = document.getElementById('vsa_loanAmount').value;
            customer.vsaDetails.interest = document.getElementById('vsa_interest').value;
            customer.vsaDetails.tenure = document.getElementById('vsa_tenure').value;
            customer.vsaDetails.monthlyPayment = document.getElementById('vsa_monthlyPayment').value;
            customer.vsaDetails.financeCompany = document.getElementById('vsa_financeCompany').value;
            customer.vsaDetails.insuranceCompany = document.getElementById('vsa_insuranceCompany').value;
            customer.vsaDetails.insuranceFee = document.getElementById('vsa_insuranceFee').value;

            // Save to storage
            saveData();

            // Close modal
            closeVsaDetailsModal();
        }

        // Close VSA Details modal
        function closeVsaDetailsModal() {
            document.getElementById('vsaDetailsModal').classList.remove('active');
            window.currentVsaCustomerId = null;
        }

        // Switch VSA Details tabs
        function switchVsaTab(tabName) {
            // Remove active class from all tabs within the VSA modal
            const vsaModal = document.getElementById('vsaDetailsModal');
            vsaModal.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            vsaModal.querySelectorAll('.tab-content').forEach(c => {
                c.classList.remove('active');
                c.style.display = 'none';
            });

            // Add active class to clicked tab
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // If no event (called programmatically), find and activate the tab
                vsaModal.querySelectorAll('.tab').forEach(t => {
                    if (t.getAttribute('onclick').includes(tabName)) {
                        t.classList.add('active');
                    }
                });
            }

            // Show selected tab content
            const tabContent = document.getElementById('vsa-tab-' + tabName);
            if (tabContent) {
                tabContent.classList.add('active');
                tabContent.style.display = 'block';
            }
        }

        // Handle file drop
        function handleDrop(event, customerId) {
            event.preventDefault();
            event.stopPropagation();
            event.target.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            uploadFiles(files, customerId);
        }

        // Toggle auto-classify mode
        function toggleAutoClassify(customerId) {
            const toggle = document.getElementById(`autoClassifyToggle_${customerId}`);
            const manualSelect = document.getElementById(`manualFolderSelect_${customerId}`);

            if (toggle && manualSelect) {
                if (toggle.checked) {
                    manualSelect.style.display = 'none';
                } else {
                    manualSelect.style.display = 'block';
                }
            }
        }

        // Handle drag over
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.target.classList.add('dragover');
        }

        // Handle drag leave
        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            event.target.classList.remove('dragover');
        }

        // Handle file select
        function handleFileSelect(event, customerId) {
            const files = event.target.files;
            uploadFiles(files, customerId);
        }

        // Upload files
        async function uploadFiles(files, customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            if (!isSignedIn) {
                alert('Please connect to Google Drive first');
                return;
            }

            // Check if auto-classify is enabled
            const autoClassifyToggle = document.getElementById(`autoClassifyToggle_${customerId}`);
            const isAutoClassify = autoClassifyToggle ? autoClassifyToggle.checked : true;

            const uploadArea = document.getElementById(`uploadArea_${customerId}`);
            const originalContent = uploadArea.innerHTML;

            let successCount = 0;
            let errorCount = 0;
            const classificationResults = [];

            if (isAutoClassify) {
                // Auto-classify mode with parallel uploads
                uploadArea.innerHTML = '<div class="loading"></div><p style="color: #27ae60; margin-top: 10px;">ü§ñ Auto-classifying and uploading files...</p>';

                // Prepare all upload tasks
                const uploadTasks = Array.from(files).map(file => {
                    const fileExt = file.name.split('.').pop();
                    const classification = classifyDocument(file.name);
                    const documentType = classification.folderId;
                    const displayName = classification.displayName;
                    const fileName = `${customer.name.replace(/\s+/g, '_')}_${customer.nric || 'XXXX'}_${displayName.replace(/\s+/g, '_')}.${fileExt}`;

                    return {
                        file,
                        fileName,
                        documentType,
                        classification
                    };
                });

                // Upload with concurrency limit (3 files at a time to avoid overwhelming API)
                const concurrencyLimit = 3;
                for (let i = 0; i < uploadTasks.length; i += concurrencyLimit) {
                    const batch = uploadTasks.slice(i, i + concurrencyLimit);
                    const batchPromises = batch.map(async (task) => {
                        const result = await uploadFileToDrive(task.file, customerId, task.fileName, task.documentType);
                        return {
                            success: result,
                            task
                        };
                    });

                    const batchResults = await Promise.allSettled(batchPromises);

                    batchResults.forEach(result => {
                        if (result.status === 'fulfilled' && result.value.success) {
                            successCount++;
                            classificationResults.push({
                                originalName: result.value.task.file.name,
                                detectedType: result.value.task.classification.displayName,
                                checklistId: result.value.task.classification.checklistId,
                                confidence: result.value.task.classification.confidence
                            });

                            // Auto-tick checklist if applicable
                            if (result.value.task.classification.checklistId) {
                                toggleChecklistItem(customerId, result.value.task.classification.checklistId, true);
                            }
                        } else {
                            errorCount++;
                        }
                    });
                }

                // Show detailed results
                let resultMessage = `‚úÖ Successfully uploaded ${successCount} file(s)!\n\nüìã Auto-classified documents:\n`;
                classificationResults.forEach(result => {
                    resultMessage += `\n‚Ä¢ ${result.originalName}\n  ‚Üí ${result.detectedType}`;
                    if (result.checklistId) {
                        resultMessage += ` ‚úì (checklist updated)`;
                    }
                });
                if (errorCount > 0) {
                    resultMessage += `\n\n‚ùå Failed to upload ${errorCount} file(s).`;
                }
                alert(resultMessage);

            } else {
                // Manual mode with parallel uploads
                const documentTypeSelect = document.getElementById(`documentTypeSelect_${customerId}`);
                const documentType = documentTypeSelect ? documentTypeSelect.value : 'other';
                const folderName = documentFolders.find(f => f.id === documentType)?.name || 'Other_Documents';

                uploadArea.innerHTML = '<div class="loading"></div><p style="color: #27ae60; margin-top: 10px;">Uploading files to ' + folderName.replace(/_/g, ' ') + '...</p>';

                // Prepare all upload tasks
                const uploadTasks = Array.from(files).map(file => {
                    const fileExt = file.name.split('.').pop();
                    const docType = folderName.replace(/_/g, ' '); // Use folder name for all files in manual mode
                    const fileName = `${customer.name.replace(/\s+/g, '_')}_${customer.nric || 'XXXX'}_${docType.replace(/\s+/g, '_')}.${fileExt}`;

                    return {
                        file,
                        fileName,
                        documentType
                    };
                });

                // Upload with concurrency limit (3 files at a time)
                const concurrencyLimit = 3;
                for (let i = 0; i < uploadTasks.length; i += concurrencyLimit) {
                    const batch = uploadTasks.slice(i, i + concurrencyLimit);
                    const batchPromises = batch.map(task =>
                        uploadFileToDrive(task.file, customerId, task.fileName, task.documentType)
                    );

                    const batchResults = await Promise.allSettled(batchPromises);

                    batchResults.forEach(result => {
                        if (result.status === 'fulfilled' && result.value) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    });
                }

                if (successCount > 0) {
                    alert(`Successfully uploaded ${successCount} file(s) to ${folderName.replace(/_/g, ' ')} folder!`);
                }
                if (errorCount > 0) {
                    alert(`Failed to upload ${errorCount} file(s).`);
                }
            }

            uploadArea.innerHTML = originalContent;
            invalidateStatsCache(); // Invalidate cache after upload
            displayCustomerDetails(customerId);
            updateStats();
        }

        // Delete file confirm
        async function deleteFileConfirm(fileId, customerId, fileName) {
            if (confirm(`Delete "${fileName}" from Google Drive?`)) {
                const success = await deleteFileFromDrive(fileId);
                if (success) {
                    alert('File deleted successfully');
                    invalidateStatsCache(); // Invalidate cache after deletion
                    displayCustomerDetails(customerId);
                    updateStats();
                } else {
                    alert('Error deleting file');
                }
            }
        }

        // Show move file dialog
        function showMoveFileDialog(fileId, fileName, customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer || !customer.documentFolders) {
                alert('Customer folders not found. Please create folder first.');
                return;
            }

            // Extract file extension
            const lastDotIndex = fileName.lastIndexOf('.');
            const fileExtension = lastDotIndex > -1 ? fileName.substring(lastDotIndex) : '';
            const fileNameWithoutExt = lastDotIndex > -1 ? fileName.substring(0, lastDotIndex) : fileName;

            // Build folder options
            let optionsHTML = '<option value="">Select a folder</option>';
            for (const folder of documentFolders) {
                const folderName = folder.name.replace(/_/g, ' ');
                optionsHTML += `<option value="${folder.id}">${folderName}</option>`;
            }

            // Escape filename for HTML attributes
            const escapedFileName = fileName.replace(/'/g, "\\'").replace(/"/g, '&quot;');

            // Create custom dialog HTML
            const dialogHTML = `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">Move & Rename Document</h3>

                    <label style="display: block; margin-bottom: 8px; color: #2d3748; font-weight: 500;">
                        Document name:
                    </label>
                    <input type="text" id="moveFileNameInput" value="${fileNameWithoutExt}"
                           style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px; margin-bottom: 5px;">
                    <p style="margin: 0 0 15px 0; color: #7f8c8d; font-size: 12px;">
                        File extension: <strong>${fileExtension || 'none'}</strong>
                    </p>

                    <label style="display: block; margin-bottom: 8px; color: #2d3748; font-weight: 500;">
                        Move to folder:
                    </label>
                    <select id="moveToFolderSelect" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px; margin-bottom: 20px;">
                        ${optionsHTML}
                    </select>

                    <div style="display: flex; gap: 10px;">
                        <button onclick="executeMoveFile('${fileId}', ${customerId}, '${escapedFileName}', '${fileExtension}')" class="btn btn-primary" style="flex: 1;">
                            Move & Rename
                        </button>
                        <button onclick="closeMoveDialog()" class="btn btn-secondary" style="flex: 1;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;

            // Show dialog using a simple modal approach
            const existingDialog = document.getElementById('moveFileDialog');
            if (existingDialog) {
                existingDialog.remove();
            }

            const dialog = document.createElement('div');
            dialog.id = 'moveFileDialog';
            dialog.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            dialog.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    ${dialogHTML}
                </div>
            `;

            document.body.appendChild(dialog);

            // Focus the name input
            setTimeout(() => {
                const nameInput = document.getElementById('moveFileNameInput');
                if (nameInput) {
                    nameInput.focus();
                    nameInput.select();
                }
            }, 100);
        }

        // Close move dialog
        function closeMoveDialog() {
            const dialog = document.getElementById('moveFileDialog');
            if (dialog) {
                dialog.remove();
            }
        }

        // Execute move file
        async function executeMoveFile(fileId, customerId, oldFileName, fileExtension) {
            const select = document.getElementById('moveToFolderSelect');
            const nameInput = document.getElementById('moveFileNameInput');
            const targetFolderId = select.value;

            if (!targetFolderId) {
                alert('Please select a destination folder');
                return;
            }

            // Get new filename from input
            let newFileNameWithoutExt = nameInput.value.trim();
            if (!newFileNameWithoutExt) {
                alert('Please enter a document name');
                return;
            }

            // Add extension back
            const newFileName = newFileNameWithoutExt + fileExtension;

            const customer = customers.find(c => c.id === customerId);
            if (!customer || !customer.documentFolders || !customer.documentFolders[targetFolderId]) {
                alert('Destination folder not found');
                return;
            }

            const targetDriveFolderId = customer.documentFolders[targetFolderId];

            // Close dialog and show progress
            closeMoveDialog();

            const success = await moveFileToFolder(fileId, targetDriveFolderId, newFileName);

            if (success) {
                const folderName = documentFolders.find(f => f.id === targetFolderId)?.name.replace(/_/g, ' ') || 'selected folder';
                alert(`‚úÖ "${newFileName}" moved to ${folderName} successfully!`);
                invalidateStatsCache(); // Invalidate cache to ensure fresh data
                displayCustomerDetails(customerId);
            } else {
                alert('‚ùå Error moving file. Please try again.');
            }
        }

        // Move file to folder in Google Drive (and optionally rename)
        async function moveFileToFolder(fileId, newParentId, newFileName) {
            if (!isSignedIn) {
                alert('Please connect to Google Drive first');
                return false;
            }

            try {
                // First, get the current file to find its current parents
                const getResponse = await gapi.client.drive.files.get({
                    fileId: fileId,
                    fields: 'parents, name'
                });

                const previousParents = getResponse.result.parents ? getResponse.result.parents.join(',') : '';
                const currentFileName = getResponse.result.name;

                // Prepare update parameters
                const updateParams = {
                    fileId: fileId,
                    addParents: newParentId,
                    removeParents: previousParents,
                    fields: 'id, parents, name'
                };

                // If filename changed, add rename to the update
                if (newFileName && newFileName !== currentFileName) {
                    updateParams.resource = {
                        name: newFileName
                    };
                    console.log(`Renaming file from "${currentFileName}" to "${newFileName}"`);
                }

                // Update file to remove from old parent, add to new parent, and optionally rename
                const updateResponse = await gapi.client.drive.files.update(updateParams);

                console.log('File moved successfully:', updateResponse.result);
                return true;
            } catch (error) {
                console.error('Error moving file:', error);
                return false;
            }
        }

        // Update customer
        function updateCustomer(customerId, field, value) {
            const customer = customers.find(c => c.id === customerId);
            if (customer) {
                customer[field] = value;
                saveData();
                renderCustomerList();
                displayCustomerDetails(customerId);
            }
        }

        // Save customer edits
        function saveCustomerEdit(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (customer) {
                // Get values from form fields
                customer.name = document.getElementById('customer_name').value;
                customer.phone = document.getElementById('customer_phone').value;
                customer.email = document.getElementById('customer_email').value;
                customer.nric = document.getElementById('customer_nric').value;
                customer.occupation = document.getElementById('customer_occupation').value;
                customer.dob = document.getElementById('customer_dob').value;
                customer.salesConsultant = document.getElementById('customer_salesConsultant').value;
                customer.vsaNo = document.getElementById('customer_vsaNo').value;
                customer.address = document.getElementById('customer_address').value;
                customer.addressContinue = document.getElementById('customer_addressContinue').value;
                customer.model = document.getElementById('customer_model').value;
                customer.notes = document.getElementById('customer_notes').value;

                // Save changes
                saveData();
                renderCustomerList();
                displayCustomerDetails(customerId);
            }
        }

        // Cancel customer edits
        function cancelCustomerEdit(customerId) {
            if (customerBackup) {
                // Restore customer data from backup
                const customer = customers.find(c => c.id === customerId);
                if (customer) {
                    Object.assign(customer, customerBackup);
                }
            }
            displayCustomerDetails(customerId);
        }

        // Toggle checklist item
        function toggleChecklistItem(customerId, itemId, setValue = null) {
            const customer = customers.find(c => c.id === customerId);
            if (customer) {
                // If setValue is provided, use it; otherwise toggle
                if (setValue !== null) {
                    customer.checklist[itemId] = setValue;
                } else {
                    customer.checklist[itemId] = !customer.checklist[itemId];
                }
                saveData();
                displayCustomerDetails(customerId);
            }
        }

        // Mark deal closed
        function markDealClosed(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (customer && confirm(`Mark deal as closed for ${customer.name}?`)) {
                customer.dealClosed = true;
                customer.closedDate = new Date().toISOString();
                saveData();
                renderCustomerList();
                displayCustomerDetails(customerId);
            }
        }

        // Mark deal open
        function markDealOpen(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (customer) {
                customer.dealClosed = false;
                customer.closedDate = null;
                saveData();
                renderCustomerList();
                displayCustomerDetails(customerId);
            }
        }

        // Delete customer
        async function deleteCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            const confirmMsg = customer.driveFolderId 
                ? `Delete ${customer.name}? The Google Drive folder will remain, but you can manually delete it later.`
                : `Delete ${customer.name}? This cannot be undone.`;

            if (confirm(confirmMsg)) {
                customers = customers.filter(c => c.id !== customerId);
                saveData();
                renderCustomerList();
                document.getElementById('customerDetails').innerHTML = `
                    <div class="empty-state">
                        <p>Select a customer to view details</p>
                    </div>
                `;
                updateStats();
            }
        }

        // Search customers
        function searchCustomers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const listContainer = document.getElementById('customerList');
            
            const filteredCustomers = customers.filter(c => 
                c.name.toLowerCase().includes(searchTerm) ||
                c.phone.includes(searchTerm) ||
                (c.model && c.model.toLowerCase().includes(searchTerm)) ||
                (c.email && c.email.toLowerCase().includes(searchTerm))
            );

            if (filteredCustomers.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No customers found</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = filteredCustomers.map(customer => `
                <div class="customer-item ${selectedCustomerId === customer.id ? 'active' : ''}" onclick="selectCustomer(${customer.id})">
                    <h3>${customer.name} ${customer.driveFolderId ? 'üìÅ' : ''}</h3>
                    <p>üì± ${customer.phone} ${customer.model ? '| üöó ' + customer.model : ''}</p>
                    ${customer.dealClosed ? '<span class="stage-badge" style="background: #27ae60; margin-left: 5px;">‚úì Closed</span>' : ''}
                </div>
            `).join('');
        }

        // Export data
        function exportData() {
            const dataStr = JSON.stringify(customers, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `BYD_CRM_Export_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            alert('Customer data exported! Files remain in Google Drive.');
        }

        // Import data
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (confirm(`Import ${importedData.length} customers? This will replace current data.`)) {
                            customers = importedData;
                            saveData();
                            renderCustomerList();
                            alert('Data imported successfully!');
                        }
                    } catch (error) {
                        alert('Error importing data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Initialize
        function init() {
            // Set initial sync status
            updateSyncStatus('offline');

            // Load form templates from localStorage
            loadFormTemplates();

            // Load Excel templates from localStorage
            loadExcelTemplates();

            // Don't load from localStorage yet - wait for Drive connection
            // This ensures Drive is the source of truth
            console.log('Waiting for Google Drive connection...');

            // Initialize both GAPI and GIS
            gapiLoaded();
            gisLoaded();

            // Show empty state until Drive loads
            renderCustomerList();
            updateStats();
        }

        // Start when page loads
        window.onload = init;
    </script>
</body>
</html>
